<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ENEDES - Gest√£o Completa com Follow-up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js" onload="console.log('Lucide carregado')" onerror="console.warn('Lucide n√£o dispon√≠vel - usando fallback')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" onload="console.log('Chart.js carregado')" onerror="console.warn('Chart.js n√£o dispon√≠vel - usando fallback')"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .followup-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #3b82f6;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-green { background-color: #10b981; }
        .status-blue { background-color: #3b82f6; }
        .status-gray { background-color: #6b7280; }
        .status-red { background-color: #ef4444; }
        .status-yellow { background-color: #f59e0b; }
        
        .farol-verde { background-color: #10b981; }
        .farol-amarelo { background-color: #f59e0b; }
        .farol-vermelho { background-color: #ef4444; }
        .farol-gray { background-color: #6b7280; }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold gradient-bg bg-clip-text text-transparent">ENEDES</h1>
                <p class="text-gray-600 mt-2">Gest√£o Completa de Projetos</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                    <select id="userSelect" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Escolha um usu√°rio...</option>
                        <option value="coord_geral">Coordena√ß√£o Geral</option>
                        <option value="coord_projeto_area1">Coordenador de Projeto - √Årea 1</option>
                        <option value="coord_projeto_area2">Coordenador de Projeto - √Årea 2</option>
                        <option value="ifb_mais_empreendedor">IFB Mais Empreendedor</option>
                        <option value="rota_empreendedora">Rota Empreendedora</option>
                        <option value="lab_varejo">Lab Varejo</option>
                        <option value="lab_consumer">Lab Consumer</option>
                        <option value="estudio">Est√∫dio</option>
                        <option value="ifb_digital">IFB Digital</option>
                        <option value="sala_interativa">Sala Interativa</option>
                        <option value="agencia_marketing">Ag√™ncia de Marketing</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                    <input type="password" id="passwordInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Digite: 123456">
                </div>
                <button onclick="login()" class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                    ENTRAR
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-teal-600">ENEDES</h1>
                        <span class="text-gray-500">Gest√£o Completa de Projetos</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showTechnicalStatus()" class="relative p-2 text-gray-600 hover:text-gray-900" title="Status do sistema e conectividade">
                            <span data-lucide="bell">üîî</span>
                            <span class="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">‚óè</span>
                        </button>
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <div id="userName" class="text-sm font-medium text-gray-900"></div>
                                <div id="userRole" class="text-xs text-gray-500"></div>
                            </div>
                            <button onclick="logout()" class="p-2 text-gray-600 hover:text-gray-900">
                                <span data-lucide="log-out">üö™</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('dashboard')" class="py-4 px-1 border-b-2 border-teal-500 text-teal-600 font-medium text-sm" id="tab-dashboard">
                        <span data-lucide="home">üè†</span> Dashboard
                    </button>
                    <button onclick="showTab('metas')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-metas">
                        <span data-lucide="target">üéØ</span> Metas
                        <span class="ml-1 bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full" id="metas-count">0</span>
                    </button>
                    <button onclick="showTab('programas')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-programas">
                        <span data-lucide="layers">üìö</span> Programas
                        <span class="ml-1 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">8</span>
                    </button>
                    <div id="meuProgramaTab" class="hidden">
                        <button onclick="showTab('meu-programa')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-meu-programa">
                            <span data-lucide="briefcase">üíº</span> <span id="meuProgramaTabTitle">Meu Programa</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content">
                <!-- Quick Actions -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Vis√£o Geral</h2>
                        <div class="flex space-x-2">
                            <button onclick="showMetaForm()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <span data-lucide="target">üéØ</span> Nova Meta
                            </button>
                            <button onclick="showActionForm()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <span data-lucide="plus">+</span> Nova A√ß√£o
                            </button>
                            <button onclick="showFollowUpForm()" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                <span data-lucide="send">üì§</span> Follow-up
                            </button>
                            <button onclick="exportData()" class="text-orange-600 hover:text-orange-800 text-sm font-medium">
                                <span data-lucide="download">‚¨áÔ∏è</span> Exportar
                            </button>
                            <button onclick="showTechnicalStatus()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                <span data-lucide="activity">üìä</span> Status
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total de Programas</p>
                                    <p id="totalProgramas" class="text-2xl font-bold text-gray-900">8</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <span data-lucide="layers" style="font-size: 24px;">üìö</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">A√ß√µes Ativas</p>
                                    <p id="acoesAtivas" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <span data-lucide="activity" style="font-size: 24px;">üìä</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Follow-ups Ativos</p>
                                    <p id="followupsAtivos" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <span data-lucide="send" style="font-size: 24px;">üì§</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Tarefas Pendentes</p>
                                    <p id="tarefasPendentes" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <span data-lucide="clock" style="font-size: 24px;">‚è∞</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Status das A√ß√µes por Programa</h3>
                            <div class="chart-container">
                                <canvas id="acoesPorProgramaChart"></canvas>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Follow-ups por Status</h3>
                            <div class="chart-container">
                                <canvas id="followupStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Farol de Acompanhamento -->
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Farol de Acompanhamento por Programa</h3>
                        <div id="farolAcompanhamento" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Far√≥is ser√£o inseridos aqui dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Cards -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">A√ß√µes R√°pidas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <button onclick="showMetaForm()" class="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 transition-colors text-left">
                            <div data-lucide="target" style="font-size: 24px; margin-bottom: 8px;">üéØ</div>
                            <h4 class="font-medium text-purple-900">Nova Meta</h4>
                            <p class="text-sm text-purple-700">Cadastrar nova meta estrat√©gica</p>
                        </button>

                        <button onclick="showActionForm()" class="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-left">
                            <div data-lucide="plus" style="font-size: 24px; margin-bottom: 8px;">+</div>
                            <h4 class="font-medium text-blue-900">Nova A√ß√£o</h4>
                            <p class="text-sm text-blue-700">Adicionar nova a√ß√£o ao projeto</p>
                        </button>

                        <button onclick="showFollowUpForm()" class="p-4 bg-green-50 border-2 border-green-200 rounded-lg hover:bg-green-100 transition-colors text-left">
                            <div data-lucide="send" style="font-size: 24px; margin-bottom: 8px;">üì§</div>
                            <h4 class="font-medium text-green-900">Follow-up</h4>
                            <p class="text-sm text-green-700">Enviar follow-up para colaboradores</p>
                        </button>

                        <button onclick="exportData()" class="p-4 bg-orange-50 border-2 border-orange-200 rounded-lg hover:bg-orange-100 transition-colors text-left">
                            <div data-lucide="download" style="font-size: 24px; margin-bottom: 8px;">‚¨áÔ∏è</div>
                            <h4 class="font-medium text-orange-900">Exportar</h4>
                            <p class="text-sm text-orange-700">Exportar dados do sistema</p>
                        </button>

                        <button onclick="showTechnicalStatus()" class="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors text-left">
                            <div data-lucide="activity" style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                            <h4 class="font-medium text-indigo-900">Status Sistema</h4>
                            <p class="text-sm text-indigo-700">Ver conectividade e endpoints</p>
                        </button>
                    </div>
                </div>

                <!-- Dashboard de Follow-ups -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Dashboard de Follow-ups</h3>
                        <div class="flex space-x-2">
                            <button onclick="filterFollowUps('all')" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white" id="filter-all">
                                Todos
                                <span class="ml-1 bg-blue-600 text-white text-xs px-2 py-1 rounded-full" id="count-all">0</span>
                            </button>
                            <button onclick="filterFollowUps('pending')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-pending">
                                Pendentes
                                <span class="ml-1 bg-yellow-200 text-yellow-700 text-xs px-2 py-1 rounded-full" id="count-pending">0</span>
                            </button>
                            <button onclick="filterFollowUps('in_progress')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-in_progress">
                                Em Andamento
                                <span class="ml-1 bg-blue-200 text-blue-700 text-xs px-2 py-1 rounded-full" id="count-in_progress">0</span>
                            </button>
                            <button onclick="filterFollowUps('completed')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-completed">
                                Conclu√≠dos
                                <span class="ml-1 bg-green-200 text-green-700 text-xs px-2 py-1 rounded-full" id="count-completed">0</span>
                            </button>
                        </div>
                    </div>
                    <div id="followUpsList" class="space-y-4">
                        <div class="flex items-center justify-center py-12 text-gray-500">
                            <div class="text-center">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                                <p>Carregando follow-ups...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metas Tab -->
            <div id="metas-content" class="tab-content hidden">
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="flex border-b">
                        <button onclick="showMetasSubTab('estrategicas')" class="px-4 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600" id="metas-tab-estrategicas">
                            <i data-lucide="target" class="w-4 h-4 inline mr-2"></i>
                            Metas Estrat√©gicas
                        </button>
                        <button onclick="showMetasSubTab('cronograma')" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900" id="metas-tab-cronograma">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>
                            Cronograma
                        </button>
                    </div>
                    
                    <!-- Metas Estrat√©gicas -->
                    <div id="metas-estrategicas-content" class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Metas Estrat√©gicas</h4>
                            <button onclick="showMetaForm()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Cadastrar Nova Meta
                            </button>
                        </div>
                        <div id="metasList" class="space-y-3">
                            <div class="text-center py-8">
                                <span class="loading mx-auto mb-4"></span>
                                <p class="text-gray-500 text-sm">Carregando metas...</p>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h5 class="font-medium text-gray-900 mb-4">Follow-ups de Metas</h5>
                            <div id="metasFollowUps" class="space-y-3">
                                <div class="text-center py-8">
                                    <span class="loading mx-auto mb-4"></span>
                                    <p class="text-gray-500 text-sm">Carregando follow-ups...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cronograma -->
                    <div id="metas-cronograma-content" class="p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Cronograma de Execu√ß√£o</h4>
                            <button onclick="showCronogramaForm()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Nova Etapa
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa/Programa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">In√≠cio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prazo Final</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rubrica (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Executado (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saldo (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status (%)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="cronogramaTable" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            <span class="loading mx-auto mb-4"></span>
                                            <p>Carregando cronograma...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Programas Tab -->
            <div id="programas-content" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">Programas do Projeto</h2>
                    <p class="text-gray-600">Gerencie todos os programas e suas a√ß√µes, follow-ups e invent√°rios</p>
                </div>
                <div id="programsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Programs will be loaded here -->
                </div>
            </div>

            <!-- Meu Programa Tab -->
            <div id="meu-programa-content" class="tab-content hidden">
                <div class="mb-6">
                    <h2 id="meuProgramaTitle" class="text-xl font-semibold text-gray-900 mb-2">Meu Programa</h2>
                    <p class="text-gray-600">Gerencie as a√ß√µes, follow-ups e invent√°rio do seu programa</p>
                </div>
                <div id="meuProgramaContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast bg-white border border-gray-200 rounded-lg shadow-lg p-4 flex items-center space-x-3">
        <div id="toastIcon"></div>
        <span id="toastMessage" class="text-gray-900"></span>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
            <span data-lucide="x">‚úñÔ∏è</span>
        </button>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        // ========================================
        // CONFIGURA√á√ÉO DO BACKEND
        // ========================================
        
        // üîß CONFIGURA√á√ÉO: Altere para usar seu backend ou deixe vazio para modo offline
        // Exemplos:
        // - Backend ativo: 'https://sistem-lk86.onrender.com'
        // - Modo offline: '' (string vazia)
        const API_BASE_URL = 'https://sistem-lk86.onrender.com'; // ‚úÖ CORRIGIDO: URL do backend configurada
        
        // Sistema h√≠brido: Backend + LocalStorage fallback
        let OFFLINE_MODE = !API_BASE_URL; // true = offline, false = backend
        
        // ========================================
        // CLASSE DE INTEGRA√á√ÉO H√çBRIDA (BACKEND + OFFLINE)
        // ========================================
        class APIService {
            // Testar se backend est√° dispon√≠vel
            static async testBackendConnection() {
                if (!API_BASE_URL) return false;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api.php?endpoint=test`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    return response.ok;
                } catch (error) {
                    console.warn('Backend n√£o dispon√≠vel, usando modo offline');
                    return false;
                }
            }

            // Lista de endpoints dispon√≠veis no backend (conforme logs)
            static getAvailableEndpoints() {
                return ['goals', 'test']; // Apenas endpoints que retornam 200
            }

            // Verificar se endpoint est√° dispon√≠vel
            static isEndpointAvailable(endpoint) {
                return this.getAvailableEndpoints().includes(endpoint);
            }

            // Requisi√ß√£o principal (tenta backend, fallback para localStorage)
            static async request(endpoint, options = {}) {
                // Modo offline ou backend indispon√≠vel
                if (OFFLINE_MODE || !API_BASE_URL) {
                    return this.handleOfflineRequest(endpoint, options);
                }

                // Verificar se endpoint est√° dispon√≠vel no backend
                if (!this.isEndpointAvailable(endpoint)) {
                    console.log(`Endpoint '${endpoint}' n√£o dispon√≠vel no backend, usando localStorage`);
                    return this.handleOfflineRequest(endpoint, options);
                }

                // Tentar usar backend
                try {
                    showLoadingState(true);
                    const url = `${API_BASE_URL}/api.php?endpoint=${endpoint}`;
                    
                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    };

                    const config = { ...defaultOptions, ...options };
                    const response = await fetch(url, config);
                    
                    showLoadingState(false);
                    
                    if (!response.ok) {
                        console.warn(`Backend error ${response.status} for ${endpoint}, usando fallback offline`);
                        return this.handleOfflineRequest(endpoint, options);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.warn(`Backend retornou erro para ${endpoint}:`, data.message);
                        return this.handleOfflineRequest(endpoint, options);
                    }
                    
                    return data;
                } catch (error) {
                    showLoadingState(false);
                    console.warn(`Erro no backend para ${endpoint}, usando modo offline:`, error.message);
                    return this.handleOfflineRequest(endpoint, options);
                }
            }

            // Gerenciar requisi√ß√µes offline (localStorage)
            static handleOfflineRequest(endpoint, options = {}) {
                const method = options.method || 'GET';
                const body = options.body ? JSON.parse(options.body) : null;
                
                // Mapear endpoints para localStorage keys
                const storageKeys = {
                    'goals': 'enedes_metas',
                    'actions': 'enedes_actions', 
                    'followups': 'enedes_followups',
                    'tasks': 'enedes_tasks',
                    'schedule': 'enedes_cronograma',
                    'inventory': 'enedes_inventario',
                    'activity-log': 'enedes_activity_log'
                };

                const storageKey = storageKeys[endpoint];
                if (!storageKey) {
                    throw new Error(`Endpoint ${endpoint} n√£o suportado em modo offline`);
                }

                let data = JSON.parse(localStorage.getItem(storageKey) || '[]');

                switch (method) {
                    case 'GET':
                        return Promise.resolve({ success: true, data: data });
                    
                    case 'POST':
                        const newItem = { 
                            id: Date.now(), 
                            ...body,
                            created_at: new Date().toISOString()
                        };
                        data.push(newItem);
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        return Promise.resolve({ success: true, id: newItem.id, data: newItem });
                    
                    case 'PUT':
                        const updateIndex = data.findIndex(item => item.id == body.id);
                        if (updateIndex > -1) {
                            data[updateIndex] = { 
                                ...data[updateIndex], 
                                ...body, 
                                updated_at: new Date().toISOString() 
                            };
                            localStorage.setItem(storageKey, JSON.stringify(data));
                            return Promise.resolve({ success: true, data: data[updateIndex] });
                        }
                        throw new Error('Item n√£o encontrado');
                    
                    case 'DELETE':
                        const deleteIndex = data.findIndex(item => item.id == body.id);
                        if (deleteIndex > -1) {
                            const deletedItem = data.splice(deleteIndex, 1)[0];
                            localStorage.setItem(storageKey, JSON.stringify(data));
                            return Promise.resolve({ success: true, data: deletedItem });
                        }
                        throw new Error('Item n√£o encontrado');
                    
                    default:
                        throw new Error(`M√©todo ${method} n√£o suportado`);
                }
            }

            // METAS
            static async getMetas() {
                return await this.request('goals');
            }

            static async createMeta(metaData) {
                return await this.request('goals', {
                    method: 'POST',
                    body: JSON.stringify(metaData)
                });
            }

            static async updateMeta(id, metaData) {
                return await this.request('goals', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...metaData })
                });
            }

            static async deleteMeta(id) {
                return await this.request('goals', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // A√á√ïES
            static async getActions() {
                return await this.request('actions');
            }

            static async createAction(actionData) {
                return await this.request('actions', {
                    method: 'POST',
                    body: JSON.stringify(actionData)
                });
            }

            static async updateAction(id, actionData) {
                return await this.request('actions', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...actionData })
                });
            }

            static async deleteAction(id) {
                return await this.request('actions', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // FOLLOW-UPS
            static async getFollowUps() {
                return await this.request('followups');
            }

            static async createFollowUp(followUpData) {
                return await this.request('followups', {
                    method: 'POST',
                    body: JSON.stringify(followUpData)
                });
            }

            static async updateFollowUp(id, followUpData) {
                return await this.request('followups', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...followUpData })
                });
            }

            static async deleteFollowUp(id) {
                return await this.request('followups', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // TAREFAS
            static async getTasks() {
                return await this.request('tasks');
            }

            static async createTask(taskData) {
                return await this.request('tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
            }

            static async updateTask(id, taskData) {
                return await this.request('tasks', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...taskData })
                });
            }

            static async deleteTask(id) {
                return await this.request('tasks', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // CRONOGRAMA
            static async getCronograma() {
                return await this.request('schedule');
            }

            static async createCronogramaItem(cronogramaData) {
                return await this.request('schedule', {
                    method: 'POST',
                    body: JSON.stringify(cronogramaData)
                });
            }

            static async updateCronogramaItem(id, cronogramaData) {
                return await this.request('schedule', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...cronogramaData })
                });
            }

            static async deleteCronogramaItem(id) {
                return await this.request('schedule', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // INVENT√ÅRIO
            static async getInventario() {
                return await this.request('inventory');
            }

            static async createInventarioItem(inventarioData) {
                return await this.request('inventory', {
                    method: 'POST',
                    body: JSON.stringify(inventarioData)
                });
            }

            static async updateInventarioItem(id, inventarioData) {
                return await this.request('inventory', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...inventarioData })
                });
            }

            static async deleteInventarioItem(id) {
                return await this.request('inventory', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // LOG DE ATIVIDADES
            static async logActivity(activityData) {
                return await this.request('activity-log', {
                    method: 'POST',
                    body: JSON.stringify(activityData)
                });
            }

            static async getActivityLog() {
                return await this.request('activity-log');
            }
        }

        // ========================================
        // VARI√ÅVEIS GLOBAIS
        // ========================================
        let currentUser = null;
        let currentTab = 'dashboard';
        let currentFilter = 'all';
        let isLoading = false;
        
        // Charts
        let acoesPorProgramaChart = null;
        let followupStatusChart = null;

        // Data Arrays (agora carregados do backend)
        let actions = [];
        let followUps = [];
        let tasks = [];
        let metas = [];
        let cronograma = [];
        let inventario = [];
        let activityLog = [];

        // User definitions
        const users = {
            coord_geral: { name: "Coordena√ß√£o Geral", type: "coord_geral", program: null },
            coord_projeto_area1: { name: "Coordenador de Projeto - √Årea 1", type: "coord_projeto", program: null },
            coord_projeto_area2: { name: "Coordenador de Projeto - √Årea 2", type: "coord_projeto", program: null },
            ifb_mais_empreendedor: { name: "IFB Mais Empreendedor", type: "coord_programa", program: "ifb_mais_empreendedor" },
            rota_empreendedora: { name: "Rota Empreendedora", type: "coord_programa", program: "rota_empreendedora" },
            lab_varejo: { name: "Lab Varejo", type: "coord_programa", program: "lab_varejo" },
            lab_consumer: { name: "Lab Consumer", type: "coord_programa", program: "lab_consumer" },
            estudio: { name: "Est√∫dio", type: "coord_programa", program: "estudio" },
            ifb_digital: { name: "IFB Digital", type: "coord_programa", program: "ifb_digital" },
            sala_interativa: { name: "Sala Interativa", type: "coord_programa", program: "sala_interativa" },
            agencia_marketing: { name: "Ag√™ncia de Marketing", type: "coord_programa", program: "agencia_marketing" }
        };

        // Programs definition
        const programs = [
            { id: 1, name: "IFB Mais Empreendedor", slug: "ifb_mais_empreendedor", description: "Programa de fomento ao empreendedorismo", progress: 75, color: "blue", icon: "rocket" },
            { id: 2, name: "Rota Empreendedora", slug: "rota_empreendedora", description: "Capacita√ß√£o em empreendedorismo", progress: 60, color: "green", icon: "map" },
            { id: 3, name: "Lab Varejo", slug: "lab_varejo", description: "Laborat√≥rio de inova√ß√£o no varejo", progress: 80, color: "purple", icon: "shopping-cart" },
            { id: 4, name: "Lab Consumer", slug: "lab_consumer", description: "Pesquisa e desenvolvimento consumer", progress: 45, color: "pink", icon: "users" },
            { id: 5, name: "Est√∫dio", slug: "estudio", description: "Produ√ß√£o de conte√∫do audiovisual", progress: 90, color: "red", icon: "video" },
            { id: 6, name: "IFB Digital", slug: "ifb_digital", description: "Transforma√ß√£o digital", progress: 55, color: "indigo", icon: "smartphone" },
            { id: 7, name: "Sala Interativa", slug: "sala_interativa", description: "Espa√ßo de aprendizagem interativa", progress: 70, color: "yellow", icon: "monitor" },
            { id: 8, name: "Ag√™ncia de Marketing", slug: "agencia_marketing", description: "Estrat√©gias de marketing digital", progress: 85, color: "teal", icon: "megaphone" }
        ];

        // Collaborators definition
        const collaborators = [
            { id: 1, name: "Ana Silva", program: "Lab Consumer", email: "ana.silva@ifb.edu.br" },
            { id: 2, name: "Carlos Santos", program: "Lab Varejo", email: "carlos.santos@ifb.edu.br" },
            { id: 3, name: "Maria Oliveira", program: "Rota Empreendedora", email: "maria.oliveira@ifb.edu.br" },
            { id: 4, name: "Jo√£o Costa", program: "IFB Mais Empreendedor", email: "joao.costa@ifb.edu.br" },
            { id: 5, name: "Patricia Lima", program: "Est√∫dio", email: "patricia.lima@ifb.edu.br" },
            { id: 6, name: "Roberto Ferreira", program: "IFB Digital", email: "roberto.ferreira@ifb.edu.br" },
            { id: 7, name: "Lucia Mendes", program: "Sala Interativa", email: "lucia.mendes@ifb.edu.br" },
            { id: 8, name: "Fernando Rocha", program: "Ag√™ncia de Marketing", email: "fernando.rocha@ifb.edu.br" }
        ];

        // ========================================
        // FUN√á√ïES DE COMPATIBILIDADE COM BACKEND
        // ========================================
        
        // Fun√ß√£o para converter dados do backend (ingl√™s) para interface (portugu√™s)
        function convertBackendToInterface(backendData) {
            if (!backendData) return backendData;
            
            // Se √© array, converter cada item
            if (Array.isArray(backendData)) {
                return backendData.map(item => convertBackendToInterface(item));
            }
            
            // Se √© objeto, converter campos espec√≠ficos
            if (typeof backendData === 'object') {
                const converted = { ...backendData };
                
                // Convers√£o: title ‚Üí titulo (para exibi√ß√£o)
                if (converted.title && !converted.titulo) {
                    converted.titulo = converted.title;
                }
                
                // Convers√£o: program ‚Üí programa (para exibi√ß√£o)
                if (converted.program && !converted.programa) {
                    converted.programa = converted.program;
                }
                
                return converted;
            }
            
            return backendData;
        }

        // Fun√ß√£o para converter dados da interface (portugu√™s) para backend (ingl√™s)
        function convertInterfaceToBackend(interfaceData) {
            if (!interfaceData) return interfaceData;
            
            const converted = { ...interfaceData };
            
            // ‚úÖ CONVERS√ÉO PRINCIPAL: titulo ‚Üí title (para envio ao backend)
            if (converted.titulo) {
                converted.title = converted.titulo;
                delete converted.titulo; // Remove campo em portugu√™s
            }
            
            // ‚úÖ CONVERS√ÉO PRINCIPAL: programa ‚Üí program (para envio ao backend)  
            if (converted.programa) {
                converted.program = converted.programa;
                delete converted.programa; // Remove campo em portugu√™s
            }
            
            return converted;
        }

        // ========================================
        // FUN√á√ïES DE LOADING STATE
        // ========================================
        function showLoadingState(show) {
            isLoading = show;
            // Voc√™ pode adicionar mais l√≥gica de loading aqui se necess√°rio
        }

        // ========================================
        // FUN√á√ïES DE LOGIN E INICIALIZA√á√ÉO
        // ========================================
        async function login() {
            const userType = document.getElementById("userSelect").value;
            const password = document.getElementById("passwordInput").value;

            if (!userType) {
                alert("Por favor, selecione um usu√°rio!");
                return;
            }

            if (password !== "123456") {
                alert("Senha incorreta! Use: 123456");
                return;
            }

            currentUser = users[userType];
            document.getElementById("loginModal").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");
            
            document.getElementById("userName").textContent = currentUser.name;
            document.getElementById("userRole").textContent = currentUser.type === "coord_geral" ? "Coordena√ß√£o Geral" : 
                                                            currentUser.type === "coord_projeto" ? "Coordenador de Projeto" : 
                                                            "Coordenador de Programa";

            // ‚úÖ DIAGN√ìSTICO COMPLETO DE CONECTIVIDADE
            console.log('üîê Login realizado:', currentUser.name);
            showToast("üîê Fazendo login e testando conectividade...", "info");

            if (API_BASE_URL) {
                console.log('üåê Testando backend:', API_BASE_URL);
                
                const backendAvailable = await APIService.testBackendConnection();
                if (backendAvailable) {
                    OFFLINE_MODE = false;
                    console.log('‚úÖ Backend dispon√≠vel');
                    
                    // Testar endpoints espec√≠ficos
                    const endpointResults = await testBackendEndpoints();
                    const workingEndpoints = endpointResults.filter(r => r.available).length;
                    const totalEndpoints = endpointResults.length;
                    
                    if (workingEndpoints > 0) {
                        showToast(`üåê Backend conectado! ${workingEndpoints}/${totalEndpoints} endpoints funcionais`, "success");
                    } else {
                        OFFLINE_MODE = true;
                        showToast("‚ö†Ô∏è Backend conectado mas endpoints indispon√≠veis", "warning");
                    }
                } else {
                    OFFLINE_MODE = true;
                    console.log('‚ùå Backend indispon√≠vel');
                    showToast("üíæ Backend offline - Usando dados locais", "warning");
                }
            } else {
                OFFLINE_MODE = true;
                console.log('‚öôÔ∏è Backend n√£o configurado - modo offline');
                showToast("üíæ Modo offline configurado - Dados salvos localmente", "info");
            }

            // Show "Meu Programa" tab for program coordinators
            if (currentUser.type === "coord_programa") {
                document.getElementById("meuProgramaTab").classList.remove("hidden");
                const program = programs.find(p => p.slug === currentUser.program);
                if (program) {
                    document.getElementById("meuProgramaTabTitle").textContent = program.name;
                }
            }

            // Carregar todos os dados
            await loadAllDataFromBackend();
            updateAllData();
            initializeCharts();
            await logActivity(`Login realizado por ${currentUser.name} ${OFFLINE_MODE ? '(offline)' : '(online)'}`, "info", "log-in");
        }

        // Vari√°vel global para armazenar resultados dos testes
        let lastEndpointTest = null;

        // ‚úÖ NOVA FUN√á√ÉO: Testar endpoints do backend
        async function testBackendEndpoints() {
            console.log('üîç Testando endpoints do backend...');
            
            const endpoints = ['test', 'goals', 'actions', 'followups', 'tasks', 'inventory', 'schedule'];
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api.php?endpoint=${endpoint}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    const status = response.status;
                    const available = status === 200;
                    
                    results.push({
                        endpoint,
                        status,
                        available,
                        message: available ? 'Dispon√≠vel' : `Erro ${status}`
                    });
                    
                    console.log(`${available ? '‚úÖ' : '‚ùå'} ${endpoint}: ${status}`);
                    
                } catch (error) {
                    results.push({
                        endpoint,
                        status: 'ERROR',
                        available: false,
                        message: error.message
                    });
                    console.log(`‚ùå ${endpoint}: ${error.message}`);
                }
            }
            
            // Salvar resultados globalmente
            lastEndpointTest = {
                timestamp: new Date().toISOString(),
                results: results,
                summary: {
                    available: results.filter(r => r.available).length,
                    total: results.length,
                    working: results.filter(r => r.available).map(r => r.endpoint),
                    broken: results.filter(r => !r.available).map(r => r.endpoint)
                }
            };
            
            // Resumo dos resultados
            const available = results.filter(r => r.available).length;
            const total = results.length;
            
            console.log(`üìä Endpoints: ${available}/${total} dispon√≠veis`);
            console.log('üîß Endpoints funcionais:', results.filter(r => r.available).map(r => r.endpoint).join(', '));
            console.log('‚ö†Ô∏è Endpoints indispon√≠veis:', results.filter(r => !r.available).map(r => r.endpoint).join(', '));
            
            return results;
        }

        // ‚úÖ NOVA FUN√á√ÉO: Mostrar status t√©cnico detalhado
        function showTechnicalStatus() {
            if (!lastEndpointTest) {
                showToast("Execute um login primeiro para ver o status t√©cnico", "info");
                return;
            }

            const test = lastEndpointTest;
            const endpointRows = test.results.map(result => `
                <tr class="border-b">
                    <td class="py-2 px-3 font-mono text-sm">${result.endpoint}</td>
                    <td class="py-2 px-3 text-center">
                        <span class="px-2 py-1 rounded text-xs ${result.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${result.status}
                        </span>
                    </td>
                    <td class="py-2 px-3 text-sm">${result.message}</td>
                    <td class="py-2 px-3 text-center">${result.available ? '‚úÖ' : '‚ùå'}</td>
                </tr>
            `).join('');

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">üìä Resumo da Conectividade</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>üåê <strong>Backend:</strong> ${API_BASE_URL}</div>
                            <div>üìÖ <strong>√öltimo teste:</strong> ${new Date(test.timestamp).toLocaleString()}</div>
                            <div>‚úÖ <strong>Funcionais:</strong> ${test.summary.available}/${test.summary.total}</div>
                            <div>‚öôÔ∏è <strong>Modo:</strong> ${OFFLINE_MODE ? 'Offline' : 'Backend'}</div>
                        </div>
                    </div>

                    <div class="bg-white border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-3 text-left font-medium">Endpoint</th>
                                    <th class="py-2 px-3 text-center font-medium">Status HTTP</th>
                                    <th class="py-2 px-3 text-left font-medium">Mensagem</th>
                                    <th class="py-2 px-3 text-center font-medium">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${endpointRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="text-xs text-gray-600">
                        <p><strong>‚úÖ Endpoints funcionais:</strong> ${test.summary.working.join(', ') || 'Nenhum'}</p>
                        <p><strong>‚ùå Endpoints indispon√≠veis:</strong> ${test.summary.broken.join(', ') || 'Nenhum'}</p>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="testBackendConnectivity()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Testar Novamente</button>
            `;

            createModal("Status T√©cnico dos Endpoints", content, footer);
        }

        // ‚úÖ NOVA FUN√á√ÉO: Testar conectividade manualmente
        async function testBackendConnectivity() {
            if (!API_BASE_URL) {
                showToast("Backend n√£o configurado - modo offline ativo", "warning");
                return;
            }

            showToast("üîç Testando conectividade...", "info");
            closeModal();

            try {
                const results = await testBackendEndpoints();
                const available = results.filter(r => r.available).length;
                const total = results.length;

                setTimeout(() => {
                    showTechnicalStatus();
                    showToast(`‚úÖ Teste conclu√≠do: ${available}/${total} endpoints funcionais`, "success");
                }, 500);
            } catch (error) {
                showToast("‚ùå Erro no teste de conectividade", "error");
            }
        }

        // ========================================
        // CARREGAMENTO DE DADOS H√çBRIDO
        // ========================================
        async function loadAllDataFromBackend() {
            try {
                const loadingMessage = OFFLINE_MODE ? 
                    "Carregando dados locais..." : 
                    "Conectando ao backend...";
                    
                showToast(loadingMessage, "info");
                
                console.log('üîÑ Iniciando carregamento de dados...');
                console.log('üì° Modo:', OFFLINE_MODE ? 'OFFLINE' : 'BACKEND');
                console.log('üåê URL Backend:', API_BASE_URL || 'N√£o configurada');
                
                // ‚úÖ Carregar apenas endpoints dispon√≠veis
                const promises = [];
                const dataResults = {};
                
                // METAS - sempre tentar (endpoint dispon√≠vel)
                console.log('üìã Carregando metas do backend...');
                promises.push(
                    APIService.getMetas()
                        .then(result => { 
                            dataResults.metas = result;
                            console.log('‚úÖ Metas carregadas do BACKEND:', result.data?.length || 0, 'itens');
                        })
                        .catch(error => {
                            console.log('‚ö†Ô∏è Erro ao carregar metas do backend:', error.message);
                            const localMetas = JSON.parse(localStorage.getItem('enedes_metas') || '[]');
                            dataResults.metas = { data: localMetas };
                            console.log('üîÑ Metas carregadas do LOCALSTORAGE:', localMetas.length, 'itens');
                        })
                );

                // OUTROS ENDPOINTS - usar localStorage (404 no backend)
                console.log('üì¶ Carregando outros dados do localStorage...');
                const localStorageKeys = {
                    actions: 'enedes_actions',
                    followUps: 'enedes_followups', 
                    tasks: 'enedes_tasks',
                    cronograma: 'enedes_cronograma',
                    inventario: 'enedes_inventario'
                };

                Object.entries(localStorageKeys).forEach(([key, storageKey]) => {
                    try {
                        const data = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        dataResults[key] = { data };
                        console.log(`‚úÖ ${key} carregado do localStorage:`, data.length, 'itens');
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Erro ao carregar ${key}:`, error.message);
                        dataResults[key] = { data: [] };
                    }
                });

                // Aguardar carregamento das metas
                await Promise.all(promises);

                // Atualizar arrays globais
                metas = convertBackendToInterface(dataResults.metas?.data || []);
                actions = convertBackendToInterface(dataResults.actions?.data || []);
                followUps = convertBackendToInterface(dataResults.followUps?.data || []);
                tasks = convertBackendToInterface(dataResults.tasks?.data || []);
                cronograma = convertBackendToInterface(dataResults.cronograma?.data || []);
                inventario = convertBackendToInterface(dataResults.inventario?.data || []);

                // Status final
                const totalItems = metas.length + actions.length + followUps.length + tasks.length + cronograma.length + inventario.length;
                const hasBackendMetas = !OFFLINE_MODE && metas.length > 0;
                
                console.log('üìä Resumo dos dados carregados:');
                console.log(`   - Metas: ${metas.length} ${hasBackendMetas ? '(BACKEND)' : '(LOCAL)'}`);
                console.log(`   - A√ß√µes: ${actions.length} (LOCAL)`);
                console.log(`   - Follow-ups: ${followUps.length} (LOCAL)`);
                console.log(`   - Tarefas: ${tasks.length} (LOCAL)`);
                console.log(`   - Cronograma: ${cronograma.length} (LOCAL)`);
                console.log(`   - Invent√°rio: ${inventario.length} (LOCAL)`);
                console.log(`   - Total: ${totalItems} itens`);

                let successMessage;
                if (OFFLINE_MODE) {
                    successMessage = `üíæ ${totalItems} itens carregados (modo offline)`;
                } else if (hasBackendMetas) {
                    successMessage = `üéØ Sistema h√≠brido: Metas no backend, outros dados locais (${totalItems} itens)`;
                } else {
                    successMessage = `üìä ${totalItems} itens carregados (todos locais)`;
                }
                    
                showToast(successMessage, "success");
                
            } catch (error) {
                console.error('‚ùå Erro geral no carregamento:', error);
                
                // Em caso de erro, inicializar arrays vazios
                metas = [];
                actions = [];
                followUps = [];
                tasks = [];
                cronograma = [];
                inventario = [];
                
                const errorMessage = "‚ö†Ô∏è Erro no carregamento - sistema iniciado vazio";
                showToast(errorMessage, "warning");
            }
        }

        // ========================================
        // LOG DE ATIVIDADES
        // ========================================
        async function logActivity(message, type = "info", icon = "info") {
            try {
                const activityData = {
                    message,
                    type,
                    icon,
                    user: currentUser?.name || "Sistema",
                    timestamp: new Date().toISOString()
                };
                
                await APIService.logActivity(activityData);
            } catch (error) {
                console.error('Erro ao registrar atividade:', error);
            }
        }

        // ========================================
        // FUN√á√ïES DE METAS - ‚úÖ CORRIGIDAS PARA BACKEND
        // ========================================
        async function showMetaForm(metaId = null) {
            const meta = metaId ? metas.find(m => m.id == metaId) : null;
            const title = meta ? "Editar Meta" : "Cadastrar Nova Meta";
            
            const content = `
                <form id="metaForm" class="space-y-4">
                    <input type="hidden" id="metaId" value="${meta?.id || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da Meta</label>
                        <input type="text" id="metaTitulo" class="w-full p-2 border border-gray-300 rounded-lg" value="${meta?.titulo || meta?.title || ""}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Objetivo Social</label>
                        <textarea id="metaObjetivo" class="w-full p-2 border border-gray-300 rounded-lg" rows="3">${meta?.objetivo || ""}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Programa Respons√°vel</label>
                        <select id="metaPrograma" class="w-full p-2 border border-gray-300 rounded-lg">
                            ${programs.map(p => `<option value="${p.name}" ${(meta?.programa || meta?.program) === p.name ? "selected" : ""}>${p.name}</option>`).join("")}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Indicadores (at√© 5)</label>
                        <div id="indicadoresContainer" class="space-y-2">
                            ${(meta?.indicadores || [""]).slice(0, 5).map((indicador, index) => `
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="indicador${index}" class="flex-1 p-2 border border-gray-300 rounded-lg" 
                                           placeholder="Indicador ${index + 1}" value="${indicador}">
                                    ${index > 0 ? `<button type="button" onclick="removeIndicador(${index})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>` : ''}
                                </div>
                            `).join("")}
                        </div>
                        <button type="button" onclick="addIndicador()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                            Adicionar Indicador
                        </button>
                    </div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveMeta()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <span class="loading hidden"></span>
                    Salvar Meta
                </button>
            `;

            createModal(title, content, footer);
        }

        async function saveMeta() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("metaId").value;
                const titulo = document.getElementById("metaTitulo").value;
                const objetivo = document.getElementById("metaObjetivo").value;
                const programa = document.getElementById("metaPrograma").value;
                
                // Coleta indicadores
                const indicadores = [];
                for (let i = 0; i < 5; i++) {
                    const indicadorElement = document.getElementById(`indicador${i}`);
                    if (indicadorElement && indicadorElement.value.trim()) {
                        indicadores.push(indicadorElement.value.trim());
                    }
                }

                if (!titulo) {
                    throw new Error("O t√≠tulo da meta √© obrigat√≥rio!");
                }

                // ‚úÖ PAYLOAD EXATO ESPERADO PELO BACKEND (conforme documenta√ß√£o)
                const metaDataBackend = {
                    title: titulo,          // ‚úÖ Campo em ingl√™s 
                    objetivo: objetivo,     // ‚úÖ Campo mantido em portugu√™s
                    program: programa,      // ‚úÖ Campo em ingl√™s
                    indicadores: indicadores, // ‚úÖ Array de strings
                    status: "ativo"         // ‚úÖ Status fixo
                };

                console.log('üì§ Enviando payload para backend:', JSON.stringify(metaDataBackend, null, 2));
                console.log('üåê URL:', `${API_BASE_URL}/api.php?endpoint=goals`);

                if (id) {
                    // UPDATE: adicionar ID no payload
                    metaDataBackend.id = parseInt(id);
                    console.log('üîÑ Atualizando meta ID:', id);
                    await APIService.updateMeta(id, metaDataBackend);
                    
                    // Atualizar no array local (converter de volta para interface)
                    const metaIndex = metas.findIndex(m => m.id == id);
                    if (metaIndex > -1) {
                        metas[metaIndex] = { 
                            ...metas[metaIndex], 
                            id: parseInt(id),
                            titulo: titulo,
                            objetivo: objetivo, 
                            programa: programa,
                            indicadores: indicadores,
                            status: "ativo",
                            updated_at: new Date().toISOString()
                        };
                    }
                    await logActivity(`Meta "${titulo}" atualizada`, "info", "edit");
                    showToast("‚úÖ Meta atualizada no backend!", "success");
                } else {
                    // CREATE: novo item
                    console.log('‚ûï Criando nova meta');
                    const response = await APIService.createMeta(metaDataBackend);
                    console.log('üì• Resposta do backend:', response);
                    
                    // Adicionar ao array local (converter de volta para interface)
                    const newMeta = {
                        id: response.id || Date.now(),
                        titulo: titulo,
                        objetivo: objetivo,
                        programa: programa, 
                        indicadores: indicadores,
                        status: "ativo",
                        created_by: currentUser.name,
                        created_at: new Date().toISOString()
                    };
                    
                    metas.push(newMeta);
                    await logActivity(`Nova meta "${titulo}" cadastrada`, "success", "target");
                    showToast("‚úÖ Meta cadastrada no banco Neon PostgreSQL!", "success");
                }

                updateAllData();
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Erro detalhado ao salvar meta:', error);
                
                let errorMessage = error.message;
                
                // Tratar erros espec√≠ficos
                if (error.message.includes('400')) {
                    errorMessage = "‚ùå Erro 400: Dados inv√°lidos enviados ao backend. Verifique os campos obrigat√≥rios.";
                } else if (error.message.includes('404')) {
                    errorMessage = "‚ö†Ô∏è Endpoint n√£o encontrado. Meta salva localmente.";
                } else if (error.message.includes('500')) {
                    errorMessage = "üîß Erro interno do servidor. Tente novamente em alguns instantes.";
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = "üåê Erro de conex√£o. Verifique sua internet e tente novamente.";
                }
                
                showToast(errorMessage, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        async function deleteMeta(metaId) {
            if (confirm("Tem certeza que deseja excluir esta meta?")) {
                try {
                    const metaIndex = metas.findIndex(m => m.id == metaId);
                    if (metaIndex > -1) {
                        const metaTitle = metas[metaIndex].titulo || metas[metaIndex].title;
                        
                        await APIService.deleteMeta(metaId);
                        
                        // Remover do array local
                        metas.splice(metaIndex, 1);
                        
                        await logActivity(`Meta "${metaTitle}" exclu√≠da`, "warning", "trash-2");
                        updateAllData();
                        loadMetas();
                        showToast("Meta exclu√≠da!", "success");
                    }
                } catch (error) {
                    showToast("Erro ao excluir meta", "error");
                }
            }
        }

        // ========================================
        // FUN√á√ïES DE A√á√ïES
        // ========================================
        async function showActionForm(programName = "", actionId = null) {
            const action = actionId ? actions.find(a => a.id == actionId) : null;
            const title = action ? "Editar A√ß√£o" : "Cadastrar Nova A√ß√£o";

            const content = `
                <form id="actionForm" class="space-y-4">
                    <input type="hidden" id="actionId" value="${action?.id || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da A√ß√£o</label>
                        <input type="text" id="actionTitulo" class="w-full p-2 border border-gray-300 rounded-lg" value="${action?.titulo || ""}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Programa</label>
                        <select id="actionPrograma" class="w-full p-2 border border-gray-300 rounded-lg">
                            ${programs.map(p => `<option value="${p.name}" ${programName === p.name || action?.programa === p.name ? "selected" : ""}>${p.name}</option>`).join("")}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <textarea id="actionDescricao" class="w-full p-2 border border-gray-300 rounded-lg" rows="3">${action?.descricao || ""}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Respons√°vel</label>
                        <input type="text" id="actionResponsavel" class="w-full p-2 border border-gray-300 rounded-lg" value="${action?.responsavel || currentUser.name}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="actionStatus" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="pending" ${action?.status === "pending" ? "selected" : ""}>Pendente</option>
                            <option value="in_progress" ${action?.status === "in_progress" ? "selected" : ""}>Em Andamento</option>
                            <option value="completed" ${action?.status === "completed" ? "selected" : ""}>Conclu√≠da</option>
                        </select>
                    </div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveAction()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Salvar A√ß√£o</button>
            `;

            createModal(title, content, footer);
        }

        async function saveAction() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("actionId").value;
                const titulo = document.getElementById("actionTitulo").value;
                const programa = document.getElementById("actionPrograma").value;
                const descricao = document.getElementById("actionDescricao").value;
                const responsavel = document.getElementById("actionResponsavel").value;
                const status = document.getElementById("actionStatus").value;

                if (!titulo) {
                    throw new Error("O t√≠tulo da a√ß√£o √© obrigat√≥rio!");
                }

                const actionData = {
                    titulo,
                    programa,
                    descricao,
                    responsavel,
                    status,
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                if (id) {
                    await APIService.updateAction(id, actionData);
                    // Atualizar no array local
                    const actionIndex = actions.findIndex(a => a.id == id);
                    if (actionIndex > -1) {
                        actions[actionIndex] = { ...actions[actionIndex], ...actionData };
                    }
                    await logActivity(`A√ß√£o "${titulo}" atualizada`, "info", "edit");
                } else {
                    const response = await APIService.createAction(actionData);
                    // Adicionar ao array local
                    actions.push({ id: response.id, ...actionData });
                    await logActivity(`Nova a√ß√£o "${titulo}" cadastrada`, "success", "plus");
                }

                updateAllData();
                closeModal();
                showToast("A√ß√£o salva com sucesso!", "success");
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        async function deleteAction(actionId) {
            if (confirm("Tem certeza que deseja excluir esta a√ß√£o?")) {
                try {
                    const actionIndex = actions.findIndex(a => a.id == actionId);
                    if (actionIndex > -1) {
                        const actionTitle = actions[actionIndex].titulo;
                        
                        await APIService.deleteAction(actionId);
                        
                        // Remover do array local
                        actions.splice(actionIndex, 1);
                        
                        await logActivity(`A√ß√£o "${actionTitle}" exclu√≠da`, "warning", "trash-2");
                        updateAllData();
                        closeModal();
                        showToast(`A√ß√£o "${actionTitle}" exclu√≠da com sucesso!`, "success");
                        
                        // Recarregar conte√∫do espec√≠fico da aba atual
                        if (currentTab === 'programas') {
                            renderPrograms();
                        } else if (currentTab === 'meu-programa') {
                            loadMeuPrograma();
                        }
                    }
                } catch (error) {
                    showToast("Erro ao excluir a√ß√£o", "error");
                }
            }
        }

        // ========================================
        // FUN√á√ïES DE FOLLOW-UPS
        // ========================================
        async function showFollowUpForm(actionId = "", metaId = "", type = "") {
            let targetOptions = "";
            
            if (actionId) {
                const action = actions.find(a => a.id == actionId);
                targetOptions = `<option value="${actionId}" selected>A√ß√£o: ${action?.titulo || "N√£o encontrada"}</option>`;
            } else if (metaId) {
                const meta = metas.find(m => m.id == metaId);
                targetOptions = `<option value="${metaId}" selected>Meta: ${meta?.titulo || meta?.title || "N√£o encontrada"}</option>`;
            } else {
                // Show all actions and metas
                const actionOptions = actions.map(a => `<option value="${a.id}" data-type="action">A√ß√£o: ${a.titulo}</option>`).join("");
                const metaOptions = metas.map(m => `<option value="${m.id}" data-type="meta">Meta: ${m.titulo || m.title}</option>`).join("");
                targetOptions = `<option value="">Selecione uma a√ß√£o ou meta...</option>${actionOptions}${metaOptions}`;
            }

            const content = `
                <div class="space-y-4">
                    ${!actionId && !metaId ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar A√ß√£o ou Meta</label>
                        <select id="followUpTarget" class="w-full p-2 border border-gray-300 rounded-lg" onchange="updateFollowUpType()">
                            ${targetOptions}
                        </select>
                        <input type="hidden" id="followUpType" value="${type}">
                    </div>
                    ` : `
                    <input type="hidden" id="followUpTarget" value="${actionId || metaId}">
                    <input type="hidden" id="followUpType" value="${type}">
                    `}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Colaboradores</label>
                        <div class="max-h-32 overflow-y-auto border border-gray-300 rounded-lg p-2 space-y-2">
                            ${collaborators.map(collab => `
                                <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded">
                                    <input type="checkbox" id="collab_${collab.id}" class="collaborator-checkbox" value="${collab.id}">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-gray-900">${collab.name}</div>
                                        <div class="text-xs text-gray-500">${collab.program} ‚Ä¢ ${collab.email}</div>
                                    </div>
                                </label>
                            `).join("")}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem do Follow-up</label>
                        <textarea id="followUpMessage" class="w-full p-2 border border-gray-300 rounded-lg" rows="4" 
                                  placeholder="Descreva o que precisa ser feito, prazos, objetivos..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                            <select id="followUpPriority" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>M√©dia</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prazo</label>
                            <input type="date" id="followUpDeadline" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="sendFollowUp()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Enviar Follow-up</button>
            `;

            createModal("Novo Follow-up", content, footer);
        }

        function updateFollowUpType() {
            const select = document.getElementById("followUpTarget");
            const selectedOption = select.options[select.selectedIndex];
            const type = selectedOption.getAttribute("data-type") || "";
            document.getElementById("followUpType").value = type;
        }

        async function sendFollowUp() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Enviando...';
            saveButton.disabled = true;

            try {
                const targetId = document.getElementById("followUpTarget").value;
                const type = document.getElementById("followUpType").value;
                const message = document.getElementById("followUpMessage").value;
                const priority = document.getElementById("followUpPriority").value;
                const deadline = document.getElementById("followUpDeadline").value;

                if (!targetId) {
                    throw new Error("Por favor, selecione uma a√ß√£o ou meta!");
                }

                if (!message.trim()) {
                    throw new Error("Por favor, digite uma mensagem para o follow-up!");
                }

                // Get selected collaborators
                const selectedCollaborators = [];
                document.querySelectorAll(".collaborator-checkbox:checked").forEach(checkbox => {
                    const collabId = parseInt(checkbox.value);
                    const collaborator = collaborators.find(c => c.id === collabId);
                    if (collaborator) {
                        selectedCollaborators.push(collaborator);
                    }
                });

                if (selectedCollaborators.length === 0) {
                    throw new Error("Por favor, selecione pelo menos um colaborador!");
                }

                // Create follow-up
                const followUpData = {
                    target_id: parseInt(targetId),
                    type: type,
                    mensagem: message,
                    prioridade: priority,
                    prazo: deadline,
                    colaboradores: JSON.stringify(selectedCollaborators),
                    status: "pending",
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                const response = await APIService.createFollowUp(followUpData);
                
                // Adicionar ao array local
                followUps.push({ 
                    id: response.id, 
                    ...followUpData, 
                    colaboradores: selectedCollaborators 
                });
                
                const targetItem = type === "action" ? 
                    actions.find(a => a.id == targetId) : 
                    metas.find(m => m.id == targetId);
                
                await logActivity(`Follow-up enviado para "${targetItem?.titulo || targetItem?.title || "Item n√£o encontrado"}"`, "success", "send");
                
                updateAllData();
                closeModal();
                showToast("Follow-up enviado com sucesso!", "success");
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // ========================================
        // FUN√á√ïES DE TAREFAS
        // ========================================
        async function showTaskForm(followUpId) {
            const followUp = followUps.find(f => f.id == followUpId);
            if (!followUp) return;

            const content = `
                <div class="space-y-4">
                    <input type="hidden" id="taskFollowUpId" value="${followUpId}">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da Tarefa</label>
                        <input type="text" id="taskTitle" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <textarea id="taskDescription" class="w-full p-2 border border-gray-300 rounded-lg" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Respons√°vel</label>
                        <select id="taskResponsible" class="w-full p-2 border border-gray-300 rounded-lg">
                            ${followUp.colaboradores.map(collab => `<option value="${collab.name}">${collab.name}</option>`).join("")}
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="taskStatus" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="pending">Pendente</option>
                                <option value="in_progress">Em Andamento</option>
                                <option value="completed">Conclu√≠da</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prazo</label>
                            <input type="date" id="taskDeadline" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <!-- Nova se√ß√£o para anexar arquivos -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i data-lucide="paperclip" class="w-4 h-4 inline mr-1"></i>
                            Anexar Arquivos
                        </label>
                        <div class="space-y-2">
                            <input type="file" id="taskFiles" class="w-full p-2 border border-gray-300 rounded-lg" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif">
                            <div class="text-xs text-gray-500">
                                Formatos aceitos: PDF, DOC, XLS, PPT, TXT, JPG, PNG, GIF (m√°x. 10MB por arquivo)
                            </div>
                            <div id="taskFilesList" class="space-y-1">
                                <!-- Lista de arquivos selecionados aparecer√° aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveTask()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Salvar Tarefa</button>
            `;

            createModal("Nova Tarefa", content, footer);
            
            // Adicionar event listener para mostrar arquivos selecionados
            setTimeout(() => {
                const fileInput = document.getElementById('taskFiles');
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        displaySelectedFiles(this.files, 'taskFilesList');
                    });
                }
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        async function saveTask() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const followUpId = document.getElementById("taskFollowUpId").value;
                const titulo = document.getElementById("taskTitle").value;
                const descricao = document.getElementById("taskDescription").value;
                const responsavel = document.getElementById("taskResponsible").value;
                const status = document.getElementById("taskStatus").value;
                const prazo = document.getElementById("taskDeadline").value;
                const fileInput = document.getElementById("taskFiles");

                if (!titulo.trim()) {
                    throw new Error("O t√≠tulo da tarefa √© obrigat√≥rio!");
                }

                // Processar arquivos anexados
                const attachments = [];
                if (fileInput && fileInput.files.length > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const file = fileInput.files[i];
                        
                        // Verificar tamanho do arquivo (m√°x. 10MB)
                        if (file.size > 10 * 1024 * 1024) {
                            throw new Error(`Arquivo "${file.name}" √© muito grande. M√°ximo permitido: 10MB`);
                        }
                        
                        attachments.push({
                            id: Date.now() + i,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadedAt: new Date().toISOString(),
                            url: URL.createObjectURL(file)
                        });
                    }
                }

                const taskData = {
                    followup_id: parseInt(followUpId),
                    titulo,
                    descricao,
                    responsavel,
                    status,
                    prazo,
                    attachments: JSON.stringify(attachments),
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                const response = await APIService.createTask(taskData);
                
                // Adicionar ao array local
                tasks.push({ 
                    id: response.id, 
                    ...taskData,
                    attachments: attachments 
                });
                
                const attachmentText = attachments.length > 0 ? ` com ${attachments.length} arquivo(s)` : '';
                await logActivity(`Nova tarefa "${titulo}" criada${attachmentText}`, "success", "plus");
                
                updateAllData();
                closeModal();
                showToast(`Tarefa criada com sucesso!${attachmentText}`, "success");
                
                // Reopen the follow-up tasks modal
                setTimeout(() => showFollowUpTasks(followUpId), 100);
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        async function deleteTask(taskId) {
            if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
                try {
                    const taskIndex = tasks.findIndex(t => t.id == taskId);
                    if (taskIndex > -1) {
                        const taskTitle = tasks[taskIndex].titulo;
                        const followUpId = tasks[taskIndex].followup_id;
                        
                        await APIService.deleteTask(taskId);
                        
                        // Remover do array local
                        tasks.splice(taskIndex, 1);
                        
                        await logActivity(`Tarefa "${taskTitle}" exclu√≠da`, "warning", "trash-2");
                        updateAllData();
                        showToast("Tarefa exclu√≠da!", "success");
                        closeModal();
                        
                        // Reabrir o modal de follow-up tasks
                        setTimeout(() => showFollowUpTasks(followUpId), 100);
                    }
                } catch (error) {
                    showToast("Erro ao excluir tarefa", "error");
                }
            }
        }

        // ========================================
        // FUN√á√ïES DE INTERFACE
        // ========================================
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-teal-500', 'text-teal-600');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('border-teal-500', 'text-teal-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            
            currentTab = tabName;
            
            // Load specific content based on tab
            if (tabName === 'programas') {
                renderPrograms();
            } else if (tabName === 'metas') {
                loadMetas();
            } else if (tabName === 'meu-programa') {
                loadMeuPrograma();
            } else if (tabName === 'dashboard') {
                updateDashboardCharts();
                updateFarolAcompanhamento();
            }
        }

        function showMetasSubTab(tabName) {
            // Update tab buttons
            document.getElementById("metas-tab-estrategicas").classList.remove("border-purple-500", "text-purple-600");
            document.getElementById("metas-tab-estrategicas").classList.add("text-gray-600", "hover:text-gray-900");
            document.getElementById("metas-tab-cronograma").classList.remove("border-purple-500", "text-purple-600");
            document.getElementById("metas-tab-cronograma").classList.add("text-gray-600", "hover:text-gray-900");
            
            document.getElementById(`metas-tab-${tabName}`).classList.add("border-purple-500", "text-purple-600");
            document.getElementById(`metas-tab-${tabName}`).classList.remove("text-gray-600", "hover:text-gray-900");

            // Update content
            document.getElementById("metas-estrategicas-content").classList.toggle("hidden", tabName !== "estrategicas");
            document.getElementById("metas-cronograma-content").classList.toggle("hidden", tabName !== "cronograma");
            
            if (tabName === "cronograma") {
                loadCronograma();
            }
        }

        // Update all data displays
        function updateAllData() {
            updateStats();
            updateFollowUpsList();
            updateDashboardCharts();
            updateFarolAcompanhamento();
            updateFilterCounts();
            if (currentTab === 'metas') {
                loadMetas();
            }
            if (currentTab === 'programas') {
                renderPrograms();
            }
            if (currentTab === 'meu-programa') {
                loadMeuPrograma();
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById("totalProgramas").textContent = programs.length;
            document.getElementById("acoesAtivas").textContent = actions.length;
            document.getElementById("followupsAtivos").textContent = followUps.length;
            document.getElementById("tarefasPendentes").textContent = tasks.filter(t => t.status === "pending").length;
            
            // Update metas count
            document.getElementById("metas-count").textContent = metas.length;
        }

        function updateFilterCounts() {
            const allCount = followUps.length;
            const pendingCount = followUps.filter(f => f.status === 'pending').length;
            const inProgressCount = followUps.filter(f => f.status === 'in_progress').length;
            const completedCount = followUps.filter(f => f.status === 'completed').length;

            document.getElementById("count-all").textContent = allCount;
            document.getElementById("count-pending").textContent = pendingCount;
            document.getElementById("count-in_progress").textContent = inProgressCount;
            document.getElementById("count-completed").textContent = completedCount;
        }

        // Initialize Charts com fallback
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js n√£o dispon√≠vel - usando gr√°ficos simples');
                initializeSimpleCharts();
                return;
            }

            try {
                // A√ß√µes por Programa Chart
                const ctx1 = document.getElementById('acoesPorProgramaChart').getContext('2d');
                acoesPorProgramaChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Pendentes',
                            data: [],
                            backgroundColor: '#f59e0b'
                        }, {
                            label: 'Em Andamento',
                            data: [],
                            backgroundColor: '#3b82f6'
                        }, {
                            label: 'Conclu√≠das',
                            data: [],
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Follow-ups Status Chart
                const ctx2 = document.getElementById('followupStatusChart').getContext('2d');
                followupStatusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendentes', 'Em Andamento', 'Conclu√≠dos'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                updateDashboardCharts();
            } catch (error) {
                console.warn('Erro ao inicializar Chart.js, usando fallback:', error);
                initializeSimpleCharts();
            }
        }

        // Fallback: gr√°ficos simples com HTML/CSS
        function initializeSimpleCharts() {
            // Substituir canvas por gr√°ficos simples
            const chart1 = document.getElementById('acoesPorProgramaChart');
            const chart2 = document.getElementById('followupStatusChart');
            
            if (chart1) {
                chart1.parentElement.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üìä</div>
                        <h4 class="font-medium text-gray-900">A√ß√µes por Programa</h4>
                        <div id="simple-chart-1" class="mt-4 space-y-2">
                            <div class="text-sm text-gray-600">Carregando dados...</div>
                        </div>
                    </div>
                `;
            }
            
            if (chart2) {
                chart2.parentElement.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üîÑ</div>
                        <h4 class="font-medium text-gray-900">Follow-ups por Status</h4>
                        <div id="simple-chart-2" class="mt-4 space-y-2">
                            <div class="text-sm text-gray-600">Carregando dados...</div>
                        </div>
                    </div>
                `;
            }
            
            updateSimpleCharts();
        }

        // Update Dashboard Charts com fallback
        function updateDashboardCharts() {
            if (typeof Chart !== 'undefined' && acoesPorProgramaChart && followupStatusChart) {
                // Usar Chart.js normal
                try {
                    const programLabels = programs.map(p => p.name);
                    const pendingData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'pending').length);
                    const inProgressData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'in_progress').length);
                    const completedData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'completed').length);

                    acoesPorProgramaChart.data.labels = programLabels;
                    acoesPorProgramaChart.data.datasets[0].data = pendingData;
                    acoesPorProgramaChart.data.datasets[1].data = inProgressData;
                    acoesPorProgramaChart.data.datasets[2].data = completedData;
                    acoesPorProgramaChart.update();

                    const pendingFollowUps = followUps.filter(f => f.status === 'pending').length;
                    const inProgressFollowUps = followUps.filter(f => f.status === 'in_progress').length;
                    const completedFollowUps = followUps.filter(f => f.status === 'completed').length;

                    followupStatusChart.data.datasets[0].data = [pendingFollowUps, inProgressFollowUps, completedFollowUps];
                    followupStatusChart.update();
                } catch (error) {
                    console.warn('Erro ao atualizar gr√°ficos Chart.js:', error);
                    updateSimpleCharts();
                }
            } else {
                // Usar gr√°ficos simples
                updateSimpleCharts();
            }
        }

        // Atualizar gr√°ficos simples sem Chart.js
        function updateSimpleCharts() {
            const container1 = document.getElementById('simple-chart-1');
            const container2 = document.getElementById('simple-chart-2');
            
            if (container1) {
                const totalActions = actions.length;
                const pendingActions = actions.filter(a => a.status === 'pending').length;
                const inProgressActions = actions.filter(a => a.status === 'in_progress').length;
                const completedActions = actions.filter(a => a.status === 'completed').length;
                
                container1.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>‚è≥ Pendentes:</span>
                            <span class="font-medium">${pendingActions}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>üîÑ Em Andamento:</span>
                            <span class="font-medium">${inProgressActions}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>‚úÖ Conclu√≠das:</span>
                            <span class="font-medium">${completedActions}</span>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-sm font-semibold">
                                <span>Total:</span>
                                <span>${totalActions}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (container2) {
                const totalFollowUps = followUps.length;
                const pendingFollowUps = followUps.filter(f => f.status === 'pending').length;
                const inProgressFollowUps = followUps.filter(f => f.status === 'in_progress').length;
                const completedFollowUps = followUps.filter(f => f.status === 'completed').length;
                
                container2.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>‚è≥ Pendentes:</span>
                            <span class="font-medium">${pendingFollowUps}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>üîÑ Em Andamento:</span>
                            <span class="font-medium">${inProgressFollowUps}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>‚úÖ Conclu√≠dos:</span>
                            <span class="font-medium">${completedFollowUps}</span>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-sm font-semibold">
                                <span>Total:</span>
                                <span>${totalFollowUps}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Update Farol de Acompanhamento
        function updateFarolAcompanhamento() {
            const container = document.getElementById('farolAcompanhamento');
            container.innerHTML = '';

            programs.forEach(program => {
                const programActions = actions.filter(a => a.programa === program.name);
                const programFollowUps = followUps.filter(f => {
                    const targetItem = f.type === "action" ? 
                        actions.find(a => a.id == f.target_id) : 
                        metas.find(m => m.id == f.target_id);
                    return targetItem && (targetItem.programa === program.name);
                });

                // Calculate status based on actions and follow-ups
                let status = 'verde'; // Default green
                const totalItems = programActions.length + programFollowUps.length;
                
                if (totalItems === 0) {
                    status = 'gray';
                } else {
                    const pendingActions = programActions.filter(a => a.status === 'pending').length;
                    const pendingFollowUps = programFollowUps.filter(f => f.status === 'pending').length;
                    const totalPending = pendingActions + pendingFollowUps;
                    
                    const pendingPercentage = (totalPending / totalItems) * 100;
                    
                    if (pendingPercentage > 50) {
                        status = 'vermelho';
                    } else if (pendingPercentage > 25) {
                        status = 'amarelo';
                    }
                }

                const farolCard = document.createElement('div');
                farolCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                farolCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-900 text-sm">${program.name}</h4>
                        <div class="w-4 h-4 rounded-full farol-${status}" title="Status: ${status}"></div>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div>A√ß√µes: ${programActions.length}</div>
                        <div>Follow-ups: ${programFollowUps.length}</div>
                        <div>Progresso: ${program.progress}%</div>
                    </div>
                `;
                container.appendChild(farolCard);
            });
        }

        function updateFollowUpsList() {
            const container = document.getElementById("followUpsList");
            
            if (followUps.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-gray-500">
                        <div class="text-center">
                            <i data-lucide="send" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p>Nenhum follow-up encontrado</p>
                            <p class="text-sm">Crie um follow-up para come√ßar</p>
                        </div>
                    </div>
                `;
                return;
            }

            let filteredFollowUps = followUps;
            if (currentFilter !== 'all') {
                filteredFollowUps = followUps.filter(f => f.status === currentFilter);
            }

            container.innerHTML = filteredFollowUps.map(followUp => {
                const targetItem = followUp.type === "action" ? 
                    actions.find(a => a.id == followUp.target_id) : 
                    metas.find(m => m.id == followUp.target_id);
                
                const statusColor = followUp.status === "completed" ? "green" : 
                                  followUp.status === "in_progress" ? "blue" : "gray";
                
                const priorityColor = followUp.prioridade === "urgente" ? "red" : 
                                    followUp.prioridade === "alta" ? "orange" : 
                                    followUp.prioridade === "media" ? "blue" : "gray";

                const colaboradores = Array.isArray(followUp.colaboradores) ? 
                    followUp.colaboradores : 
                    (typeof followUp.colaboradores === 'string' ? JSON.parse(followUp.colaboradores) : []);

                return `
                    <div class="followup-card p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="status-indicator status-${statusColor}"></span>
                                    <h4 class="font-medium text-gray-900">${targetItem?.titulo || targetItem?.title || "Item n√£o encontrado"}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full bg-${priorityColor}-100 text-${priorityColor}-800">${followUp.prioridade.toUpperCase()}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${followUp.mensagem}</p>
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <span>Por: ${followUp.created_by}</span>
                                    <span>Colaboradores: ${colaboradores.length}</span>
                                    ${followUp.prazo ? `<span>Prazo: ${new Date(followUp.prazo).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showFollowUpTasks('${followUp.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                    Tarefas
                                </button>
                                <button onclick="updateFollowUpStatus('${followUp.id}')" class="text-green-600 hover:text-green-800 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                    Status
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join("");
            
            createIcons();
        }

        function filterFollowUps(status) {
            currentFilter = status;
            
            // Update filter buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-800');
            });
            
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-100', 'text-gray-800');
            document.getElementById(`filter-${status}`).classList.add('bg-blue-500', 'text-white');
            
            updateFollowUpsList();
        }

        async function loadMetas() {
            const container = document.getElementById("metasList");
            const followUpsContainer = document.getElementById("metasFollowUps");
            
            if (metas.length === 0) {
                container.innerHTML = "<p class=\"text-gray-500 text-sm\">Nenhuma meta cadastrada ainda.</p>";
            } else {
                container.innerHTML = metas.map(meta => `
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-gray-900">${meta.titulo || meta.title}</h5>
                            <div class="flex space-x-2">
                                <button onclick="showMetaForm('${meta.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i data-lucide="edit-2" class="w-4 h-4 inline mr-1"></i>
                                    Editar
                                </button>
                                <button onclick="showFollowUpForm('', '${meta.id}', 'meta')" class="text-green-600 hover:text-green-800 text-sm">
                                    <i data-lucide="send" class="w-4 h-4 inline mr-1"></i>
                                    Follow-up
                                </button>
                                <button onclick="deleteMeta('${meta.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                    Excluir
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${meta.objetivo}</p>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">Programa: ${meta.programa || meta.program}</span>
                            <span class="text-gray-500">Indicadores: ${Array.isArray(meta.indicadores) ? meta.indicadores.length : 0}</span>
                        </div>
                    </div>
                `).join("");
            }
            
            // Carregar follow-ups de metas
            const metaFollowUps = followUps.filter(f => f.type === "meta");
            if (metaFollowUps.length === 0) {
                followUpsContainer.innerHTML = "<p class=\"text-gray-500 text-sm\">Nenhum follow-up registrado ainda.</p>";
            } else {
                followUpsContainer.innerHTML = metaFollowUps.map(followUp => {
                    const meta = metas.find(m => m.id == followUp.target_id);
                    const statusColor = followUp.status === "completed" ? "green" : 
                                      followUp.status === "in_progress" ? "blue" : "gray";
                    
                    return `
                        <div class="followup-card p-3 rounded-lg">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="status-indicator status-${statusColor}"></span>
                                <h6 class="font-medium text-gray-900">${meta?.titulo || meta?.title || "Meta n√£o encontrada"}</h6>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${followUp.mensagem}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>Por: ${followUp.created_by}</span>
                                <button onclick="showFollowUpTasks('${followUp.id}')" class="text-blue-600 hover:text-blue-800">
                                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                    Tarefas
                                </button>
                            </div>
                        </div>
                    `;
                }).join("");
            }
            
            lucide.createIcons();
        }

        function renderPrograms() {
            const grid = document.getElementById("programsGrid");
            if (!grid) return;
            
            grid.innerHTML = "";
            
            let visiblePrograms = programs;
            
            if (currentUser.type === "coord_programa") {
                visiblePrograms = programs.filter(p => p.slug === currentUser.program);
            }
            
            visiblePrograms.forEach(program => {
                const card = document.createElement("div");
                card.className = "bg-gray-50 rounded-lg p-5 card-hover cursor-pointer flex flex-col";
                card.onclick = () => showProgramDetails(program.id);
                
                const programActionsCount = actions.filter(a => a.programa === program.name).length;
                const programInventoryCount = inventario.filter(i => i.programa === program.name).length;
                const programFollowUpsCount = followUps.filter(f => {
                    const targetItem = f.type === "action" ? 
                        actions.find(a => a.id == f.target_id) : 
                        metas.find(m => m.id == f.target_id);
                    return targetItem && (targetItem.programa === program.name);
                }).length;

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-${program.color}-100 p-2 rounded-lg">
                            <i data-lucide="${program.icon}" class="w-6 h-6 text-${program.color}-600"></i>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${programActionsCount} a√ß√µes</div>
                            <div class="text-xs text-gray-500">${programFollowUpsCount} follow-ups</div>
                            <div class="text-xs text-gray-500">${programInventoryCount} itens</div>
                        </div>
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-semibold text-gray-900 mb-2 text-lg">${program.name}</h3>
                        <p class="text-sm text-gray-600 mb-4 h-12">${program.description}</p>
                    </div>
                    <div class="space-y-2 mt-auto">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Progresso</span>
                            <span class="font-medium text-gray-800">${program.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="gradient-bg h-2.5 rounded-full" style="width: ${program.progress}%"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            createIcons();
        }

        function showProgramDetails(programId) {
            const program = programs.find(p => p.id === programId);
            if (!program) return;

            const programActions = actions.filter(a => a.programa === program.name);
            const programInventory = inventario.filter(i => i.programa === program.name);
            const programFollowUps = followUps.filter(f => {
                const targetItem = f.type === "action" ? 
                    actions.find(a => a.id == f.target_id) : 
                    metas.find(m => m.id == f.target_id);
                return targetItem && (targetItem.programa === program.name);
            });

            const content = `
                <div class="space-y-6">
                    <div class="bg-${program.color}-50 rounded-lg p-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-${program.color}-100 p-3 rounded-lg">
                                <i data-lucide="${program.icon}" class="w-8 h-8 text-${program.color}-600"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${program.name}</h3>
                                <p class="text-gray-600">${program.description}</p>
                                <div class="flex items-center space-x-4 mt-2">
                                    <span class="text-sm text-gray-500">Progresso: ${program.progress}%</span>
                                    <span class="text-sm text-gray-500">A√ß√µes: ${programActions.length}</span>
                                    <span class="text-sm text-gray-500">Follow-ups: ${programFollowUps.length}</span>
                                    <span class="text-sm text-gray-500">Invent√°rio: ${programInventory.length} itens</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs for Actions, Follow-ups and Inventory -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showProgramDetailsSubTab('actions', ${program.id})" class="py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm" id="program-details-tab-actions">
                                A√ß√µes (${programActions.length})
                            </button>
                            <button onclick="showProgramDetailsSubTab('followups', ${program.id})" class="py-2 px-1 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium text-sm" id="program-details-tab-followups">
                                Follow-ups (${programFollowUps.length})
                            </button>
                            <button onclick="showProgramDetailsSubTab('inventory', ${program.id})" class="py-2 px-1 border-b-2 border-transparent text-gray-600 hover:text-gray-900 font-medium text-sm" id="program-details-tab-inventory">
                                Invent√°rio (${programInventory.length})
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Actions Tab -->
                    <div id="program-details-actions-content" class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">A√ß√µes do Programa</h4>
                            <button onclick="showActionForm('${program.name}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Nova A√ß√£o
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${programActions.length === 0 ? 
                                "<p class=\"text-gray-500 text-sm\">Nenhuma a√ß√£o cadastrada ainda para este programa.</p>" :
                                programActions.map(action => `
                                    <div class="p-4 border border-gray-200 rounded-lg">
                                        <div class="flex justify-between items-start mb-2">
                                            <h5 class="font-medium text-gray-900">${action.titulo}</h5>
                                            <span class="text-xs px-2 py-1 rounded-full ${action.status === "completed" ? "bg-green-100 text-green-800" : action.status === "in_progress" ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-800"}">${action.status === "completed" ? "Conclu√≠da" : action.status === "in_progress" ? "Em Andamento" : "Pendente"}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2">${action.descricao}</p>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-gray-500">Respons√°vel: ${action.responsavel}</span>
                                            <div class="space-x-2">
                                                <button onclick="editAction('${action.id}')" class="text-blue-600 hover:text-blue-800">
                                                    <i data-lucide="edit-2" class="w-4 h-4 inline mr-1"></i>
                                                    Editar
                                                </button>
                                                <button onclick="showFollowUpForm('${action.id}', '', 'action')" class="text-green-600 hover:text-green-800">
                                                    <i data-lucide="send" class="w-4 h-4 inline mr-1"></i>
                                                    Follow-up
                                                </button>
                                                <button onclick="deleteAction('${action.id}')" class="text-red-600 hover:text-red-800">
                                                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                                    Excluir
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join("")
                            }
                        </div>
                    </div>
                    
                    <!-- Follow-ups Tab -->
                    <div id="program-details-followups-content" class="p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Follow-ups do Programa</h4>
                        </div>
                        <div class="space-y-3">
                            ${programFollowUps.length === 0 ? 
                                "<p class=\"text-gray-500 text-sm\">Nenhum follow-up registrado ainda para este programa.</p>" :
                                programFollowUps.map(followUp => {
                                    const targetItem = followUp.type === "action" ? 
                                        actions.find(a => a.id == followUp.target_id) : 
                                        metas.find(m => m.id == followUp.target_id);
                                    
                                    const statusColor = followUp.status === "completed" ? "green" : 
                                                      followUp.status === "in_progress" ? "blue" : "gray";
                                    
                                    return `
                                        <div class="followup-card p-4 rounded-lg">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2 mb-1">
                                                        <span class="status-indicator status-${statusColor}"></span>
                                                        <h5 class="font-medium text-gray-900">${targetItem?.titulo || targetItem?.title || "Item n√£o encontrado"}</h5>
                                                    </div>
                                                    <p class="text-sm text-gray-600">${followUp.mensagem}</p>
                                                    <div class="flex items-center space-x-3 text-xs text-gray-500 mt-2">
                                                        <span>Por: ${followUp.created_by}</span>
                                                        <span>Colaboradores: ${Array.isArray(followUp.colaboradores) ? followUp.colaboradores.length : JSON.parse(followUp.colaboradores || '[]').length}</span>
                                                    </div>
                                                </div>
                                                <button onclick="showFollowUpTasks('${followUp.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                                    Tarefas
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join("")
                            }
                        </div>
                    </div>
                    
                    <!-- Inventory Tab -->
                    <div id="program-details-inventory-content" class="p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Invent√°rio de Equipamentos</h4>
                            <button onclick="showInventarioForm('${program.name}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Novo Equipamento
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descri√ß√£o</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Atividades Relacionadas</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${programInventory.length === 0 ? 
                                        "<tr><td colspan=\"5\" class=\"px-4 py-8 text-center text-gray-500\">Nenhum equipamento no invent√°rio ainda.</td></tr>" :
                                        programInventory.map(item => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item}</td>
                                                <td class="px-4 py-4 text-sm text-gray-900">${item.descricao}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${item.valor ? parseFloat(item.valor).toLocaleString() : "0"}</td>
                                                <td class="px-4 py-4 text-sm text-gray-900">${item.atividades_relacionadas || "N/A"}</td>
                                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="editInventarioItem('${item.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="deleteInventarioItem('${item.id}')" class="text-red-600 hover:text-red-900">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join("")
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Fechar
                    </button>
                </div>
            `;

            createModal(program.name, content, footer);
        }

        function showProgramDetailsSubTab(tabName, programId) {
            // Update tab buttons
            document.getElementById("program-details-tab-actions").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("program-details-tab-actions").classList.add("text-gray-600", "hover:text-gray-900");
            document.getElementById("program-details-tab-followups").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("program-details-tab-followups").classList.add("text-gray-600", "hover:text-gray-900");
            document.getElementById("program-details-tab-inventory").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("program-details-tab-inventory").classList.add("text-gray-600", "hover:text-gray-900");
            
            document.getElementById(`program-details-tab-${tabName}`).classList.add("border-blue-500", "text-blue-600");
            document.getElementById(`program-details-tab-${tabName}`).classList.remove("text-gray-600", "hover:text-gray-900");

            // Update content
            document.getElementById("program-details-actions-content").classList.toggle("hidden", tabName !== "actions");
            document.getElementById("program-details-followups-content").classList.toggle("hidden", tabName !== "followups");
            document.getElementById("program-details-inventory-content").classList.toggle("hidden", tabName !== "inventory");
        }

        // ========================================
        // FUN√á√ïES DE INVENT√ÅRIO
        // ========================================
        async function showInventarioForm(programName = "", itemId = null) {
            const item = itemId ? inventario.find(i => i.id == itemId) : null;
            const title = item ? "Editar Item do Invent√°rio" : "Cadastrar Novo Equipamento";

            const content = `
                <form id="inventarioForm" class="space-y-4">
                    <input type="hidden" id="itemId" value="${item?.id || ""}">
                    <input type="hidden" id="itemPrograma" value="${programName || item?.programa || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Item</label>
                        <input type="text" id="itemNome" class="w-full p-2 border border-gray-300 rounded-lg" value="${item?.item || ""}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <textarea id="itemDescricao" class="w-full p-2 border border-gray-300 rounded-lg" rows="3">${item?.descricao || ""}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="number" id="itemValor" class="w-full p-2 border border-gray-300 rounded-lg" value="${item?.valor || ""}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Atividades Relacionadas</label>
                        <input type="text" id="itemAtividades" class="w-full p-2 border border-gray-300 rounded-lg" value="${item?.atividades_relacionadas || ""}">
                    </div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveInventarioItem()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Salvar Item</button>
            `;

            createModal(title, content, footer);
        }

        async function saveInventarioItem() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("itemId").value;
                const programa = document.getElementById("itemPrograma").value;
                const item = document.getElementById("itemNome").value;
                const descricao = document.getElementById("itemDescricao").value;
                const valor = parseFloat(document.getElementById("itemValor").value) || 0;
                const atividades_relacionadas = document.getElementById("itemAtividades").value;

                if (!item) {
                    throw new Error("O nome do item √© obrigat√≥rio!");
                }

                const inventarioData = {
                    programa,
                    item,
                    descricao,
                    valor,
                    atividades_relacionadas,
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                if (id) {
                    await APIService.updateInventarioItem(id, inventarioData);
                    // Atualizar no array local
                    const itemIndex = inventario.findIndex(i => i.id == id);
                    if (itemIndex > -1) {
                        inventario[itemIndex] = { ...inventario[itemIndex], ...inventarioData };
                    }
                    await logActivity(`Item "${item}" atualizado no invent√°rio`, "info", "edit");
                } else {
                    const response = await APIService.createInventarioItem(inventarioData);
                    // Adicionar ao array local
                    inventario.push({ id: response.id, ...inventarioData });
                    await logActivity(`Novo item "${item}" adicionado ao invent√°rio`, "success", "package");
                }

                updateAllData();
                closeModal();
                showToast("Item salvo no invent√°rio!", "success");
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        function editInventarioItem(itemId) {
            showInventarioForm("", itemId);
        }

        async function deleteInventarioItem(itemId) {
            if (confirm("Tem certeza que deseja excluir este item?")) {
                try {
                    const itemIndex = inventario.findIndex(i => i.id == itemId);
                    if (itemIndex > -1) {
                        const itemName = inventario[itemIndex].item;
                        
                        await APIService.deleteInventarioItem(itemId);
                        
                        // Remover do array local
                        inventario.splice(itemIndex, 1);
                        
                        await logActivity(`Item "${itemName}" exclu√≠do do invent√°rio`, "warning", "trash-2");
                        updateAllData();
                        closeModal();
                        showToast("Item exclu√≠do!", "success");
                        
                        // Recarregar conte√∫do espec√≠fico da aba atual
                        if (currentTab === 'programas') {
                            renderPrograms();
                        } else if (currentTab === 'meu-programa') {
                            loadMeuPrograma();
                        }
                    }
                } catch (error) {
                    showToast("Erro ao excluir item", "error");
                }
            }
        }

        // ========================================
        // FUN√á√ïES DE CRONOGRAMA
        // ========================================
        async function showCronogramaForm(etapaId = null) {
            const etapa = etapaId ? cronograma.find(e => e.id == etapaId) : null;
            const title = etapa ? "Editar Etapa do Cronograma" : "Nova Etapa do Cronograma";

            const content = `
                <form id="cronogramaForm" class="space-y-4">
                    <input type="hidden" id="etapaId" value="${etapa?.id || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Etapa/Programa</label>
                        <input type="text" id="etapaNome" class="w-full p-2 border border-gray-300 rounded-lg" value="${etapa?.nome || ""}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">In√≠cio</label>
                        <input type="date" id="etapaInicio" class="w-full p-2 border border-gray-300 rounded-lg" value="${etapa?.inicio || ""}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prazo Final</label>
                        <input type="date" id="etapaFim" class="w-full p-2 border border-gray-300 rounded-lg" value="${etapa?.fim || ""}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rubrica (Valor Or√ßado)</label>
                        <input type="number" id="etapaRubrica" class="w-full p-2 border border-gray-300 rounded-lg" value="${etapa?.rubrica || ""}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Executado</label>
                        <input type="number" id="etapaExecutado" class="w-full p-2 border border-gray-300 rounded-lg" value="${etapa?.executado || ""}">
                    </div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveCronogramaEtapa()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Salvar Etapa</button>
            `;

            createModal(title, content, footer);
        }

        async function saveCronogramaEtapa() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("etapaId").value;
                const nome = document.getElementById("etapaNome").value;
                const inicio = document.getElementById("etapaInicio").value;
                const fim = document.getElementById("etapaFim").value;
                const rubrica = parseFloat(document.getElementById("etapaRubrica").value) || 0;
                const executado = parseFloat(document.getElementById("etapaExecutado").value) || 0;

                if (!nome) {
                    throw new Error("O nome da etapa √© obrigat√≥rio!");
                }

                const cronogramaData = {
                    nome,
                    inicio,
                    fim,
                    rubrica,
                    executado,
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                if (id) {
                    await APIService.updateCronogramaItem(id, cronogramaData);
                    // Atualizar no array local
                    const etapaIndex = cronograma.findIndex(e => e.id == id);
                    if (etapaIndex > -1) {
                        cronograma[etapaIndex] = { ...cronograma[etapaIndex], ...cronogramaData };
                    }
                    await logActivity(`Etapa "${nome}" do cronograma atualizada`, "info", "edit");
                } else {
                    const response = await APIService.createCronogramaItem(cronogramaData);
                    // Adicionar ao array local
                    cronograma.push({ id: response.id, ...cronogramaData });
                    await logActivity(`Nova etapa "${nome}" adicionada ao cronograma`, "success", "calendar");
                }

                updateAllData();
                closeModal();
                showToast("Etapa do cronograma salva com sucesso!", "success");
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        function editCronogramaEtapa(etapaId) {
            showCronogramaForm(etapaId);
        }

        async function deleteCronogramaEtapa(etapaId) {
            if (confirm("Tem certeza que deseja excluir esta etapa?")) {
                try {
                    const etapaIndex = cronograma.findIndex(e => e.id == etapaId);
                    if (etapaIndex > -1) {
                        const etapaNome = cronograma[etapaIndex].nome;
                        
                        await APIService.deleteCronogramaItem(etapaId);
                        
                        // Remover do array local
                        cronograma.splice(etapaIndex, 1);
                        
                        await logActivity(`Etapa "${etapaNome}" exclu√≠da do cronograma`, "warning", "trash-2");
                        updateAllData();
                        loadCronograma();
                        closeModal();
                        showToast("Etapa exclu√≠da!", "success");
                    }
                } catch (error) {
                    showToast("Erro ao excluir etapa", "error");
                }
            }
        }

        function loadCronograma() {
            const tbody = document.getElementById("cronogramaTable");
            if (cronograma.length === 0) {
                tbody.innerHTML = "<tr><td colspan=\"8\" class=\"px-4 py-8 text-center text-gray-500\">Nenhuma etapa cadastrada ainda.</td></tr>";
                return;
            }

            tbody.innerHTML = cronograma.map(etapa => {
                const saldo = (etapa.rubrica || 0) - (etapa.executado || 0);
                const status = etapa.rubrica > 0 ? Math.round(((etapa.executado || 0) / etapa.rubrica) * 100) : 0;
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${etapa.nome}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${etapa.inicio}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${etapa.fim}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${(etapa.rubrica || 0).toLocaleString()}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${(etapa.executado || 0).toLocaleString()}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${saldo >= 0 ? "text-green-600" : "text-red-600"}">R$ ${saldo.toLocaleString()}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${status}%</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editCronogramaEtapa('${etapa.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteCronogramaEtapa('${etapa.id}')" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join("");
            createIcons();
        }

        // ========================================
        // FUN√á√ïES DE TAREFAS E FOLLOW-UPS
        // ========================================
        function showFollowUpTasks(followUpId) {
            const followUp = followUps.find(f => f.id == followUpId);
            if (!followUp) return;

            const targetItem = followUp.type === "action" ? 
                actions.find(a => a.id == followUp.target_id) : 
                metas.find(m => m.id == followUp.target_id);

            const followUpTasks = tasks.filter(t => t.followup_id == followUpId);

            const colaboradores = Array.isArray(followUp.colaboradores) ? 
                followUp.colaboradores : 
                (typeof followUp.colaboradores === 'string' ? JSON.parse(followUp.colaboradores) : []);

            const content = `
                <div class="space-y-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900">Follow-up: ${followUp.mensagem.substring(0, 100)}${followUp.mensagem.length > 100 ? '...' : ''}</h4>
                        <p class="text-sm text-blue-700 mt-1">Colaboradores: ${colaboradores.map(c => c.name || c).join(', ')}</p>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Tarefas Atreladas</h4>
                            <button onclick="showTaskForm('${followUpId}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Nova Tarefa
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            ${followUpTasks.length === 0 ? 
                                "<p class=\"text-gray-500 text-sm\">Nenhuma tarefa atrelada ainda.</p>" :
                                followUpTasks.map(task => {
                                    const statusColor = task.status === "completed" ? "green" : 
                                                      task.status === "in_progress" ? "blue" : "gray";
                                    
                                    const attachments = Array.isArray(task.attachments) ? 
                                        task.attachments : 
                                        (typeof task.attachments === 'string' ? JSON.parse(task.attachments || '[]') : []);

                                    return `
                                        <div class="p-3 border border-gray-200 rounded-lg">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="status-indicator status-${statusColor}"></span>
                                                    <h5 class="font-medium text-gray-900">${task.titulo}</h5>
                                                </div>
                                                <div class="flex space-x-2">
                                                    <button onclick="updateTaskStatus('${task.id}')" class="text-green-600 hover:text-green-800 text-sm">
                                                        <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                                        Status
                                                    </button>
                                                    <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                                        <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                                        Excluir
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-2">${task.descricao}</p>
                                            
                                            <!-- Exibir arquivos anexados -->
                                            ${attachments.length > 0 ? `
                                                <div class="mb-2 p-2 bg-gray-50 rounded border">
                                                    <div class="flex items-center text-xs text-gray-600 mb-1">
                                                        <i data-lucide="paperclip" class="w-3 h-3 mr-1"></i>
                                                        ${attachments.length} arquivo(s) anexado(s)
                                                    </div>
                                                    <div class="space-y-1">
                                                        ${attachments.map(file => `
                                                            <div class="flex items-center justify-between text-xs">
                                                                <span class="text-blue-600 hover:text-blue-800 cursor-pointer" onclick="downloadFile('${file.url}', '${file.name}')">
                                                                    <i data-lucide="file" class="w-3 h-3 inline mr-1"></i>
                                                                    ${file.name}
                                                                </span>
                                                                <span class="text-gray-400">${formatFileSize(file.size)}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="flex justify-between items-center text-xs text-gray-500">
                                                <span>Respons√°vel: ${task.responsavel}</span>
                                                <span>Prazo: ${task.prazo || "N√£o definido"}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join("")
                            }
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
            `;

            createModal("Gerenciar Tarefas", content, footer);
        }

        async function updateTaskStatus(taskId) {
            const task = tasks.find(t => t.id == taskId);
            if (!task) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-900">Tarefa: ${task.titulo}</h4>
                        <p class="text-sm text-green-700">${task.descricao}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Novo Status</label>
                        <select id="newTaskStatus" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="pending" ${task.status === "pending" ? "selected" : ""}>Pendente</option>
                            <option value="in_progress" ${task.status === "in_progress" ? "selected" : ""}>Em Andamento</option>
                            <option value="completed" ${task.status === "completed" ? "selected" : ""}>Conclu√≠da</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Coment√°rio (opcional)</label>
                        <textarea id="statusComment" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                                  placeholder="Adicione um coment√°rio sobre a atualiza√ß√£o..."></textarea>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="confirmTaskStatusUpdate('${taskId}')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    Atualizar Status
                </button>
            `;

            createModal("Atualizar Status da Tarefa", content, footer);
        }

        async function confirmTaskStatusUpdate(taskId) {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Atualizando...';
            saveButton.disabled = true;

            try {
                const newStatus = document.getElementById("newTaskStatus").value;
                const comment = document.getElementById("statusComment").value;
                
                const taskIndex = tasks.findIndex(t => t.id == taskId);
                if (taskIndex > -1) {
                    const oldStatus = tasks[taskIndex].status;
                    const updateData = {
                        ...tasks[taskIndex],
                        status: newStatus,
                        last_update: new Date().toISOString()
                    };
                    
                    if (comment.trim()) {
                        if (!updateData.comments) updateData.comments = [];
                        updateData.comments.push({
                            text: comment,
                            author: currentUser.name,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    await APIService.updateTask(taskId, updateData);
                    
                    // Atualizar no array local
                    tasks[taskIndex] = updateData;
                    
                    const statusText = newStatus === "completed" ? "conclu√≠da" : 
                                     newStatus === "in_progress" ? "em andamento" : "pendente";
                    
                    await logActivity(`Status da tarefa "${tasks[taskIndex].titulo}" alterado para ${statusText}`, "info", "check-circle");
                    
                    updateAllData();
                    closeModal();
                    showToast("Status da tarefa atualizado!", "success");
                }
            } catch (error) {
                showToast("Erro ao atualizar status da tarefa", "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        async function updateFollowUpStatus(followUpId) {
            const followUp = followUps.find(f => f.id == followUpId);
            if (!followUp) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900">Follow-up</h4>
                        <p class="text-sm text-blue-700">${followUp.mensagem}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Novo Status</label>
                        <select id="newFollowUpStatus" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="pending" ${followUp.status === "pending" ? "selected" : ""}>Pendente</option>
                            <option value="in_progress" ${followUp.status === "in_progress" ? "selected" : ""}>Em Andamento</option>
                            <option value="completed" ${followUp.status === "completed" ? "selected" : ""}>Conclu√≠do</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                        <textarea id="followUpObservations" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" 
                                  placeholder="Adicione observa√ß√µes sobre o progresso..."></textarea>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="confirmFollowUpStatusUpdate('${followUpId}')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    Atualizar Status
                </button>
            `;

            createModal("Atualizar Status do Follow-up", content, footer);
        }

        async function confirmFollowUpStatusUpdate(followUpId) {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Atualizando...';
            saveButton.disabled = true;

            try {
                const newStatus = document.getElementById("newFollowUpStatus").value;
                const observations = document.getElementById("followUpObservations").value;
                
                const followUpIndex = followUps.findIndex(f => f.id == followUpId);
                if (followUpIndex > -1) {
                    const updateData = {
                        ...followUps[followUpIndex],
                        status: newStatus,
                        last_update: new Date().toISOString()
                    };
                    
                    if (observations.trim()) {
                        if (!updateData.observations) updateData.observations = [];
                        updateData.observations.push({
                            text: observations,
                            author: currentUser.name,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    await APIService.updateFollowUp(followUpId, updateData);
                    
                    // Atualizar no array local
                    followUps[followUpIndex] = updateData;
                    
                    const statusText = newStatus === "completed" ? "conclu√≠do" : 
                                     newStatus === "in_progress" ? "em andamento" : "pendente";
                    
                    await logActivity(`Status do follow-up alterado para ${statusText}`, "info", "check-circle");
                    
                    updateAllData();
                    closeModal();
                    showToast("Status do follow-up atualizado!", "success");
                }
            } catch (error) {
                showToast("Erro ao atualizar status do follow-up", "error");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        function editAction(actionId) {
            showActionForm("", actionId);
        }

        function loadMeuPrograma() {
            const program = programs.find(p => p.slug === currentUser.program);
            if (!program) return;

            document.getElementById("meuProgramaTitle").textContent = `Meu Programa: ${program.name}`;
            document.getElementById("meuProgramaContent").innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="flex border-b">
                        <button onclick="showMeuProgramaSubTab('actions')" class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600" id="meu-programa-tab-actions">
                            <i data-lucide="activity" class="w-4 h-4 inline mr-2"></i>
                            A√ß√µes
                        </button>
                        <button onclick="showMeuProgramaSubTab('followups')" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900" id="meu-programa-tab-followups">
                            <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                            Follow-ups
                        </button>
                        <button onclick="showMeuProgramaSubTab('inventory')" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900" id="meu-programa-tab-inventory">
                            <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                            Invent√°rio
                        </button>
                    </div>
                    
                    <div id="meu-programa-actions-content" class="p-6">
                        <!-- Actions content will be loaded here -->
                    </div>
                    
                    <div id="meu-programa-followups-content" class="p-6 hidden">
                        <!-- Follow-ups content will be loaded here -->
                    </div>
                    
                    <div id="meu-programa-inventory-content" class="p-6 hidden">
                        <!-- Inventory content will be loaded here -->
                    </div>
                </div>
            `;

            loadMeuProgramaActions();
            loadMeuProgramaFollowUps();
            loadMeuProgramaInventory();
        }

        function showMeuProgramaSubTab(tabName) {
            document.getElementById("meu-programa-tab-actions").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("meu-programa-tab-actions").classList.add("text-gray-600", "hover:text-gray-900");
            document.getElementById("meu-programa-tab-followups").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("meu-programa-tab-followups").classList.add("text-gray-600", "hover:text-gray-900");
            document.getElementById("meu-programa-tab-inventory").classList.remove("border-blue-500", "text-blue-600");
            document.getElementById("meu-programa-tab-inventory").classList.add("text-gray-600", "hover:text-gray-900");
            
            document.getElementById(`meu-programa-tab-${tabName}`).classList.add("border-blue-500", "text-blue-600");
            document.getElementById(`meu-programa-tab-${tabName}`).classList.remove("text-gray-600", "hover:text-gray-900");

            document.getElementById("meu-programa-actions-content").classList.toggle("hidden", tabName !== "actions");
            document.getElementById("meu-programa-followups-content").classList.toggle("hidden", tabName !== "followups");
            document.getElementById("meu-programa-inventory-content").classList.toggle("hidden", tabName !== "inventory");
        }

        function loadMeuProgramaActions() {
            const program = programs.find(p => p.slug === currentUser.program);
            if (!program) return;

            const programActions = actions.filter(a => a.programa === program.name);
            const container = document.getElementById("meu-programa-actions-content");

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-900">A√ß√µes do Programa</h4>
                    <button onclick="showActionForm('${program.name}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                        Nova A√ß√£o
                    </button>
                </div>
                <div class="space-y-3">
                    ${programActions.length === 0 ? 
                        "<p class=\"text-gray-500 text-sm\">Nenhuma a√ß√£o cadastrada ainda.</p>" :
                        programActions.map(action => `
                            <div class="p-4 border border-gray-200 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <h5 class="font-medium text-gray-900">${action.titulo}</h5>
                                    <span class="text-xs px-2 py-1 rounded-full ${action.status === "completed" ? "bg-green-100 text-green-800" : action.status === "in_progress" ? "bg-blue-100 text-blue-800" : "bg-gray-100 text-gray-800"}">${action.status === "completed" ? "Conclu√≠da" : action.status === "in_progress" ? "Em Andamento" : "Pendente"}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${action.descricao}</p>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-500">Respons√°vel: ${action.responsavel}</span>
                                    <div class="space-x-2">
                                        <button onclick="editAction('${action.id}')" class="text-blue-600 hover:text-blue-800">
                                            <i data-lucide="edit-2" class="w-4 h-4 inline mr-1"></i>
                                            Editar
                                        </button>
                                        <button onclick="showFollowUpForm('${action.id}', '', 'action')" class="text-green-600 hover:text-green-800">
                                            <i data-lucide="send" class="w-4 h-4 inline mr-1"></i>
                                            Follow-up
                                        </button>
                                        <button onclick="deleteAction('${action.id}')" class="text-red-600 hover:text-red-800">
                                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                            Excluir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join("")
                    }
                </div>
            `;
            createIcons();
        }

        function loadMeuProgramaFollowUps() {
            const program = programs.find(p => p.slug === currentUser.program);
            if (!program) return;

            const programFollowUps = followUps.filter(f => {
                const targetItem = f.type === "action" ? 
                    actions.find(a => a.id == f.target_id) : 
                    metas.find(m => m.id == f.target_id);
                return targetItem && (targetItem.programa === program.name);
            });

            const container = document.getElementById("meu-programa-followups-content");

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-900">Follow-ups do Programa</h4>
                </div>
                <div class="space-y-3">
                    ${programFollowUps.length === 0 ? 
                        "<p class=\"text-gray-500 text-sm\">Nenhum follow-up registrado ainda.</p>" :
                        programFollowUps.map(followUp => {
                            const targetItem = followUp.type === "action" ? 
                                actions.find(a => a.id == followUp.target_id) : 
                                metas.find(m => m.id == followUp.target_id);
                            
                            const statusColor = followUp.status === "completed" ? "green" : 
                                              followUp.status === "in_progress" ? "blue" : "gray";
                            
                            const colaboradores = Array.isArray(followUp.colaboradores) ? 
                                followUp.colaboradores : 
                                (typeof followUp.colaboradores === 'string' ? JSON.parse(followUp.colaboradores) : []);

                            return `
                                <div class="followup-card p-4 rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="status-indicator status-${statusColor}"></span>
                                                <h5 class="font-medium text-gray-900">${targetItem?.titulo || targetItem?.title || "Item n√£o encontrado"}</h5>
                                            </div>
                                            <p class="text-sm text-gray-600">${followUp.mensagem}</p>
                                            <div class="flex items-center space-x-3 text-xs text-gray-500 mt-2">
                                                <span>Por: ${followUp.created_by}</span>
                                                <span>Colaboradores: ${colaboradores.length}</span>
                                            </div>
                                        </div>
                                        <button onclick="showFollowUpTasks('${followUp.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                            Tarefas
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join("")
                    }
                </div>
            `;
            createIcons();
        }

        function loadMeuProgramaInventory() {
            const program = programs.find(p => p.slug === currentUser.program);
            if (!program) return;

            const programInventory = inventario.filter(i => i.programa === program.name);
            const container = document.getElementById("meu-programa-inventory-content");

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-900">Invent√°rio de Equipamentos</h4>
                    <button onclick="showInventarioForm('${program.name}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                        <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                        Novo Equipamento
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descri√ß√£o</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor (R$)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Atividades Relacionadas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${programInventory.length === 0 ? 
                                "<tr><td colspan=\"5\" class=\"px-4 py-8 text-center text-gray-500\">Nenhum equipamento no invent√°rio ainda.</td></tr>" :
                                programInventory.map(item => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item}</td>
                                        <td class="px-4 py-4 text-sm text-gray-900">${item.descricao}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${item.valor ? parseFloat(item.valor).toLocaleString() : "0"}</td>
                                        <td class="px-4 py-4 text-sm text-gray-900">${item.atividades_relacionadas || "N/A"}</td>
                                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editInventarioItem('${item.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="deleteInventarioItem('${item.id}')" class="text-red-600 hover:text-red-900">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join("")
                            }
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();
        }

        // ========================================
        // FUN√á√ïES AUXILIARES E UI
        // ========================================
        function addIndicador() {
            const container = document.getElementById("indicadoresContainer");
            const currentInputs = container.querySelectorAll('input[id^="indicador"]');
            
            if (currentInputs.length >= 5) {
                alert("M√°ximo de 5 indicadores por meta!");
                return;
            }
            
            const index = currentInputs.length;
            const newIndicadorHTML = `
                <div class="flex items-center space-x-2">
                    <input type="text" id="indicador${index}" class="flex-1 p-2 border border-gray-300 rounded-lg" 
                           placeholder="Indicador ${index + 1}">
                    <button type="button" onclick="removeIndicador(${index})" class="text-red-600 hover:text-red-800">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newIndicadorHTML);
            createIcons();
        }

        function removeIndicador(index) {
            const indicadorElement = document.getElementById(`indicador${index}`);
            if (indicadorElement) {
                indicadorElement.parentElement.remove();
                
                // Reindexar os indicadores restantes
                const container = document.getElementById("indicadoresContainer");
                const inputs = container.querySelectorAll('input[id^="indicador"]');
                inputs.forEach((input, newIndex) => {
                    input.id = `indicador${newIndex}`;
                    input.placeholder = `Indicador ${newIndex + 1}`;
                    
                    const removeButton = input.nextElementSibling;
                    if (removeButton && newIndex > 0) {
                        removeButton.setAttribute('onclick', `removeIndicador(${newIndex})`);
                    }
                });
            }
        }

        // Utility functions
        function createModal(title, content, footer) {
            const modal = `
                <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 fade-in">
                    <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <span data-lucide="x" style="font-size: 24px;">‚úñÔ∏è</span>
                            </button>
                        </div>
                        <div class="p-6">
                            ${content}
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t bg-gray-50">
                            ${footer}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById("modalContainer").innerHTML = modal;
            createIcons();
        }

        function closeModal() {
            document.getElementById("modalContainer").innerHTML = "";
        }

        function showToast(message, type = "info") {
            const toast = document.getElementById("toast");
            const icon = document.getElementById("toastIcon");
            const messageEl = document.getElementById("toastMessage");
            
            const icons = {
                success: '<span data-lucide="check-circle" style="color: #10b981; font-size: 20px;">‚úÖ</span>',
                error: '<span data-lucide="x-circle" style="color: #ef4444; font-size: 20px;">‚ùå</span>',
                warning: '<span data-lucide="alert-triangle" style="color: #f59e0b; font-size: 20px;">‚ö†Ô∏è</span>',
                info: '<span data-lucide="info" style="color: #3b82f6; font-size: 20px;">‚ÑπÔ∏è</span>'
            };
            
            icon.innerHTML = icons[type] || icons.info;
            messageEl.textContent = message;
            
            toast.classList.add("show");
            createIcons();
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            document.getElementById("toast").classList.remove("show");
        }

        function showNotifications() {
            const content = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span data-lucide="check-circle" style="font-size: 20px;">‚úÖ</span>
                            <div>
                                <h4 class="font-medium text-green-900">‚úÖ Backend ENEDES conectado!</h4>
                                <p class="text-sm text-green-700">Endpoint METAS funcionando - dados salvos no PostgreSQL Neon</p>
                                <span class="text-xs text-green-600">Status: Conectado</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span data-lucide="info" style="font-size: 20px;">‚ÑπÔ∏è</span>
                            <div>
                                <h4 class="font-medium text-blue-900">üìä Sistema h√≠brido ativo</h4>
                                <p class="text-sm text-blue-700">Metas: Backend | Outros dados: LocalStorage (tempor√°rio)</p>
                                <span class="text-xs text-blue-600">Modo: Backend + Local</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-amber-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span data-lucide="alert-triangle" style="font-size: 20px;">‚ö†Ô∏è</span>
                            <div>
                                <h4 class="font-medium text-amber-900">üîß Alguns endpoints em desenvolvimento</h4>
                                <p class="text-sm text-amber-700">A√ß√µes, follow-ups e invent√°rio usam storage local at√© implementa√ß√£o no backend</p>
                                <span class="text-xs text-amber-600">Em desenvolvimento</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span data-lucide="target" style="font-size: 20px;">üéØ</span>
                            <div>
                                <h4 class="font-medium text-purple-900">üöÄ Teste: Cadastre uma nova meta!</h4>
                                <p class="text-sm text-purple-700">Suas metas ser√£o salvas diretamente no banco PostgreSQL</p>
                                <span class="text-xs text-purple-600">100% funcional</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="markAllAsRead()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Entendi</button>
            `;

            createModal("Status do Sistema", content, footer);
        }

        function markAllAsRead() {
            showToast("Todas as notifica√ß√µes foram marcadas como lidas!", "success");
            closeModal();
        }

        async function exportData() {
            try {
                showToast("Preparando exporta√ß√£o...", "info");
                
                const data = {
                    // Dados principais
                    metas,
                    actions,
                    followUps, 
                    tasks,
                    cronograma,
                    inventario,
                    
                    // Metadados da exporta√ß√£o
                    exportInfo: {
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.name,
                        totalItems: metas.length + actions.length + followUps.length + tasks.length + cronograma.length + inventario.length,
                        dataSource: {
                            metas: OFFLINE_MODE ? 'localStorage' : 'backend',
                            actions: 'localStorage',
                            followUps: 'localStorage', 
                            tasks: 'localStorage',
                            cronograma: 'localStorage',
                            inventario: 'localStorage'
                        }
                    },
                    
                    // Informa√ß√µes do sistema
                    systemInfo: {
                        version: "2.1 - Sistema H√≠brido",
                        backend: API_BASE_URL || 'N√£o configurado',
                        mode: OFFLINE_MODE ? 'offline' : 'hybrid',
                        endpointStatus: lastEndpointTest?.summary || 'N√£o testado',
                        payloadFormat: "title, program, objetivo, indicadores, status"
                    }
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `enedes_export_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                link.click();
                
                await logActivity("Dados exportados com informa√ß√µes de conectividade", "info", "download");
                showToast(`‚úÖ Dados exportados! (${data.exportInfo.totalItems} itens)`, "success");
            } catch (error) {
                showToast("Erro ao exportar dados", "error");
            }
        }

        function logout() {
            if (confirm("Tem certeza que deseja sair?")) {
                currentUser = null;
                document.getElementById("mainApp").classList.add("hidden");
                document.getElementById("loginModal").classList.remove("hidden");
                document.getElementById("userSelect").value = "";
                document.getElementById("passwordInput").value = "";
                document.getElementById("meuProgramaTab").classList.add("hidden");
                showToast("Logout realizado com sucesso!", "success");
            }
        }

        // Fun√ß√µes auxiliares para upload de arquivos
        function displaySelectedFiles(files, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-2 bg-blue-50 rounded border text-xs';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <i data-lucide="file" class="w-3 h-3 mr-2 text-blue-600"></i>
                        <span class="text-blue-800">${file.name}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500">${formatFileSize(file.size)}</span>
                        <button type="button" onclick="removeSelectedFile(${i}, '${containerId}')" class="text-red-500 hover:text-red-700">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
                container.appendChild(fileDiv);
            }
            
            createIcons();
        }

        function removeSelectedFile(index, containerId) {
            const fileInput = document.getElementById(containerId.replace('List', ''));
            if (!fileInput) return;
            
            const dt = new DataTransfer();
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            displaySelectedFiles(fileInput.files, containerId);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Fun√ß√£o para criar √≠cones com fallback para texto
        function createIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.warn('Erro ao criar √≠cones Lucide:', error);
                    implementIconFallback();
                }
            } else {
                // Implementar fallback com √≠cones de texto
                implementIconFallback();
            }
        }

        // Fallback: substituir √≠cones Lucide por s√≠mbolos de texto
        function implementIconFallback() {
            const iconMap = {
                'home': 'üè†',
                'target': 'üéØ',
                'layers': 'üìö',
                'briefcase': 'üíº',
                'bell': 'üîî',
                'log-out': 'üö™',
                'plus': '+',
                'send': 'üì§',
                'download': '‚¨áÔ∏è',
                'activity': 'üìä',
                'calendar': 'üìÖ',
                'edit-2': '‚úèÔ∏è',
                'trash-2': 'üóëÔ∏è',
                'check-circle': '‚úÖ',
                'list': 'üìù',
                'x': '‚úñÔ∏è',
                'info': '‚ÑπÔ∏è',
                'x-circle': '‚ùå',
                'alert-triangle': '‚ö†Ô∏è',
                'paperclip': 'üìé',
                'file': 'üìÑ',
                'package': 'üì¶',
                'rocket': 'üöÄ',
                'map': 'üó∫Ô∏è',
                'shopping-cart': 'üõí',
                'users': 'üë•',
                'video': 'üé•',
                'smartphone': 'üì±',
                'monitor': 'üñ•Ô∏è',
                'megaphone': 'üì¢'
            };

            // Substituir todos os √≠cones Lucide por s√≠mbolos
            document.querySelectorAll('[data-lucide]').forEach(icon => {
                const iconName = icon.getAttribute('data-lucide');
                const fallbackIcon = iconMap[iconName] || '‚Ä¢';
                icon.innerHTML = fallbackIcon;
                icon.style.fontSize = '16px';
                icon.style.display = 'inline-block';
                icon.style.textAlign = 'center';
                icon.style.lineHeight = '1';
            });
        }

        // Aguardar carregamento completo dos scripts com timeout reduzido
        function waitForScripts() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20; // 2 segundos m√°ximo
                
                const checkScripts = () => {
                    attempts++;
                    
                    if (attempts >= maxAttempts) {
                        console.log('Usando modo fallback para bibliotecas externas');
                        resolve();
                    } else {
                        setTimeout(checkScripts, 100);
                    }
                };
                checkScripts();
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Iniciando Sistema ENEDES...');
                
                // Aguardar carregamento b√°sico
                await waitForScripts();
                
                // Implementar √≠cones (com ou sem Lucide)
                createIcons();
                
                // Verificar bibliotecas carregadas
                const lucideLoaded = typeof lucide !== 'undefined';
                const chartLoaded = typeof Chart !== 'undefined';
                
                console.log(`üìä Lucide: ${lucideLoaded ? 'Carregado' : 'Usando fallback'}`);
                console.log(`üìà Chart.js: ${chartLoaded ? 'Carregado' : 'Usando fallback'}`);
                
                let statusMessage = "‚úÖ Sistema ENEDES carregado - Backend compat√≠vel!";
                if (!lucideLoaded || !chartLoaded) {
                    statusMessage = "‚úÖ Sistema ENEDES carregado - Funcional e est√°vel!";
                }
                
                showToast(statusMessage, "success");
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showToast("‚úÖ Sistema funcional - Campos corrigidos para backend!", "warning");
            }
        });
    </script>
</body>
</html>
