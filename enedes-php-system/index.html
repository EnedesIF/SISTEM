<!DOCTYPE html>
<!--
    SISTEMA ENEDES - Login Corrigido
    ================================
    
    ‚úÖ PROBLEMAS IDENTIFICADOS E CORRIGIDOS:
    1. Valida√ß√£o de senha mais robusta
    2. Tratamento de erro melhorado
    3. Feedback visual aprimorado
    4. Sele√ß√£o de usu√°rio obrigat√≥ria
    5. Estado de loading durante login
    6. Limpeza de dados anteriores
    
    üîë CREDENCIAIS DE TESTE:
    - Qualquer usu√°rio da lista + senha: "123456"
    - Sistema aceita login mesmo se backend estiver offline
-->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ENEDES - Login Corrigido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .success-message {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }
        .warning-message {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold gradient-bg bg-clip-text text-transparent">ENEDES</h1>
                <p class="text-gray-600 mt-2">Sistema de Gest√£o Completa de Projetos</p>
                <div class="mt-2 text-xs text-gray-500">
                    ‚úÖ Sistema H√≠brido: Online + Offline
                </div>
            </div>

            <!-- Mensagens de erro/sucesso -->
            <div id="loginMessages" class="mb-4 space-y-2">
                <!-- Mensagens aparecer√£o aqui -->
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                    <select id="userSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">üîΩ Escolha um usu√°rio...</option>
                        <option value="coord_geral">üëë Coordena√ß√£o Geral</option>
                        <option value="coord_projeto_area1">üìã Coordenador de Projeto - √Årea 1</option>
                        <option value="coord_projeto_area2">üìã Coordenador de Projeto - √Årea 2</option>
                        <option value="ifb_mais_empreendedor">üöÄ IFB Mais Empreendedor</option>
                        <option value="rota_empreendedora">üó∫Ô∏è Rota Empreendedora</option>
                        <option value="lab_varejo">üõí Lab Varejo</option>
                        <option value="lab_consumer">üë• Lab Consumer</option>
                        <option value="estudio">üé• Est√∫dio</option>
                        <option value="ifb_digital">üì± IFB Digital</option>
                        <option value="sala_interativa">üñ•Ô∏è Sala Interativa</option>
                        <option value="agencia_marketing">üì¢ Ag√™ncia de Marketing</option>
                    </select>
                    <div class="text-xs text-gray-500 mt-1">
                        Selecione seu perfil de acesso
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                    <input type="password" 
                           id="passwordInput" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Digite: 123456"
                           autocomplete="current-password">
                    <div class="text-xs text-gray-500 mt-1">
                        üîë Senha padr√£o: <code class="bg-gray-100 px-1 rounded">123456</code>
                    </div>
                </div>

                <button type="submit" 
                        id="loginButton"
                        class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="loginButtonText">üöÄ ENTRAR NO SISTEMA</span>
                </button>
            </form>

            <!-- Informa√ß√µes de ajuda -->
            <div class="mt-6 p-3 bg-blue-50 rounded-lg">
                <div class="text-xs text-blue-700">
                    <div class="font-medium mb-1">üí° Dicas de Login:</div>
                    <ul class="space-y-1">
                        <li>‚Ä¢ Escolha qualquer usu√°rio da lista</li>
                        <li>‚Ä¢ Use sempre a senha: <strong>123456</strong></li>
                        <li>‚Ä¢ Sistema funciona online e offline</li>
                        <li>‚Ä¢ Dados s√£o salvos automaticamente</li>
                    </ul>
                </div>
            </div>

            <!-- Status do sistema -->
            <div class="mt-4 flex items-center justify-center space-x-4 text-xs">
                <div id="connectionStatus" class="flex items-center space-x-1">
                    <div class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <span class="text-gray-600">Verificando conex√£o...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (oculto inicialmente) -->
    <div id="mainApp" class="hidden">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-teal-600">ENEDES</h1>
                        <span class="text-gray-500">Sistema Logado com Sucesso!</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <div id="userName" class="text-sm font-medium text-gray-900"></div>
                                <div id="userRole" class="text-xs text-gray-500"></div>
                            </div>
                            <button onclick="logout()" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100">
                                üö™ Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üéâ Login Realizado com Sucesso!</h2>
                <div class="space-y-3">
                    <p class="text-gray-600">Bem-vindo ao Sistema ENEDES. Seu login foi processado corretamente.</p>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-medium text-green-900 mb-2">‚úÖ Status do Sistema:</h3>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>‚Ä¢ ‚úÖ Autentica√ß√£o: Funcionando</li>
                            <li>‚Ä¢ ‚úÖ Interface: Carregada</li>
                            <li>‚Ä¢ ‚úÖ Dados: Dispon√≠veis</li>
                            <li>‚Ä¢ ‚úÖ Backend: <span id="backendStatus">Verificando...</span></li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-medium text-blue-900 mb-2">üìã Pr√≥ximos Passos:</h3>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ Integrar com o c√≥digo principal do sistema</li>
                            <li>‚Ä¢ Verificar se dados est√£o sendo salvos no backend</li>
                            <li>‚Ä¢ Testar todas as funcionalidades</li>
                            <li>‚Ä¢ Confirmar conex√£o com banco Neon</li>
                        </ul>
                    </div>
                    
                    <button onclick="testBackendConnection()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        üîß Testar Conex√£o Backend
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURA√á√ÉO E VARI√ÅVEIS GLOBAIS
        // ========================================
        
        // Configura√ß√£o do backend
        const API_BASE_URL = 'https://sistem-lk86.onrender.com';
        let OFFLINE_MODE = false;
        let currentUser = null;
        
        // Defini√ß√µes de usu√°rios
        const users = {
            coord_geral: { 
                name: "Coordena√ß√£o Geral", 
                type: "coord_geral", 
                program: null,
                description: "Acesso total ao sistema"
            },
            coord_projeto_area1: { 
                name: "Coordenador de Projeto - √Årea 1", 
                type: "coord_projeto", 
                program: null,
                description: "Gerencia projetos da √Årea 1"
            },
            coord_projeto_area2: { 
                name: "Coordenador de Projeto - √Årea 2", 
                type: "coord_projeto", 
                program: null,
                description: "Gerencia projetos da √Årea 2"
            },
            ifb_mais_empreendedor: { 
                name: "IFB Mais Empreendedor", 
                type: "coord_programa", 
                program: "ifb_mais_empreendedor",
                description: "Coordena programa de empreendedorismo"
            },
            rota_empreendedora: { 
                name: "Rota Empreendedora", 
                type: "coord_programa", 
                program: "rota_empreendedora",
                description: "Coordena capacita√ß√£o empreendedora"
            },
            lab_varejo: { 
                name: "Lab Varejo", 
                type: "coord_programa", 
                program: "lab_varejo",
                description: "Coordena laborat√≥rio de varejo"
            },
            lab_consumer: { 
                name: "Lab Consumer", 
                type: "coord_programa", 
                program: "lab_consumer",
                description: "Coordena pesquisa consumer"
            },
            estudio: { 
                name: "Est√∫dio", 
                type: "coord_programa", 
                program: "estudio",
                description: "Coordena produ√ß√£o audiovisual"
            },
            ifb_digital: { 
                name: "IFB Digital", 
                type: "coord_programa", 
                program: "ifb_digital",
                description: "Coordena transforma√ß√£o digital"
            },
            sala_interativa: { 
                name: "Sala Interativa", 
                type: "coord_programa", 
                program: "sala_interativa",
                description: "Coordena aprendizagem interativa"
            },
            agencia_marketing: { 
                name: "Ag√™ncia de Marketing", 
                type: "coord_programa", 
                program: "agencia_marketing",
                description: "Coordena estrat√©gias de marketing"
            }
        };

        // ========================================
        // FUN√á√ïES DE MENSAGENS
        // ========================================
        
        function showMessage(message, type = 'info', autoHide = true) {
            const container = document.getElementById('loginMessages');
            const messageDiv = document.createElement('div');
            
            const classes = {
                error: 'error-message',
                success: 'success-message',
                warning: 'warning-message',
                info: 'bg-blue-50 text-blue-700 border border-blue-200'
            };
            
            const icons = {
                error: '‚ùå',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            messageDiv.className = `p-3 rounded-lg ${classes[type]} fade-in`;
            messageDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${icons[type]}</span>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            if (autoHide) {
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
            
            return messageDiv;
        }
        
        function clearMessages() {
            document.getElementById('loginMessages').innerHTML = '';
        }

        // ========================================
        // FUN√á√ïES DE TESTE E CONEX√ÉO
        // ========================================
        
        async function testBackendConnection() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ Testando...';
            button.disabled = true;
            
            try {
                console.log('üîó Testando conex√£o com backend:', API_BASE_URL);
                
                const response = await fetch(`${API_BASE_URL}/api/actions.php`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Backend response:', data);
                    
                    document.getElementById('backendStatus').innerHTML = '‚úÖ Online e funcionando';
                    showMessage('Backend conectado e funcionando!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                document.getElementById('backendStatus').innerHTML = '‚ùå Offline ou com problemas';
                showMessage(`Erro de conex√£o: ${error.message}`, 'warning');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        async function checkConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            if (!API_BASE_URL) {
                OFFLINE_MODE = true;
                statusElement.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                    <span class="text-orange-600">Modo Offline</span>
                `;
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/actions.php`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: AbortSignal.timeout(5000) // 5 segundos timeout
                });
                
                if (response.ok) {
                    OFFLINE_MODE = false;
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span class="text-green-600">Online</span>
                    `;
                } else {
                    throw new Error('Backend n√£o respondeu corretamente');
                }
                
            } catch (error) {
                OFFLINE_MODE = true;
                statusElement.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                    <span class="text-orange-600">Offline</span>
                `;
                console.warn('‚ö†Ô∏è Backend indispon√≠vel, usando modo offline:', error.message);
            }
        }

        // ========================================
        // FUN√á√ïES DE LOGIN
        // ========================================
        
        function validateLoginForm() {
            const userType = document.getElementById("userSelect").value;
            const password = document.getElementById("passwordInput").value;
            
            clearMessages();
            
            if (!userType || userType === "") {
                showMessage("‚ö†Ô∏è Por favor, selecione um usu√°rio!", "error");
                document.getElementById("userSelect").focus();
                return false;
            }
            
            if (!password || password.trim() === "") {
                showMessage("‚ö†Ô∏è Por favor, digite a senha!", "error");
                document.getElementById("passwordInput").focus();
                return false;
            }
            
            if (password !== "123456") {
                showMessage("‚ùå Senha incorreta! Use: 123456", "error");
                document.getElementById("passwordInput").focus();
                document.getElementById("passwordInput").select();
                return false;
            }
            
            return true;
        }
        
        function setLoadingState(loading) {
            const button = document.getElementById("loginButton");
            const buttonText = document.getElementById("loginButtonText");
            
            if (loading) {
                button.disabled = true;
                button.classList.add("opacity-50", "cursor-not-allowed");
                buttonText.innerHTML = '<span class="loading mr-2"></span>Entrando...';
            } else {
                button.disabled = false;
                button.classList.remove("opacity-50", "cursor-not-allowed");
                buttonText.textContent = "üöÄ ENTRAR NO SISTEMA";
            }
        }
        
        async function performLogin() {
            const userType = document.getElementById("userSelect").value;
            const password = document.getElementById("passwordInput").value;
            
            try {
                // Simular um pequeno delay para melhor UX
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar se o usu√°rio existe
                if (!users[userType]) {
                    throw new Error("Tipo de usu√°rio n√£o reconhecido!");
                }
                
                // Configurar usu√°rio atual
                currentUser = {
                    ...users[userType],
                    loginTime: new Date().toISOString(),
                    sessionId: Date.now().toString(),
                    mode: OFFLINE_MODE ? 'offline' : 'online'
                };
                
                // Salvar sess√£o
                localStorage.setItem('enedes_current_user', JSON.stringify(currentUser));
                localStorage.setItem('enedes_logged_in', 'true');
                localStorage.setItem('enedes_login_time', currentUser.loginTime);
                
                console.log('‚úÖ Login realizado:', currentUser);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                throw error;
            }
        }
        
        function showMainApp() {
            // Esconder modal de login
            document.getElementById("loginModal").classList.add("hidden");
            
            // Mostrar app principal
            document.getElementById("mainApp").classList.remove("hidden");
            
            // Atualizar informa√ß√µes do usu√°rio
            document.getElementById("userName").textContent = currentUser.name;
            
            const roleText = currentUser.type === "coord_geral" ? "Coordena√ß√£o Geral" : 
                           currentUser.type === "coord_projeto" ? "Coordenador de Projeto" : 
                           "Coordenador de Programa";
            document.getElementById("userRole").textContent = roleText;
            
            // Atualizar status do backend
            setTimeout(() => {
                testBackendConnection();
            }, 1000);
        }
        
        async function login(event) {
            if (event) {
                event.preventDefault();
            }
            
            console.log('üîê Iniciando processo de login...');
            
            // Validar formul√°rio
            if (!validateLoginForm()) {
                return;
            }
            
            // Mostrar loading
            setLoadingState(true);
            
            try {
                // Realizar login
                const success = await performLogin();
                
                if (success) {
                    // Mostrar mensagem de sucesso
                    showMessage("‚úÖ Login realizado com sucesso!", "success", false);
                    
                    // Aguardar um pouco e mostrar app principal
                    setTimeout(() => {
                        showMainApp();
                    }, 1000);
                    
                    console.log('üéâ Login conclu√≠do com sucesso');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                showMessage(`‚ùå Erro ao fazer login: ${error.message}`, "error");
            } finally {
                setLoadingState(false);
            }
        }

        // ========================================
        // FUN√á√ïES DE LOGOUT E SESS√ÉO
        // ========================================
        
        function logout() {
            if (confirm("ü§î Tem certeza que deseja sair do sistema?")) {
                // Limpar dados da sess√£o
                localStorage.removeItem('enedes_current_user');
                localStorage.removeItem('enedes_logged_in');
                localStorage.removeItem('enedes_login_time');
                
                // Resetar vari√°veis
                currentUser = null;
                
                // Voltar para tela de login
                document.getElementById("mainApp").classList.add("hidden");
                document.getElementById("loginModal").classList.remove("hidden");
                
                // Limpar formul√°rio
                document.getElementById("userSelect").value = "";
                document.getElementById("passwordInput").value = "";
                clearMessages();
                
                showMessage("üëã Logout realizado com sucesso!", "success");
                console.log('üö™ Logout realizado');
            }
        }
        
        function checkExistingSession() {
            const loggedIn = localStorage.getItem('enedes_logged_in');
            const userDataStr = localStorage.getItem('enedes_current_user');
            
            if (loggedIn === 'true' && userDataStr) {
                try {
                    const userData = JSON.parse(userDataStr);
                    const loginTime = new Date(userData.loginTime);
                    const now = new Date();
                    const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                    
                    // Se login foi h√° menos de 24 horas, manter sess√£o
                    if (hoursSinceLogin < 24) {
                        currentUser = userData;
                        showMessage("üîÑ Sess√£o anterior encontrada, restaurando...", "info");
                        setTimeout(() => {
                            showMainApp();
                        }, 1000);
                        return true;
                    } else {
                        // Sess√£o expirada
                        localStorage.removeItem('enedes_current_user');
                        localStorage.removeItem('enedes_logged_in');
                        localStorage.removeItem('enedes_login_time');
                        showMessage("‚è∞ Sess√£o expirada, fa√ßa login novamente", "warning");
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar sess√£o:', error);
                    // Limpar dados corrompidos
                    localStorage.removeItem('enedes_current_user');
                    localStorage.removeItem('enedes_logged_in');
                    localStorage.removeItem('enedes_login_time');
                }
            }
            
            return false;
        }

        // ========================================
        // EVENT LISTENERS E INICIALIZA√á√ÉO
        // ========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando Sistema ENEDES Login...');
            
            try {
                // Verificar conex√£o
                await checkConnectionStatus();
                
                // Configurar event listeners
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', login);
                }
                
                // Verificar sess√£o existente
                const hasSession = checkExistingSession();
                
                if (!hasSession) {
                    showMessage("üëã Bem-vindo! Fa√ßa seu login para continuar.", "info");
                }
                
                console.log('‚úÖ Sistema de login inicializado');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showMessage("‚ö†Ô∏è Erro na inicializa√ß√£o, mas sistema funcional", "warning");
            }
        });
        
        // Permitir login com Enter
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !document.getElementById('mainApp').classList.contains('hidden') === false) {
                login(event);
            }
        });
        
        // Debug helpers (remover em produ√ß√£o)
        window.debugLogin = {
            currentUser: () => currentUser,
            forceLogin: (userType) => {
                document.getElementById("userSelect").value = userType;
                document.getElementById("passwordInput").value = "123456";
                login();
            },
            clearSession: () => {
                localStorage.removeItem('enedes_current_user');
                localStorage.removeItem('enedes_logged_in');
                localStorage.removeItem('enedes_login_time');
                console.log('üßπ Sess√£o limpa');
            }
        };
        
        console.log('üîß Debug helpers dispon√≠veis em window.debugLogin');
    </script>
</body>
</html>
