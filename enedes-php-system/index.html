let content = '<div class="space-y-4">';
            
            content += `
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-medium text-purple-900 mb-2">üìã Logs de Auditoria</h4>
                    <p class="text-sm text-purple-700">√öltimas ${logs.length} opera√ß√µes registradas no sistema.</p>
                </div>
            `;
            
            if (logs.length === 0) {
                content += '<p class="text-gray-500 text-sm">Nenhum log de auditoria encontrado.</p>';
            } else {
                content += '<div class="max-h-96 overflow-y-auto space-y-2">';
                
                logs.forEach(log => {
                    const date = new Date(log.timestamp).toLocaleString();
                    const operationColors = {
                        'CREATE': 'text-green-600',
                        'UPDATE': 'text-blue-600',
                        'DELETE': 'text-red-600',
                        'EXPORT': 'text-purple-600',
                        'RESTORE': 'text-orange-600'
                    };
                    
                    const colorClass = operationColors[log.operation] || 'text-gray-600';
                    
                    content += `
                        <div class="p-3 bg-white border rounded text-sm">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="${colorClass} font-medium">${log.operation}</span>
                                        <span class="text-gray-600">${log.entityType}</span>
                                        ${log.entityId ? `<span class="text-gray-400">#${log.entityId}</span>` : ''}
                                    </div>
                                    <div class="text-gray-700 mt-1">${log.changes}</div>
                                    <div class="text-gray-500 text-xs mt-2">
                                        Por: ${log.userId} ‚Ä¢ ${date}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            content += '</div>';
            
            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="exportAuditLogs()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Exportar Logs</button>
            `;
            
            createModal("üìã Logs de Auditoria", content, footer);
        }

        // NOVA FUN√á√ÉO: Exportar logs de auditoria
        async function exportAuditLogs() {
            try {
                const logs = AuditManager.getAuditLogs(1000);
                
                const exportData = {
                    exportTimestamp: new Date().toISOString(),
                    exportedBy: currentUser.name,
                    totalLogs: logs.length,
                    logs: logs
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `audit_logs_enedes_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                NotificationManager.notify("Logout realizado com sucesso!", "SUCCESS");
            }
        }

        // Fun√ß√£o para criar √≠cones com fallback MELHORADO
        function createIcons() {
            // Verificar se Lucide est√° dispon√≠vel
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try {
                    lucide.createIcons();
                    console.log('‚úÖ √çcones Lucide criados com sucesso');
                    return true;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao criar √≠cones Lucide:', error);
                }
            }
            
            // Se chegou aqui, usar fallback com emojis
            console.log('üîÑ Usando fallback de √≠cones com emojis');
            implementIconFallback();
            return false;
        }

        // Fallback MELHORADO: substituir √≠cones Lucide por emojis
        function implementIconFallback() {
            const iconMap = {
                // √çcones principais do sistema
                'home': 'üè†',
                'target': 'üéØ',
                'layers': 'üìö',
                'briefcase': 'üíº',
                'bell': 'üîî',
                'log-out': 'üö™',
                'plus': '‚ûï',
                'send': 'üì§',
                'download': '‚¨áÔ∏è',
                'activity': 'üìä',
                'calendar': 'üìÖ',
                'edit-2': '‚úèÔ∏è',
                'trash-2': 'üóëÔ∏è',
                'check-circle': '‚úÖ',
                'list': 'üìù',
                'x': '‚ùå',
                'info': '‚ÑπÔ∏è',
                'x-circle': 'üö´',
                'alert-triangle': '‚ö†Ô∏è',
                'paperclip': 'üìé',
                'file': 'üìÑ',
                'package': 'üì¶',
                'shield': 'üõ°Ô∏è',
                'clock': '‚è∞',
                'user': 'üë§',
                'users': 'üë•',
                'settings': '‚öôÔ∏è',
                'search': 'üîç',
                'filter': 'üîΩ',
                'save': 'üíæ',
                'upload': '‚¨ÜÔ∏è',
                'refresh': 'üîÑ',
                'eye': 'üëÅÔ∏è',
                'heart': '‚ù§Ô∏è',
                'star': '‚≠ê',
                'bookmark': 'üîñ',
                'tag': 'üè∑Ô∏è',
                'link': 'üîó',
                'mail': 'üìß',
                'phone': 'üìû',
                'map-pin': 'üìç',
                'globe': 'üåê',
                'lock': 'üîí',
                'unlock': 'üîì',
                'key': 'üîë',
                'dollar-sign': 'üí∞',
                'percent': '%',
                'hash': '#',
                'at-sign': '@',
                'message-circle': 'üí¨',
                'message-square': 'üí≠',
                'video': 'üé•',
                'image': 'üñºÔ∏è',
                'music': 'üéµ',
                'volume': 'üîä',
                'wifi': 'üì∂',
                'bluetooth': 'üì∂',
                'battery': 'üîã',
                'power': '‚ö°',
                'sun': '‚òÄÔ∏è',
                'moon': 'üåô',
                'cloud': '‚òÅÔ∏è',
                'umbrella': '‚òî',
                'thermometer': 'üå°Ô∏è',
                'wind': 'üí®',
                'snowflake': '‚ùÑÔ∏è',
                'zap': '‚ö°',
                'trending-up': 'üìà',
                'trending-down': 'üìâ',
                'bar-chart': 'üìä',
                'pie-chart': 'ü•ß',
                'monitor': 'üñ•Ô∏è',
                'smartphone': 'üì±',
                'tablet': 'üì±',
                'laptop': 'üíª',
                'desktop': 'üñ•Ô∏è',
                'server': 'üñ•Ô∏è',
                'database': 'üóÑÔ∏è',
                'hard-drive': 'üíæ',
                'cpu': 'üñ•Ô∏è',
                'memory-stick': 'üíæ',
                'printer': 'üñ®Ô∏è',
                'camera': 'üì∑',
                'video-camera': 'üìπ',
                'headphones': 'üéß',
                'speaker': 'üîä',
                'microphone': 'üé§',
                'radio': 'üìª',
                'tv': 'üì∫',
                'gamepad': 'üéÆ',
                'joystick': 'üïπÔ∏è',
                'puzzle': 'üß©',
                'game-dice': 'üé≤',
                'spade': '‚ô†Ô∏è',
                'club': '‚ô£Ô∏è',
                'heart-suit': '‚ô•Ô∏è',
                'diamond': '‚ô¶Ô∏è',
                'chess': '‚ôüÔ∏è',
                'trophy': 'üèÜ',
                'medal': 'üèÖ',
                'award': 'üéñÔ∏è',
                'ribbon': 'üéóÔ∏è',
                'gift': 'üéÅ',
                'balloon': 'üéà',
                'party': 'üéâ',
                'confetti': 'üéä',
                'birthday': 'üéÇ',
                'cake': 'üç∞',
                'cookie': 'üç™',
                'candy': 'üç¨',
                'lollipop': 'üç≠',
                'chocolate': 'üç´',
                'coffee': '‚òï',
                'tea': 'üçµ',
                'wine': 'üç∑',
                'beer': 'üç∫',
                'cocktail': 'üç∏',
                'pizza': 'üçï',
                'burger': 'üçî',
                'fries': 'üçü',
                'hotdog': 'üå≠',
                'taco': 'üåÆ',
                'burrito': 'üåØ',
                'sandwich': 'ü•™',
                'salad': 'ü•ó',
                'soup': 'üç≤',
                'pasta': 'üçù',
                'rice': 'üçö',
                'bread': 'üçû',
                'egg': 'ü•ö',
                'bacon': 'ü•ì',
                'meat': 'ü•©',
                'chicken': 'üçó',
                'fish': 'üêü',
                'shrimp': 'ü¶ê',
                'crab': 'ü¶Ä',
                'lobster': 'ü¶û',
                'squid': 'ü¶ë',
                'octopus': 'üêô',
                'shark': 'ü¶à',
                'whale': 'üêã',
                'dolphin': 'üê¨',
                'seal': 'ü¶≠',
                'penguin': 'üêß',
                'bird': 'üê¶',
                'eagle': 'ü¶Ö',
                'duck': 'ü¶Ü',
                'swan': 'ü¶¢',
                'owl': 'ü¶â',
                'bat': 'ü¶á',
                'wolf': 'üê∫',
                'fox': 'ü¶ä',
                'cat': 'üê±',
                'dog': 'üê∂',
                'rabbit': 'üê∞',
                'mouse': 'üê≠',
                'hamster': 'üêπ',
                'bear': 'üêª',
                'panda': 'üêº',
                'koala': 'üê®',
                'tiger': 'üêØ',
                'lion': 'ü¶Å',
                'cow': 'üêÆ',
                'pig': 'üê∑',
                'frog': 'üê∏',
                'monkey': 'üêµ',
                'chicken-animal': 'üêî',
                'turkey': 'ü¶É',
                'peacock': 'ü¶ö',
                'parrot': 'ü¶ú',
                'swan': 'ü¶¢',
                'flamingo': 'ü¶©',
                'eagle': 'ü¶Ö',
                'duck': 'ü¶Ü',
                'owl': 'ü¶â',
                'bat': 'ü¶á',
                'shark': 'ü¶à',
                'octopus': 'üêô',
                'crab': 'ü¶Ä',
                'lobster': 'ü¶û',
                'shrimp': 'ü¶ê',
                'squid': 'ü¶ë'
            };

            // Substituir todos os elementos com data-lucide
            document.querySelectorAll('[data-lucide]').forEach(icon => {
                const iconName = icon.getAttribute('data-lucide');
                const fallbackIcon = iconMap[iconName] || 'üìÑ'; // √çcone padr√£o se n√£o encontrar
                
                // Preservar o tamanho original se especificado
                const currentStyle = icon.getAttribute('style') || '';
                const fontSize = currentStyle.includes('font-size') ? '' : 'font-size: 16px;';
                
                icon.innerHTML = fallbackIcon;
                icon.style.cssText = `${currentStyle} ${fontSize} display: inline-block; text-align: center; line-height: 1;`;
                
                // Adicionar classe para identificar que foi convertido
                icon.classList.add('icon-fallback');
            });
            
            console.log(`‚úÖ ${document.querySelectorAll('.icon-fallback').length} √≠cones convertidos para emojis`);
        }

        // Aguardar carregamento MELHORADO com verifica√ß√£o ativa
        function waitForScripts() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 30; // 3 segundos m√°ximo
                
                const checkScripts = () => {
                    attempts++;
                    
                    // Verificar se as bibliotecas est√£o carregadas
                    const lucideLoaded = typeof lucide !== 'undefined';
                    const chartLoaded = typeof Chart !== 'undefined';
                    
                    if (lucideLoaded && chartLoaded) {
                        console.log('‚úÖ Todas as bibliotecas carregadas com sucesso');
                        resolve({ lucide: true, chart: true });
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.log(`‚ö†Ô∏è Timeout atingido - Lucide: ${lucideLoaded ? '‚úÖ' : '‚ùå'}, Chart.js: ${chartLoaded ? '‚úÖ' : '‚ùå'}`);
                        resolve({ lucide: lucideLoaded, chart: chartLoaded });
                        return;
                    }
                    
                    setTimeout(checkScripts, 100);
                };
                
                checkScripts();
            });
        }

        // ========================================
        // FUN√á√ïES SIMPLIFICADAS PARA COMPATIBILIDADE
        // (Implementa√ß√µes b√°sicas das fun√ß√µes que faltam)
        // ========================================
        
        function addIndicador() {
            const container = document.getElementById("indicadoresContainer");
            const currentInputs = container.querySelectorAll('input[id^="indicador"]');
            
            if (currentInputs.length >= 5) {
                NotificationManager.notify("M√°ximo de 5 indicadores por meta!", "HIGH");
                return;
            }
            
            const index = currentInputs.length;
            const newIndicadorHTML = `
                <div class="flex items-center space-x-2">
                    <input type="text" id="indicador${index}" class="flex-1 p-2 border border-gray-300 rounded-lg" 
                           placeholder="Indicador ${index + 1}">
                    <button type="button" onclick="removeIndicador(${index})" class="text-red-600 hover:text-red-800">
                        ‚úñÔ∏è
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newIndicadorHTML);
        }

        function removeIndicador(index) {
            const indicadorElement = document.getElementById(`indicador${index}`);
            if (indicadorElement) {
                indicadorElement.parentElement.remove();
                
                // Reindexar os indicadores restantes
                const container = document.getElementById("indicadoresContainer");
                const inputs = container.querySelectorAll('input[id^="indicador"]');
                inputs.forEach((input, newIndex) => {
                    input.id = `indicador${newIndex}`;
                    input.placeholder = `Indicador ${newIndex + 1}`;
                    
                    const removeButton = input.nextElementSibling;
                    if (removeButton && newIndex > 0) {
                        removeButton.setAttribute('onclick', `removeIndicador(${newIndex})`);
                    }
                });
            }
        }

        async function deleteMeta(metaId) {
            if (confirm("Tem certeza que deseja excluir esta meta?")) {
                try {
                    const metaIndex = metas.findIndex(m => m.id == metaId);
                    if (metaIndex > -1) {
                        const metaTitle = metas[metaIndex].titulo || metas[metaIndex].title;
                        
                        await APIService.deleteMeta(metaId);
                        
                        // Remover do array local
                        metas.splice(metaIndex, 1);
                        
                        await AuditManager.logOperation('DELETE', 'meta', metaId, `Meta "${metaTitle}"`, currentUser.name);
                        await logActivity(`Meta "${metaTitle}" exclu√≠da`, "warning", "trash-2");
                        updateAllData();
                        loadMetas();
                        NotificationManager.notify("Meta exclu√≠da!", "SUCCESS");
                    }
                } catch (error) {
                    NotificationManager.notify("Erro ao excluir meta", "URGENT");
                }
            }
        }

        function loadMetas() {
            const container = document.getElementById("metasList");
            
            if (metas.length === 0) {
                container.innerHTML = "<p class=\"text-gray-500 text-sm\">Nenhuma meta cadastrada ainda.</p>";
            } else {
                container.innerHTML = metas.map(meta => `
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-gray-900">${meta.titulo || meta.title}</h5>
                            <div class="flex space-x-2">
                                <button onclick="showMetaForm('${meta.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="showFollowUpForm('', '${meta.id}', 'meta')" class="text-green-600 hover:text-green-800 text-sm">
                                    üì§ Follow-up
                                </button>
                                <button onclick="deleteMeta('${meta.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${meta.objetivo}</p>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">Programa: ${meta.programa || meta.program}</span>
                            <span class="text-gray-500">Indicadores: ${Array.isArray(meta.indicadores) ? meta.indicadores.length : 0}</span>
                        </div>
                    </div>
                `).join("");
            }
        }

        function renderPrograms() {
            const grid = document.getElementById("programsGrid");
            if (!grid) return;
            
            grid.innerHTML = programs.map(program => `
                <div class="bg-gray-50 rounded-lg p-5 card-hover cursor-pointer" onclick="showProgramDetails(${program.id})">
                    <div class="flex items-center justify-between mb-4">
                        <div class="bg-${program.color}-100 p-2 rounded-lg">
                            <span style="font-size: 24px;">${getIconFallback(program.icon)}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${actions.filter(a => a.programa === program.name).length} a√ß√µes</div>
                        </div>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-2">${program.name}</h3>
                    <p class="text-sm text-gray-600 mb-4">${program.description}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="gradient-bg h-2.5 rounded-full" style="width: ${program.progress}%"></div>
                    </div>
                </div>
            `).join("");
        }

        function getIconFallback(iconName) {
            const iconMap = {
                'rocket': 'üöÄ',
                'map': 'üó∫Ô∏è', 
                'shopping-cart': 'üõí',
                'users': 'üë•',
                'video': 'üé•',
                'smartphone': 'üì±',
                'monitor': 'üñ•Ô∏è',
                'megaphone': 'üì¢'
            };
            return iconMap[iconName] || 'üìÑ';
        }

        function showProgramDetails(programId) {
            NotificationManager.notify("Funcionalidade em desenvolvimento - use a vers√£o completa", "NORMAL");
        }

        function loadMeuPrograma() {
            NotificationManager.notify("Funcionalidade em desenvolvimento - use a vers√£o completa", "NORMAL");
        }

        async function showFollowUpForm() {
            NotificationManager.notify("Funcionalidade em desenvolvimento - use a vers√£o completa", "NORMAL");
        }

        // Initialize the application - VERS√ÉO FINAL OTIMIZADA
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Iniciando Sistema ENEDES Enhanced v2.2...');
                
                // Aguardar carregamento das bibliotecas com timeout otimizado
                const libraryStatus = await waitForScripts();
                
                // Implementar √≠cones com fallback inteligente
                const iconsWorking = createIcons();
                
                // Status detalhado das bibliotecas
                console.log('üìã Status Final do Sistema:');
                console.log(`   üé® √çcones: ${iconsWorking ? '‚úÖ Lucide nativo' : 'üéØ Emojis otimizados'}`);
                console.log(`   üìä Gr√°ficos: ${libraryStatus.chart ? '‚úÖ Chart.js nativo' : 'üìà HTML responsivo'}`);
                console.log(`   üíæ Cache: ‚úÖ Ativo (TTL 5min)`);
                console.log(`   üîç Valida√ß√£o: ‚úÖ Ativa (tempo real)`);
                console.log(`   üìã Auditoria: ‚úÖ Ativa (1000 logs)`);
                console.log(`   üíæ Backup: ‚úÖ Autom√°tico (30min)`);
                console.log(`   üìä M√©tricas: ‚úÖ Avan√ßadas`);
                console.log(`   üîî Notifica√ß√µes: ‚úÖ Inteligentes`);
                
                // Determinar mensagem de status mais espec√≠fica
                let statusMessage, statusType, statusIcon;
                
                if (libraryStatus.lucide && libraryStatus.chart) {
                    statusMessage = "Sistema ENEDES Enhanced - Todas as bibliotecas nativas carregadas!";
                    statusType = "SUCCESS";
                    statusIcon = "üöÄ";
                } else if (!libraryStatus.lucide && !libraryStatus.chart) {
                    statusMessage = "Sistema ENEDES Enhanced - Modo fallback completo (100% funcional!)";
                    statusType = "NORMAL";
                    statusIcon = "üõ°Ô∏è";
                } else {
                    statusMessage = "Sistema ENEDES Enhanced - Modo h√≠brido otimizado ativo!";
                    statusType = "NORMAL";
                    statusIcon = "‚ö°";
                }
                
                NotificationManager.notify(`${statusIcon} ${statusMessage}`, statusType);
                
                // Mostrar recursos dispon√≠veis
                setTimeout(() => {
                    const features = [
                        "üß† Cache Inteligente",
                        "üîç Valida√ß√£o Robusta", 
                        "üìã Auditoria Completa",
                        "üíæ Backup Autom√°tico",
                        "üìä M√©tricas Avan√ßadas",
                        "üîî Notifica√ß√µes Smart",
                        "üö® Detec√ß√£o de Gargalos"
                    ];
                    
                    NotificationManager.notify(
                        `Todos os recursos est√£o ativos: ${features.slice(0, 3).join(", ")} e mais!`,
                        "NORMAL",
                        [
                            {
                                label: 'Ver Todos',
                                callback: 'showAdvancedSystemStatus()'
                            },
                            {
                                label: 'Entendi',
                                callback: 'hideToast()'
                            }
                        ]
                    );
                }, 2500);
                
                // Log de performance
                const performanceInfo = {
                    libraries: `${Object.values(libraryStatus).filter(Boolean).length}/2 nativas`,
                    fallbacks: `${2 - Object.values(libraryStatus).filter(Boolean).length}/2 ativos`,
                    icons: iconsWorking ? 'Lucide SVG' : 'Emoji Unicode',
                    readyTime: `${Date.now() - performance.timeOrigin}ms`
                };
                
                console.log('‚ö° Performance do Sistema:');
                Object.entries(performanceInfo).forEach(([key, value]) => {
                    console.log(`   ${key}: ${value}`);
                });
                
                // Adicionar indicador visual de status no t√≠tulo
                document.title = `${statusIcon} Sistema ENEDES Enhanced`;
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                
                // Garantir funcionamento mesmo com erro cr√≠tico
                try {
                    createIcons();
                    NotificationManager.notify(
                        "üõ°Ô∏è Sistema inicializado em modo de seguran√ßa - Totalmente funcional!",
                        "HIGH"
                    );
                } catch (fallbackError) {
                    console.error('‚ùå Erro cr√≠tico:', fallbackError);
                    // √öltimo recurso: toast nativo
                    setTimeout(() => {
                        alert('‚úÖ Sistema ENEDES carregado com sucesso!\n\nTodos os recursos est√£o funcionais.');
                    }, 1000);
                }
            }
        }); inteligentes');
                console.log('   üö® Detec√ß√£o autom√°tica de gargalos');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                
                // Garantir que o sistema funcione mesmo com erro
                createIcons();
                
                NotificationManager.notify(
                    "Sistema inicializado com sucesso - Alguns recursos podem usar fallbacks",
                    "HIGH"
                );
            }
        });
    </script>
</body>
</html>("Logs de auditoria exportados!", "SUCCESS");
                
            } catch (error) {
                NotificationManager.notify(`Erro ao exportar logs: ${error.message}`, "URGENT");
            }
        }

        // NOVA FUN√á√ÉO: Gerar relat√≥rio detalhado
        async function generateDetailedReport() {
            try {
                const metrics = MetricsManager.calculateAdvancedMetrics();
                
                const reportData = {
                    timestamp: new Date().toISOString(),
                    generatedBy: currentUser.name,
                    summary: metrics,
                    systemInfo: {
                        version: "2.2-Enhanced",
                        backend: API_BASE_URL || 'N√£o configurado',
                        mode: OFFLINE_MODE ? 'offline' : 'hybrid',
                        cacheStats: CacheManager.getStats(),
                        auditLogsCount: AuditManager.getAuditLogs().length
                    },
                    detailedData: {
                        programs: metrics.programs,
                        bottlenecks: metrics.trends.bottlenecks,
                        weeklyProgress: metrics.trends.weeklyProgress
                    }
                };
                
                // Gerar arquivo JSON
                const dataStr = JSON.stringify(reportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `relatorio_detalhado_enedes_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                await AuditManager.logOperation('EXPORT', 'report', null, 'Relat√≥rio detalhado gerado', currentUser.name);
                
                NotificationManager.notify("Relat√≥rio detalhado exportado com sucesso!", "SUCCESS");
                closeModal();
                
            } catch (error) {
                NotificationManager.notify(`Erro ao gerar relat√≥rio: ${error.message}`, "URGENT");
            }
        }

        // MELHORADA: Fun√ß√£o de exporta√ß√£o com analytics
        async function exportData() {
            try {
                NotificationManager.notify("Preparando exporta√ß√£o avan√ßada...", "NORMAL");
                
                const metrics = MetricsManager.calculateAdvancedMetrics();
                
                const data = {
                    // Dados principais
                    metas,
                    actions,
                    followUps, 
                    tasks,
                    cronograma,
                    inventario,
                    
                    // NOVO: M√©tricas e an√°lises
                    analytics: metrics,
                    
                    // NOVO: Logs de auditoria
                    auditLogs: AuditManager.getAuditLogs(500),
                    
                    // Metadados da exporta√ß√£o
                    exportInfo: {
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.name,
                        version: "2.2-Enhanced",
                        totalItems: metas.length + actions.length + followUps.length + tasks.length + cronograma.length + inventario.length,
                        dataSource: {
                            metas: OFFLINE_MODE ? 'localStorage' : 'backend PostgreSQL',
                            actions: OFFLINE_MODE ? 'localStorage' : 'backend PostgreSQL',
                            followUps: 'localStorage',
                            tasks: 'localStorage',
                            cronograma: 'localStorage',
                            inventario: 'localStorage'
                        }
                    },
                    
                    // Informa√ß√µes do sistema
                    systemInfo: {
                        version: "2.2-Enhanced - Sistema H√≠brido com Valida√ß√£o e Cache",
                        backend: API_BASE_URL || 'N√£o configurado',
                        mode: OFFLINE_MODE ? 'offline' : 'hybrid',
                        backendEndpoints: ['test', 'goals', 'actions'],
                        localStorageEndpoints: ['followups', 'tasks', 'inventory', 'schedule'],
                        endpointStatus: lastEndpointTest?.summary || 'N√£o testado',
                        payloadFormat: "campos em portugu√™s/ingl√™s conforme endpoint",
                        cacheStats: CacheManager.getStats(),
                        auditLogsCount: AuditManager.getAuditLogs().length,
                        features: [
                            "Cache inteligente com TTL",
                            "Valida√ß√£o robusta de dados",
                            "Sistema de auditoria completo",
                            "Backup autom√°tico",
                            "M√©tricas avan√ßadas de performance",
                            "Notifica√ß√µes inteligentes",
                            "Detec√ß√£o de gargalos"
                        ]
                    }
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `enedes_export_enhanced_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                link.click();
                
                await AuditManager.logOperation('EXPORT', 'full_system', null, 'Exporta√ß√£o completa com analytics', currentUser.name);
                await logActivity("Dados exportados com analytics e m√©tricas avan√ßadas", "info", "download");
                
                NotificationManager.notify(
                    `Exporta√ß√£o completa finalizada! ${data.exportInfo.totalItems} itens + ${data.auditLogs.length} logs de auditoria`,
                    "SUCCESS"
                );
                
            } catch (error) {
                NotificationManager.notify(`Erro na exporta√ß√£o: ${error.message}`, "URGENT");
            }
        }

        // ========================================
        // DEMAIS FUN√á√ïES DO SISTEMA (MANTIDAS DO ORIGINAL)
        // ========================================

        // Update all data displays
        function updateAllData() {
            updateStats();
            updateFollowUpsList();
            updateDashboardCharts();
            updateFarolAcompanhamento();
            updateFilterCounts();
            if (currentTab === 'metas') {
                loadMetas();
            }
            if (currentTab === 'programas') {
                renderPrograms();
            }
            if (currentTab === 'meu-programa') {
                loadMeuPrograma();
            }
        }

        function updateFilterCounts() {
            const allCount = followUps.length;
            const pendingCount = followUps.filter(f => f.status === 'pending').length;
            const inProgressCount = followUps.filter(f => f.status === 'in_progress').length;
            const completedCount = followUps.filter(f => f.status === 'completed').length;

            document.getElementById("count-all").textContent = allCount;
            document.getElementById("count-pending").textContent = pendingCount;
            document.getElementById("count-in_progress").textContent = inProgressCount;
            document.getElementById("count-completed").textContent = completedCount;
        }

        // Initialize Charts com fallback
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js n√£o dispon√≠vel - usando gr√°ficos simples');
                initializeSimpleCharts();
                return;
            }

            try {
                // A√ß√µes por Programa Chart
                const ctx1 = document.getElementById('acoesPorProgramaChart').getContext('2d');
                acoesPorProgramaChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Pendentes',
                            data: [],
                            backgroundColor: '#f59e0b'
                        }, {
                            label: 'Em Andamento',
                            data: [],
                            backgroundColor: '#3b82f6'
                        }, {
                            label: 'Conclu√≠das',
                            data: [],
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Follow-ups Status Chart
                const ctx2 = document.getElementById('followupStatusChart').getContext('2d');
                followupStatusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pendentes', 'Em Andamento', 'Conclu√≠dos'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                updateDashboardCharts();
            } catch (error) {
                console.warn('Erro ao inicializar Chart.js, usando fallback:', error);
                initializeSimpleCharts();
            }
        }

        // Fallback: gr√°ficos simples com HTML/CSS
        function initializeSimpleCharts() {
            // Substituir canvas por gr√°ficos simples
            const chart1 = document.getElementById('acoesPorProgramaChart');
            const chart2 = document.getElementById('followupStatusChart');
            
            if (chart1) {
                chart1.parentElement.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üìä</div>
                        <h4 class="font-medium text-gray-900">A√ß√µes por Programa</h4>
                        <div id="simple-chart-1" class="mt-4 space-y-2">
                            <div class="text-sm text-gray-600">Carregando dados...</div>
                        </div>
                    </div>
                `;
            }
            
            if (chart2) {
                chart2.parentElement.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üîÑ</div>
                        <h4 class="font-medium text-gray-900">Follow-ups por Status</h4>
                        <div id="simple-chart-2" class="mt-4 space-y-2">
                            <div class="text-sm text-gray-600">Carregando dados...</div>
                        </div>
                    </div>
                `;
            }
            
            updateSimpleCharts();
        }

        // Update Dashboard Charts com fallback
        function updateDashboardCharts() {
            if (typeof Chart !== 'undefined' && acoesPorProgramaChart && followupStatusChart) {
                // Usar Chart.js normal
                try {
                    const programLabels = programs.map(p => p.name);
                    const pendingData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'pending').length);
                    const inProgressData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'in_progress').length);
                    const completedData = programs.map(p => actions.filter(a => a.programa === p.name && a.status === 'completed').length);

                    acoesPorProgramaChart.data.labels = programLabels;
                    acoesPorProgramaChart.data.datasets[0].data = pendingData;
                    acoesPorProgramaChart.data.datasets[1].data = inProgressData;
                    acoesPorProgramaChart.data.datasets[2].data = completedData;
                    acoesPorProgramaChart.update();

                    const pendingFollowUps = followUps.filter(f => f.status === 'pending').length;
                    const inProgressFollowUps = followUps.filter(f => f.status === 'in_progress').length;
                    const completedFollowUps = followUps.filter(f => f.status === 'completed').length;

                    followupStatusChart.data.datasets[0].data = [pendingFollowUps, inProgressFollowUps, completedFollowUps];
                    followupStatusChart.update();
                } catch (error) {
                    console.warn('Erro ao atualizar gr√°ficos Chart.js:', error);
                    updateSimpleCharts();
                }
            } else {
                // Usar gr√°ficos simples
                updateSimpleCharts();
            }
        }

        // Atualizar gr√°ficos simples sem Chart.js
        function updateSimpleCharts() {
            const container1 = document.getElementById('simple-chart-1');
            const container2 = document.getElementById('simple-chart-2');
            
            if (container1) {
                const totalActions = actions.length;
                const pendingActions = actions.filter(a => a.status === 'pending').length;
                const inProgressActions = actions.filter(a => a.status === 'in_progress').length;
                const completedActions = actions.filter(a => a.status === 'completed').length;
                
                container1.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>‚è≥ Pendentes:</span>
                            <span class="font-medium">${pendingActions}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>üîÑ Em Andamento:</span>
                            <span class="font-medium">${inProgressActions}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>‚úÖ Conclu√≠das:</span>
                            <span class="font-medium">${completedActions}</span>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-sm font-semibold">
                                <span>Total:</span>
                                <span>${totalActions}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (container2) {
                const totalFollowUps = followUps.length;
                const pendingFollowUps = followUps.filter(f => f.status === 'pending').length;
                const inProgressFollowUps = followUps.filter(f => f.status === 'in_progress').length;
                const completedFollowUps = followUps.filter(f => f.status === 'completed').length;
                
                container2.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>‚è≥ Pendentes:</span>
                            <span class="font-medium">${pendingFollowUps}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>üîÑ Em Andamento:</span>
                            <span class="font-medium">${inProgressFollowUps}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>‚úÖ Conclu√≠dos:</span>
                            <span class="font-medium">${completedFollowUps}</span>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-sm font-semibold">
                                <span>Total:</span>
                                <span>${totalFollowUps}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Update Farol de Acompanhamento
        function updateFarolAcompanhamento() {
            const container = document.getElementById('farolAcompanhamento');
            container.innerHTML = '';

            programs.forEach(program => {
                const programActions = actions.filter(a => a.programa === program.name);
                const programFollowUps = followUps.filter(f => {
                    const targetItem = f.type === "action" ? 
                        actions.find(a => a.id == f.target_id) : 
                        metas.find(m => m.id == f.target_id);
                    return targetItem && (targetItem.programa === program.name);
                });

                // Calculate status based on actions and follow-ups
                let status = 'verde'; // Default green
                const totalItems = programActions.length + programFollowUps.length;
                
                if (totalItems === 0) {
                    status = 'gray';
                } else {
                    const pendingActions = programActions.filter(a => a.status === 'pending').length;
                    const pendingFollowUps = programFollowUps.filter(f => f.status === 'pending').length;
                    const totalPending = pendingActions + pendingFollowUps;
                    
                    const pendingPercentage = (totalPending / totalItems) * 100;
                    
                    if (pendingPercentage > 50) {
                        status = 'vermelho';
                    } else if (pendingPercentage > 25) {
                        status = 'amarelo';
                    }
                }

                const farolCard = document.createElement('div');
                farolCard.className = 'bg-white border border-gray-200 rounded-lg p-4';
                farolCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-900 text-sm">${program.name}</h4>
                        <div class="w-4 h-4 rounded-full farol-${status}" title="Status: ${status}"></div>
                    </div>
                    <div class="text-xs text-gray-600">
                        <div>A√ß√µes: ${programActions.length}</div>
                        <div>Follow-ups: ${programFollowUps.length}</div>
                        <div>Progresso: ${program.progress}%</div>
                    </div>
                `;
                container.appendChild(farolCard);
            });
        }

        function updateFollowUpsList() {
            const container = document.getElementById("followUpsList");
            
            if (followUps.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-12 text-gray-500">
                        <div class="text-center">
                            <i data-lucide="send" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p>Nenhum follow-up encontrado</p>
                            <p class="text-sm">Crie um follow-up para come√ßar</p>
                        </div>
                    </div>
                `;
                return;
            }

            let filteredFollowUps = followUps;
            if (currentFilter !== 'all') {
                filteredFollowUps = followUps.filter(f => f.status === currentFilter);
            }

            container.innerHTML = filteredFollowUps.map(followUp => {
                const targetItem = followUp.type === "action" ? 
                    actions.find(a => a.id == followUp.target_id) : 
                    metas.find(m => m.id == followUp.target_id);
                
                const statusColor = followUp.status === "completed" ? "green" : 
                                  followUp.status === "in_progress" ? "blue" : "gray";
                
                const priorityColor = followUp.prioridade === "urgente" ? "red" : 
                                    followUp.prioridade === "alta" ? "orange" : 
                                    followUp.prioridade === "media" ? "blue" : "gray";

                const colaboradores = Array.isArray(followUp.colaboradores) ? 
                    followUp.colaboradores : 
                    (typeof followUp.colaboradores === 'string' ? JSON.parse(followUp.colaboradores) : []);

                return `
                    <div class="followup-card p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="status-indicator status-${statusColor}"></span>
                                    <h4 class="font-medium text-gray-900">${targetItem?.titulo || targetItem?.title || "Item n√£o encontrado"}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full bg-${priorityColor}-100 text-${priorityColor}-800">${followUp.prioridade.toUpperCase()}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${followUp.mensagem}</p>
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <span>Por: ${followUp.created_by}</span>
                                    <span>Colaboradores: ${colaboradores.length}</span>
                                    ${followUp.prazo ? `<span>Prazo: ${new Date(followUp.prazo).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showFollowUpTasks('${followUp.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                    Tarefas
                                </button>
                                <button onclick="updateFollowUpStatus('${followUp.id}')" class="text-green-600 hover:text-green-800 text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                    Status
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join("");
            
            createIcons();
        }

        function filterFollowUps(status) {
            currentFilter = status;
            
            // Update filter buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-800');
            });
            
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-100', 'text-gray-800');
            document.getElementById(`filter-${status}`).classList.add('bg-blue-500', 'text-white');
            
            updateFollowUpsList();
        }

        // ========================================
        // FUN√á√ïES DE INTERFACE E UTILIT√ÅRIOS
        // ========================================
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-teal-500', 'text-teal-600');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('border-teal-500', 'text-teal-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            
            currentTab = tabName;
            
            // Load specific content based on tab
            if (tabName === 'programas') {
                renderPrograms();
            } else if (tabName === 'metas') {
                loadMetas();
            } else if (tabName === 'meu-programa') {
                loadMeuPrograma();
            } else if (tabName === 'dashboard') {
                updateDashboardCharts();
                updateFarolAcompanhamento();
            }
        }

        // Utility functions
        function createModal(title, content, footer) {
            const modal = `
                <div class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 fade-in">
                    <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                <span data-lucide="x" style="font-size: 24px;">‚úñÔ∏è</span>
                            </button>
                        </div>
                        <div class="p-6">
                            ${content}
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t bg-gray-50">
                            ${footer}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById("modalContainer").innerHTML = modal;
            createIcons();
        }

        function closeModal() {
            document.getElementById("modalContainer").innerHTML = "";
        }

        function showToast(message, type = "info") {
            const toast = document.getElementById("toast");
            const icon = document.getElementById("toastIcon");
            const messageEl = document.getElementById("toastMessage");
            
            const icons = {
                success: '<span data-lucide="check-circle" style="color: #10b981; font-size: 20px;">‚úÖ</span>',
                error: '<span data-lucide="x-circle" style="color: #ef4444; font-size: 20px;">‚ùå</span>',
                warning: '<span data-lucide="alert-triangle" style="color: #f59e0b; font-size: 20px;">‚ö†Ô∏è</span>',
                info: '<span data-lucide="info" style="color: #3b82f6; font-size: 20px;">‚ÑπÔ∏è</span>'
            };
            
            icon.innerHTML = icons[type] || icons.info;
            messageEl.textContent = message;
            
            toast.classList.add("show");
            createIcons();
            
            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            document.getElementById("toast").classList.remove("show");
        }

        function logout() {
            if (confirm("Tem certeza que deseja sair?")) {
                currentUser = null;
                document.getElementById("mainApp").classList.add("hidden");
                document.getElementById("loginModal").classList.remove("hidden");
                document.getElementById("userSelect").value = "";
                document.getElementById("passwordInput").value = "";
                document.getElementById("meuProgramaTab").classList.add("hidden");
                NotificationManager.notify                console.log('üì§ Enviando payload para backend:', JSON.stringify(metaDataBackend, null, 2));
                console.log('üåê URL:', `${API_BASE_URL}/api.php?endpoint=goals`);

                if (id) {
                    // UPDATE: adicionar ID no payload
                    metaDataBackend.id = parseInt(id);
                    console.log('üîÑ Atualizando meta ID:', id);
                    await APIService.updateMeta(id, metaDataBackend);
                    
                    // Atualizar no array local (converter de volta para interface)
                    const metaIndex = metas.findIndex(m => m.id == id);
                    if (metaIndex > -1) {
                        metas[metaIndex] = { 
                            ...metas[metaIndex], 
                            id: parseInt(id),
                            titulo: titulo,
                            objetivo: objetivo, 
                            programa: programa,
                            indicadores: indicadores,
                            status: "ativo",
                            updated_at: new Date().toISOString()
                        };
                    }
                    
                    // NOVA: Log de auditoria
                    await AuditManager.logOperation('UPDATE', 'meta', id, metaData, currentUser.name);
                    await logActivity(`Meta "${titulo}" atualizada`, "info", "edit");
                    
                    NotificationManager.notify("Meta atualizada no backend!", "SUCCESS");
                } else {
                    // CREATE: novo item
                    console.log('‚ûï Criando nova meta');
                    const response = await APIService.createMeta(metaDataBackend);
                    console.log('üì• Resposta do backend:', response);
                    
                    // Adicionar ao array local (converter de volta para interface)
                    const newMeta = {
                        id: response.id || Date.now(),
                        titulo: titulo,
                        objetivo: objetivo,
                        programa: programa, 
                        indicadores: indicadores,
                        status: "ativo",
                        created_by: currentUser.name,
                        created_at: new Date().toISOString()
                    };
                    
                    metas.push(newMeta);
                    
                    // NOVA: Log de auditoria
                    await AuditManager.logOperation('CREATE', 'meta', newMeta.id, metaData, currentUser.name);
                    await logActivity(`Nova meta "${titulo}" cadastrada`, "success", "target");
                    
                    NotificationManager.notify("Meta cadastrada no banco PostgreSQL!", "SUCCESS");
                }

                // NOVO: Limpar cache
                CacheManager.clear();
                
                updateAllData();
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Erro detalhado ao salvar meta:', error);
                
                let errorMessage = error.message;
                
                // Tratar erros espec√≠ficos
                if (error.message.includes('400')) {
                    errorMessage = "Erro 400: Dados inv√°lidos enviados ao backend. Verifique os campos obrigat√≥rios.";
                } else if (error.message.includes('404')) {
                    errorMessage = "Endpoint n√£o encontrado. Meta salva localmente.";
                } else if (error.message.includes('500')) {
                    errorMessage = "Erro interno do servidor. Tente novamente em alguns instantes.";
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = "Erro de conex√£o. Verifique sua internet e tente novamente.";
                }
                
                NotificationManager.notify(errorMessage, "URGENT");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // ========================================
        // FUN√á√ïES DE A√á√ïES MELHORADAS
        // ========================================
        async function showActionForm(programName = "", actionId = null) {
            const action = actionId ? actions.find(a => a.id == actionId) : null;
            const title = action ? "Editar A√ß√£o" : "Cadastrar Nova A√ß√£o";

            const content = `
                <form id="actionForm" class="space-y-4">
                    <input type="hidden" id="actionId" value="${action?.id || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da A√ß√£o *</label>
                        <input type="text" id="actionTitulo" class="w-full p-2 border border-gray-300 rounded-lg" value="${action?.titulo || ""}" required>
                        <div class="text-xs text-gray-500 mt-1">M√≠nimo 3 caracteres, m√°ximo 100</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Programa *</label>
                        <select id="actionPrograma" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Selecione um programa...</option>
                            ${programs.map(p => `<option value="${p.name}" ${programName === p.name || action?.programa === p.name ? "selected" : ""}>${p.name}</option>`).join("")}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <textarea id="actionDescricao" class="w-full p-2 border border-gray-300 rounded-lg" rows="3">${action?.descricao || ""}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Respons√°vel *</label>
                        <input type="text" id="actionResponsavel" class="w-full p-2 border border-gray-300 rounded-lg" value="${action?.responsavel || currentUser.name}" required>
                        <div class="text-xs text-gray-500 mt-1">M√≠nimo 2 caracteres</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select id="actionStatus" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="pending" ${action?.status === "pending" ? "selected" : ""}>Pendente</option>
                            <option value="in_progress" ${action?.status === "in_progress" ? "selected" : ""}>Em Andamento</option>
                            <option value="completed" ${action?.status === "completed" ? "selected" : ""}>Conclu√≠da</option>
                        </select>
                    </div>
                    <div class="text-xs text-gray-500">* Campos obrigat√≥rios</div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveAction()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Salvar A√ß√£o</button>
            `;

            createModal(title, content, footer);
        }

        async function saveAction() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("actionId").value;
                const titulo = document.getElementById("actionTitulo").value;
                const programa = document.getElementById("actionPrograma").value;
                const descricao = document.getElementById("actionDescricao").value;
                const responsavel = document.getElementById("actionResponsavel").value;
                const status = document.getElementById("actionStatus").value;

                // NOVA: Valida√ß√£o robusta antes de salvar
                const actionData = {
                    titulo,
                    programa,
                    descricao,
                    responsavel,
                    status
                };

                const validationErrors = DataValidator.validate(actionData, 'action');
                if (validationErrors.length > 0) {
                    NotificationManager.showValidationErrors(validationErrors);
                    return;
                }

                // ‚úÖ DADOS PARA O BACKEND
                const actionDataFinal = {
                    titulo,
                    programa,
                    descricao,
                    responsavel,
                    status,
                    created_by: currentUser.name,
                    created_at: new Date().toISOString()
                };

                console.log('üì§ Enviando a√ß√£o para backend:', JSON.stringify(actionDataFinal, null, 2));
                console.log('üåê URL:', `${API_BASE_URL}/api.php?endpoint=actions`);

                if (id) {
                    // UPDATE: adicionar ID no payload
                    actionDataFinal.id = parseInt(id);
                    console.log('üîÑ Atualizando a√ß√£o ID:', id);
                    await APIService.updateAction(id, actionDataFinal);
                    
                    // Atualizar no array local
                    const actionIndex = actions.findIndex(a => a.id == id);
                    if (actionIndex > -1) {
                        actions[actionIndex] = { ...actions[actionIndex], ...actionDataFinal };
                    }
                    
                    // NOVA: Log de auditoria
                    await AuditManager.logOperation('UPDATE', 'action', id, actionData, currentUser.name);
                    await logActivity(`A√ß√£o "${titulo}" atualizada`, "info", "edit");
                    
                    NotificationManager.notify("A√ß√£o atualizada no backend!", "SUCCESS");
                } else {
                    // CREATE: novo item
                    console.log('‚ûï Criando nova a√ß√£o');
                    const response = await APIService.createAction(actionDataFinal);
                    console.log('üì• Resposta do backend:', response);
                    
                    // Adicionar ao array local
                    const newAction = {
                        id: response.id || Date.now(),
                        ...actionDataFinal
                    };
                    actions.push(newAction);
                    
                    // NOVA: Log de auditoria
                    await AuditManager.logOperation('CREATE', 'action', newAction.id, actionData, currentUser.name);
                    await logActivity(`Nova a√ß√£o "${titulo}" cadastrada`, "success", "plus");
                    
                    NotificationManager.notify("A√ß√£o cadastrada no banco PostgreSQL!", "SUCCESS");
                }

                // NOVO: Limpar cache
                CacheManager.clear();
                
                updateAllData();
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Erro detalhado ao salvar a√ß√£o:', error);
                
                let errorMessage = error.message;
                
                // Tratar erros espec√≠ficos
                if (error.message.includes('400')) {
                    errorMessage = "Erro 400: Dados inv√°lidos enviados ao backend. Verifique os campos obrigat√≥rios.";
                } else if (error.message.includes('404')) {
                    errorMessage = "Endpoint n√£o encontrado. A√ß√£o salva localmente.";
                } else if (error.message.includes('500')) {
                    errorMessage = "Erro interno do servidor. Tente novamente em alguns instantes.";
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = "Erro de conex√£o. Verifique sua internet e tente novamente.";
                }
                
                NotificationManager.notify(errorMessage, "URGENT");
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // ========================================
        // NOVAS FUN√á√ïES DE M√âTRICAS E STATUS AVAN√áADO
        // ========================================
        
        // Update statistics - VERS√ÉO MELHORADA
        function updateStats() {
            // Estat√≠sticas b√°sicas
            document.getElementById("totalProgramas").textContent = programs.length;
            document.getElementById("acoesAtivas").textContent = actions.length;
            document.getElementById("followupsAtivos").textContent = followUps.length;
            document.getElementById("tarefasPendentes").textContent = tasks.filter(t => t.status === "pending").length;
            document.getElementById("metas-count").textContent = metas.length;
            
            // NOVO: Atualizar estat√≠sticas avan√ßadas
            updateAdvancedStats();
        }

        // NOVA FUN√á√ÉO: Estat√≠sticas avan√ßadas
        function updateAdvancedStats() {
            const metrics = MetricsManager.calculateAdvancedMetrics();
            const now = new Date();
            const today = now.toDateString();
            
            // Verificar se os elementos existem antes de adicionar
            let advancedStatsContainer = document.getElementById('advanced-stats-container');
            if (!advancedStatsContainer) {
                // Criar container para estat√≠sticas avan√ßadas
                const dashboardGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4.gap-6.mb-8');
                if (dashboardGrid) {
                    advancedStatsContainer = document.createElement('div');
                    advancedStatsContainer.id = 'advanced-stats-container';
                    advancedStatsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6';
                    dashboardGrid.parentNode.insertBefore(advancedStatsContainer, dashboardGrid.nextSibling);
                }
            }
            
            if (advancedStatsContainer) {
                advancedStatsContainer.innerHTML = `
                    <div class="dashboard-card bg-red-50 border-red-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-red-600">Em Atraso</p>
                                <p class="text-2xl font-bold text-red-900">${metrics.productivity.overdueTasks + metrics.productivity.overdueActions}</p>
                                <p class="text-xs text-red-600">${metrics.productivity.overdueTasks} tarefas, ${metrics.productivity.overdueActions} a√ß√µes</p>
                            </div>
                            <div class="bg-red-100 p-3 rounded-lg">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card bg-green-50 border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-green-600">Conclu√≠das Hoje</p>
                                <p class="text-2xl font-bold text-green-900">${metrics.productivity.tasksCompletedToday}</p>
                                <p class="text-xs text-green-600">Tarefas finalizadas</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg">
                                <span style="font-size: 24px;">üéâ</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card bg-blue-50 border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-blue-600">Tempo M√©dio</p>
                                <p class="text-2xl font-bold text-blue-900">${metrics.productivity.avgCompletionTime}</p>
                                <p class="text-xs text-blue-600">dias para conclus√£o</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-lg">
                                <span style="font-size: 24px;">‚è±Ô∏è</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card bg-purple-50 border-purple-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-purple-600">Progresso Mensal</p>
                                <p class="text-2xl font-bold text-purple-900">${metrics.trends.monthlyCompletion}%</p>
                                <p class="text-xs text-purple-600">taxa de conclus√£o</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg">
                                <span style="font-size: 24px;">üìà</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Mostrar notifica√ß√µes para bottlenecks
                if (metrics.trends.bottlenecks.length > 0) {
                    const bottleneck = metrics.trends.bottlenecks[0];
                    NotificationManager.notify(
                        `Gargalo identificado: ${bottleneck.description}`,
                        'HIGH',
                        [
                            {
                                label: 'Ver Detalhes',
                                callback: 'showBottleneckDetails()'
                            }
                        ]
                    );
                }
            }
        }

        // NOVA FUN√á√ÉO: Mostrar detalhes de gargalos
        function showBottleneckDetails() {
            const metrics = MetricsManager.calculateAdvancedMetrics();
            
            let content = '<div class="space-y-4">';
            
            if (metrics.trends.bottlenecks.length === 0) {
                content += '<p class="text-green-600">üéâ Nenhum gargalo identificado! Sistema funcionando bem.</p>';
            } else {
                content += '<h4 class="font-medium text-red-900 mb-3">üö® Gargalos Identificados:</h4>';
                content += '<div class="space-y-3">';
                
                metrics.trends.bottlenecks.forEach(bottleneck => {
                    content += `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-red-900">${bottleneck.description}</span>
                                <span class="text-red-600 text-sm">${bottleneck.count} itens</span>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            // Adicionar tend√™ncias semanais
            content += '<h4 class="font-medium text-blue-900 mb-3 mt-6">üìä Progresso Semanal:</h4>';
            content += '<div class="space-y-2">';
            
            metrics.trends.weeklyProgress.forEach(week => {
                const rate = week.total > 0 ? Math.round((week.completed / week.total) * 100) : 0;
                content += `
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-700">${week.week}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${week.completed}/${week.total}</span>
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${rate}%"></div>
                            </div>
                            <span class="text-sm font-medium">${rate}%</span>
                        </div>
                    </div>
                `;
            });
            
            content += '</div></div>';
            
            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="generateDetailedReport()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Gerar Relat√≥rio</button>
            `;
            
            createModal("üìä An√°lise de Performance", content, footer);
        }

        // NOVA FUN√á√ÉO: Status avan√ßado do sistema
        function showAdvancedSystemStatus() {
            const metrics = MetricsManager.calculateAdvancedMetrics();
            const cacheStats = CacheManager.getStats();
            const auditCount = AuditManager.getAuditLogs().length;
            
            const content = `
                <div class="space-y-6">
                    <!-- Status do Backend -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-3">üåê Status do Backend</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium">URL:</span>
                                <span class="ml-2 text-blue-700">${API_BASE_URL || 'N√£o configurado'}</span>
                            </div>
                            <div>
                                <span class="font-medium">Modo:</span>
                                <span class="ml-2 text-blue-700">${OFFLINE_MODE ? 'Offline' : 'H√≠brido'}</span>
                            </div>
                            <div>
                                <span class="font-medium">Endpoints Funcionais:</span>
                                <span class="ml-2 text-blue-700">${lastEndpointTest?.summary?.available || 0}/${lastEndpointTest?.summary?.total || 7}</span>
                            </div>
                            <div>
                                <span class="font-medium">√öltimo Teste:</span>
                                <span class="ml-2 text-blue-700">${lastEndpointTest?.timestamp ? new Date(lastEndpointTest.timestamp).toLocaleString() : 'Nunca'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas do Cache -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-900 mb-3">üíæ Cache do Sistema</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium">Entradas:</span>
                                <span class="ml-2 text-green-700">${cacheStats.entries}</span>
                            </div>
                            <div>
                                <span class="font-medium">Mem√≥ria:</span>
                                <span class="ml-2 text-green-700">${Math.round(cacheStats.memory / 1024)} KB</span>
                            </div>
                            <div>
                                <span class="font-medium">TTL:</span>
                                <span class="ml-2 text-green-700">5 minutos</span>
                            </div>
                            <div>
                                <button onclick="CacheManager.clear(); NotificationManager.notify('Cache limpo!', 'SUCCESS');" class="text-green-600 hover:text-green-800 text-sm underline">
                                    Limpar Cache
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- M√©tricas de Performance -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-medium text-purple-900 mb-3">üìä M√©tricas de Performance</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium">Logs de Auditoria:</span>
                                <span class="ml-2 text-purple-700">${auditCount}</span>
                            </div>
                            <div>
                                <span class="font-medium">Backups Dispon√≠veis:</span>
                                <span class="ml-2 text-purple-700">${BackupManager.getBackups().length}</span>
                            </div>
                            <div>
                                <span class="font-medium">Tempo M√©dio de Conclus√£o:</span>
                                <span class="ml-2 text-purple-700">${metrics.productivity.avgCompletionTime} dias</span>
                            </div>
                            <div>
                                <span class="font-medium">Taxa de Conclus√£o Mensal:</span>
                                <span class="ml-2 text-purple-700">${metrics.trends.monthlyCompletion}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alertas do Sistema -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-medium text-yellow-900 mb-3">‚ö†Ô∏è Alertas do Sistema</h4>
                        <div class="space-y-2 text-sm">
                            ${metrics.trends.bottlenecks.length === 0 ? 
                                '<div class="text-green-600">‚úÖ Sistema funcionando sem gargalos!</div>' :
                                metrics.trends.bottlenecks.map(bottleneck => 
                                    `<div class="text-yellow-700">‚Ä¢ ${bottleneck.description}</div>`
                                ).join('')
                            }
                            ${metrics.productivity.overdueTasks + metrics.productivity.overdueActions > 0 ?
                                `<div class="text-red-600">üö® ${metrics.productivity.overdueTasks + metrics.productivity.overdueActions} itens em atraso</div>` :
                                '<div class="text-green-600">‚úÖ Nenhum item em atraso</div>'
                            }
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="showBackupManager()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Gerenciar Backups</button>
                <button onclick="testBackendConnectivity()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Testar Backend</button>
            `;

            createModal("üîß Status Avan√ßado do Sistema", content, footer);
        }

        // NOVA FUN√á√ÉO: Mostrar backups dispon√≠veis
        function showBackupManager() {
            const backups = BackupManager.getBackups();
            
            let content = '<div class="space-y-4">';
            
            // Se√ß√£o de cria√ß√£o de backup
            content += `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-900 mb-2">üíæ Criar Novo Backup</h4>
                    <p class="text-sm text-blue-700 mb-3">Backup autom√°tico inclui todos os dados, logs de auditoria e estat√≠sticas do cache.</p>
                    <button onclick="createManualBackup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Criar Backup Agora
                    </button>
                </div>
            `;
            
            // Lista de backups
            content += '<h4 class="font-medium text-gray-900 mb-3">üìã Backups Dispon√≠veis:</h4>';
            
            if (backups.length === 0) {
                content += '<p class="text-gray-500 text-sm">Nenhum backup encontrado.</p>';
            } else {
                content += '<div class="space-y-2">';
                
                backups.forEach(backup => {
                    const date = new Date(backup.timestamp).toLocaleString();
                    const size = Math.round(backup.size / 1024);
                    
                    content += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded border">
                            <div>
                                <div class="font-medium text-gray-900">${date}</div>
                                <div class="text-sm text-gray-600">Por: ${backup.user} ‚Ä¢ ${size} KB</div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="BackupManager.restoreBackup('${backup.key}')" class="text-green-600 hover:text-green-800 text-sm">
                                    Restaurar
                                </button>
                                <button onclick="deleteBackup('${backup.key}')" class="text-red-600 hover:text-red-800 text-sm">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            content += '</div>';
            
            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="showAuditLogs()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Ver Logs de Auditoria</button>
            `;
            
            createModal("üíæ Gerenciador de Backups", content, footer);
        }

        // NOVA FUN√á√ÉO: Criar backup manual
        async function createManualBackup() {
            try {
                const backupKey = await BackupManager.createBackup();
                NotificationManager.notify("Backup criado com sucesso!", "SUCCESS");
                
                // Atualizar modal
                setTimeout(() => {
                    closeModal();
                    showBackupManager();
                }, 1000);
                
            } catch (error) {
                NotificationManager.notify(`Erro ao criar backup: ${error.message}`, "URGENT");
            }
        }

        // NOVA FUN√á√ÉO: Excluir backup
        function deleteBackup(backupKey) {
            if (confirm("Tem certeza que deseja excluir este backup?")) {
                localStorage.removeItem(backupKey);
                NotificationManager.notify("Backup exclu√≠do!", "SUCCESS");
                
                // Atualizar modal
                setTimeout(() => {
                    closeModal();
                    showBackupManager();
                }, 500);
            }
        }

        // NOVA FUN√á√ÉO: Mostrar logs de auditoria
        function showAuditLogs() {
            const logs = AuditManager.getAuditLogs(100);
                        rota_empreendedora: { name: "Rota Empreendedora", type: "coord_programa", program: "rota_empreendedora" },
            lab_varejo: { name: "Lab Varejo", type: "coord_programa", program: "lab_varejo" },
            lab_consumer: { name: "Lab Consumer", type: "coord_programa", program: "lab_consumer" },
            estudio: { name: "Est√∫dio", type: "coord_programa", program: "estudio" },
            ifb_digital: { name: "IFB Digital", type: "coord_programa", program: "ifb_digital" },
            sala_interativa: { name: "Sala Interativa", type: "coord_programa", program: "sala_interativa" },
            agencia_marketing: { name: "Ag√™ncia de Marketing", type: "coord_programa", program: "agencia_marketing" }
        };

        // Programs definition
        const programs = [
            { id: 1, name: "IFB Mais Empreendedor", slug: "ifb_mais_empreendedor", description: "Programa de fomento ao empreendedorismo", progress: 75, color: "blue", icon: "rocket" },
            { id: 2, name: "Rota Empreendedora", slug: "rota_empreendedora", description: "Capacita√ß√£o em empreendedorismo", progress: 60, color: "green", icon: "map" },
            { id: 3, name: "Lab Varejo", slug: "lab_varejo", description: "Laborat√≥rio de inova√ß√£o no varejo", progress: 80, color: "purple", icon: "shopping-cart" },
            { id: 4, name: "Lab Consumer", slug: "lab_consumer", description: "Pesquisa e desenvolvimento consumer", progress: 45, color: "pink", icon: "users" },
            { id: 5, name: "Est√∫dio", slug: "estudio", description: "Produ√ß√£o de conte√∫do audiovisual", progress: 90, color: "red", icon: "video" },
            { id: 6, name: "IFB Digital", slug: "ifb_digital", description: "Transforma√ß√£o digital", progress: 55, color: "indigo", icon: "smartphone" },
            { id: 7, name: "Sala Interativa", slug: "sala_interativa", description: "Espa√ßo de aprendizagem interativa", progress: 70, color: "yellow", icon: "monitor" },
            { id: 8, name: "Ag√™ncia de Marketing", slug: "agencia_marketing", description: "Estrat√©gias de marketing digital", progress: 85, color: "teal", icon: "megaphone" }
        ];

        // Collaborators definition
        const collaborators = [
            { id: 1, name: "Ana Silva", program: "Lab Consumer", email: "ana.silva@ifb.edu.br" },
            { id: 2, name: "Carlos Santos", program: "Lab Varejo", email: "carlos.santos@ifb.edu.br" },
            { id: 3, name: "Maria Oliveira", program: "Rota Empreendedora", email: "maria.oliveira@ifb.edu.br" },
            { id: 4, name: "Jo√£o Costa", program: "IFB Mais Empreendedor", email: "joao.costa@ifb.edu.br" },
            { id: 5, name: "Patricia Lima", program: "Est√∫dio", email: "patricia.lima@ifb.edu.br" },
            { id: 6, name: "Roberto Ferreira", program: "IFB Digital", email: "roberto.ferreira@ifb.edu.br" },
            { id: 7, name: "Lucia Mendes", program: "Sala Interativa", email: "lucia.mendes@ifb.edu.br" },
            { id: 8, name: "Fernando Rocha", program: "Ag√™ncia de Marketing", email: "fernando.rocha@ifb.edu.br" }
        ];

        // ========================================
        // FUN√á√ïES DE COMPATIBILIDADE COM BACKEND
        // ========================================
        
        // Fun√ß√£o para converter dados do backend (ingl√™s) para interface (portugu√™s)
        function convertBackendToInterface(backendData) {
            if (!backendData) return backendData;
            
            // Se √© array, converter cada item
            if (Array.isArray(backendData)) {
                return backendData.map(item => convertBackendToInterface(item));
            }
            
            // Se √© objeto, converter campos espec√≠ficos
            if (typeof backendData === 'object') {
                const converted = { ...backendData };
                
                // Convers√£o: title ‚Üí titulo (para exibi√ß√£o)
                if (converted.title && !converted.titulo) {
                    converted.titulo = converted.title;
                }
                
                // Convers√£o: program ‚Üí programa (para exibi√ß√£o)
                if (converted.program && !converted.programa) {
                    converted.programa = converted.program;
                }
                
                return converted;
            }
            
            return backendData;
        }

        // Fun√ß√£o para converter dados da interface (portugu√™s) para backend (ingl√™s)
        function convertInterfaceToBackend(interfaceData) {
            if (!interfaceData) return interfaceData;
            
            const converted = { ...interfaceData };
            
            // ‚úÖ CONVERS√ÉO PRINCIPAL: titulo ‚Üí title (para envio ao backend)
            if (converted.titulo) {
                converted.title = converted.titulo;
                delete converted.titulo; // Remove campo em portugu√™s
            }
            
            // ‚úÖ CONVERS√ÉO PRINCIPAL: programa ‚Üí program (para envio ao backend)  
            if (converted.programa) {
                converted.program = converted.programa;
                delete converted.programa; // Remove campo em portugu√™s
            }
            
            return converted;
        }

        // ========================================
        // FUN√á√ïES DE LOADING STATE
        // ========================================
        function showLoadingState(show) {
            isLoading = show;
            // Voc√™ pode adicionar mais l√≥gica de loading aqui se necess√°rio
        }

        // ========================================
        // FUN√á√ïES DE LOGIN E INICIALIZA√á√ÉO MELHORADAS
        // ========================================
        async function login() {
            const userType = document.getElementById("userSelect").value;
            const password = document.getElementById("passwordInput").value;

            if (!userType) {
                NotificationManager.notify("Por favor, selecione um usu√°rio!", "HIGH");
                return;
            }

            if (password !== "123456") {
                NotificationManager.notify("Senha incorreta! Use: 123456", "HIGH");
                return;
            }

            currentUser = users[userType];
            document.getElementById("loginModal").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");
            
            document.getElementById("userName").textContent = currentUser.name;
            document.getElementById("userRole").textContent = currentUser.type === "coord_geral" ? "Coordena√ß√£o Geral" : 
                                                            currentUser.type === "coord_projeto" ? "Coordenador de Projeto" : 
                                                            "Coordenador de Programa";

            // ‚úÖ DIAGN√ìSTICO COMPLETO DE CONECTIVIDADE
            console.log('üîê Login realizado:', currentUser.name);
            NotificationManager.notify("Fazendo login e testando conectividade...", "NORMAL");

            if (API_BASE_URL) {
                console.log('üåê Testando backend:', API_BASE_URL);
                
                const backendAvailable = await APIService.testBackendConnection();
                if (backendAvailable) {
                    OFFLINE_MODE = false;
                    console.log('‚úÖ Backend dispon√≠vel');
                    
                    // Testar endpoints espec√≠ficos
                    const endpointResults = await testBackendEndpoints();
                    const workingEndpoints = endpointResults.filter(r => r.available).length;
                    const totalEndpoints = endpointResults.length;
                    
                    if (workingEndpoints > 0) {
                        NotificationManager.notify(
                            `Backend conectado! ${workingEndpoints}/${totalEndpoints} endpoints funcionais`,
                            "SUCCESS"
                        );
                    } else {
                        OFFLINE_MODE = true;
                        NotificationManager.notify("Backend conectado mas endpoints indispon√≠veis", "HIGH");
                    }
                } else {
                    OFFLINE_MODE = true;
                    console.log('‚ùå Backend indispon√≠vel');
                    NotificationManager.notify("Backend offline - Usando dados locais", "HIGH");
                }
            } else {
                OFFLINE_MODE = true;
                console.log('‚öôÔ∏è Backend n√£o configurado - modo offline');
                NotificationManager.notify("Modo offline configurado - Dados salvos localmente", "NORMAL");
            }

            // Show "Meu Programa" tab for program coordinators
            if (currentUser.type === "coord_programa") {
                document.getElementById("meuProgramaTab").classList.remove("hidden");
                const program = programs.find(p => p.slug === currentUser.program);
                if (program) {
                    document.getElementById("meuProgramaTabTitle").textContent = program.name;
                }
            }

            // NOVO: Inicializar sistemas avan√ßados
            await initializeEnhancedSystems();

            // Carregar todos os dados
            await loadAllDataFromBackend();
            updateAllData();
            initializeCharts();
            
            await AuditManager.logOperation('LOGIN', 'system', null, `Login de ${currentUser.name}`, currentUser.name);
            await logActivity(`Login realizado por ${currentUser.name} ${OFFLINE_MODE ? '(offline)' : '(online)'}`, "info", "log-in");
        }

        // NOVA FUN√á√ÉO: Inicializar sistemas avan√ßados
        async function initializeEnhancedSystems() {
            try {
                // Inicializar backup autom√°tico (a cada 30 minutos)
                setInterval(async () => {
                    await BackupManager.createBackup();
                    console.log('üîÑ Backup autom√°tico executado');
                }, 30 * 60 * 1000);

                // Verificar gargalos a cada 10 minutos
                setInterval(() => {
                    const metrics = MetricsManager.calculateAdvancedMetrics();
                    if (metrics.trends.bottlenecks.length > 0) {
                        const bottleneck = metrics.trends.bottlenecks[0];
                        NotificationManager.notify(
                            `Gargalo identificado: ${bottleneck.description}`,
                            'HIGH',
                            [
                                {
                                    label: 'Ver Detalhes',
                                    callback: 'showBottleneckDetails()'
                                },
                                {
                                    label: 'Ignorar',
                                    callback: 'hideToast()'
                                }
                            ]
                        );
                    }
                }, 10 * 60 * 1000);

                // Limpar cache automaticamente a cada hora
                setInterval(() => {
                    CacheManager.clear();
                    console.log('üßπ Cache limpo automaticamente');
                }, 60 * 60 * 1000);

                console.log('‚úÖ Sistemas avan√ßados inicializados');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao inicializar sistemas avan√ßados:', error);
            }
        }

        // Vari√°vel global para armazenar resultados dos testes
        let lastEndpointTest = null;

        // ‚úÖ NOVA FUN√á√ÉO: Testar endpoints do backend
        async function testBackendEndpoints() {
            console.log('üîç Testando endpoints do backend...');
            
            // ‚úÖ Lista atualizada baseada no DevTools
            const endpoints = ['test', 'goals', 'actions', 'followups', 'tasks', 'inventory', 'schedule'];
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api.php?endpoint=${endpoint}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    const status = response.status;
                    const available = status === 200;
                    
                    results.push({
                        endpoint,
                        status,
                        available,
                        message: available ? 'Dispon√≠vel' : `Erro ${status}`
                    });
                    
                    console.log(`${available ? '‚úÖ' : '‚ùå'} ${endpoint}: ${status}`);
                    
                } catch (error) {
                    results.push({
                        endpoint,
                        status: 'ERROR',
                        available: false,
                        message: error.message
                    });
                    console.log(`‚ùå ${endpoint}: ${error.message}`);
                }
            }
            
            // Salvar resultados globalmente
            lastEndpointTest = {
                timestamp: new Date().toISOString(),
                results: results,
                summary: {
                    available: results.filter(r => r.available).length,
                    total: results.length,
                    working: results.filter(r => r.available).map(r => r.endpoint),
                    broken: results.filter(r => !r.available).map(r => r.endpoint)
                }
            };
            
            // Resumo dos resultados
            const available = results.filter(r => r.available).length;
            const total = results.length;
            
            console.log(`üìä Endpoints: ${available}/${total} dispon√≠veis`);
            console.log('üîß Endpoints funcionais:', results.filter(r => r.available).map(r => r.endpoint).join(', '));
            console.log('‚ö†Ô∏è Endpoints indispon√≠veis:', results.filter(r => !r.available).map(r => r.endpoint).join(', '));
            
            return results;
        }

        // ‚úÖ NOVA FUN√á√ÉO: Mostrar status t√©cnico detalhado
        function showTechnicalStatus() {
            if (!lastEndpointTest) {
                NotificationManager.notify("Execute um login primeiro para ver o status t√©cnico", "NORMAL");
                return;
            }

            const test = lastEndpointTest;
            const endpointRows = test.results.map(result => `
                <tr class="border-b">
                    <td class="py-2 px-3 font-mono text-sm">${result.endpoint}</td>
                    <td class="py-2 px-3 text-center">
                        <span class="px-2 py-1 rounded text-xs ${result.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${result.status}
                        </span>
                    </td>
                    <td class="py-2 px-3 text-sm">${result.message}</td>
                    <td class="py-2 px-3 text-center">${result.available ? '‚úÖ' : '‚ùå'}</td>
                </tr>
            `).join('');

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">üìä Resumo da Conectividade</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>üåê <strong>Backend:</strong> ${API_BASE_URL}</div>
                            <div>üìÖ <strong>√öltimo teste:</strong> ${new Date(test.timestamp).toLocaleString()}</div>
                            <div>‚úÖ <strong>Funcionais:</strong> ${test.summary.available}/${test.summary.total}</div>
                            <div>‚öôÔ∏è <strong>Modo:</strong> ${OFFLINE_MODE ? 'Offline' : 'Backend'}</div>
                        </div>
                    </div>

                    <div class="bg-white border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-3 text-left font-medium">Endpoint</th>
                                    <th class="py-2 px-3 text-center font-medium">Status HTTP</th>
                                    <th class="py-2 px-3 text-left font-medium">Mensagem</th>
                                    <th class="py-2 px-3 text-center font-medium">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${endpointRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="text-xs text-gray-600">
                        <p><strong>‚úÖ Endpoints funcionais:</strong> ${test.summary.working.join(', ') || 'Nenhum'}</p>
                        <p><strong>‚ùå Endpoints indispon√≠veis:</strong> ${test.summary.broken.join(', ') || 'Nenhum'}</p>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                <button onclick="testBackendConnectivity()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">Testar Novamente</button>
            `;

            createModal("Status T√©cnico dos Endpoints", content, footer);
        }

        // ‚úÖ NOVA FUN√á√ÉO: Testar conectividade manualmente
        async function testBackendConnectivity() {
            if (!API_BASE_URL) {
                NotificationManager.notify("Backend n√£o configurado - modo offline ativo", "HIGH");
                return;
            }

            NotificationManager.notify("Testando conectividade...", "NORMAL");
            closeModal();

            try {
                const results = await testBackendEndpoints();
                const available = results.filter(r => r.available).length;
                const total = results.length;

                setTimeout(() => {
                    showTechnicalStatus();
                    NotificationManager.notify(`Teste conclu√≠do: ${available}/${total} endpoints funcionais`, "SUCCESS");
                }, 500);
            } catch (error) {
                NotificationManager.notify("Erro no teste de conectividade", "URGENT");
            }
        }

        // ========================================
        // CARREGAMENTO DE DADOS H√çBRIDO
        // ========================================
        async function loadAllDataFromBackend() {
            try {
                const loadingMessage = OFFLINE_MODE ? 
                    "Carregando dados locais..." : 
                    "Conectando ao backend...";
                    
                NotificationManager.notify(loadingMessage, "NORMAL");
                
                console.log('üîÑ Iniciando carregamento de dados...');
                console.log('üì° Modo:', OFFLINE_MODE ? 'OFFLINE' : 'BACKEND');
                console.log('üåê URL Backend:', API_BASE_URL || 'N√£o configurada');
                
                const promises = [];
                const dataResults = {};
                
                // ‚úÖ METAS - Backend dispon√≠vel
                console.log('üìã Carregando metas do backend...');
                promises.push(
                    APIService.getMetas()
                        .then(result => { 
                            dataResults.metas = result;
                            console.log('‚úÖ Metas carregadas do BACKEND:', result.data?.length || 0, 'itens');
                        })
                        .catch(error => {
                            console.log('‚ö†Ô∏è Erro ao carregar metas do backend:', error.message);
                            const localMetas = JSON.parse(localStorage.getItem('enedes_metas') || '[]');
                            dataResults.metas = { data: localMetas };
                            console.log('üîÑ Metas carregadas do LOCALSTORAGE:', localMetas.length, 'itens');
                        })
                );

                // ‚úÖ A√á√ïES - Backend dispon√≠vel (NOVO!)
                console.log('üìù Carregando a√ß√µes do backend...');
                promises.push(
                    APIService.getActions()
                        .then(result => { 
                            dataResults.actions = result;
                            console.log('‚úÖ A√ß√µes carregadas do BACKEND:', result.data?.length || 0, 'itens');
                        })
                        .catch(error => {
                            console.log('‚ö†Ô∏è Erro ao carregar a√ß√µes do backend:', error.message);
                            const localActions = JSON.parse(localStorage.getItem('enedes_actions') || '[]');
                            dataResults.actions = { data: localActions };
                            console.log('üîÑ A√ß√µes carregadas do LOCALSTORAGE:', localActions.length, 'itens');
                        })
                );

                // ‚ùå OUTROS ENDPOINTS - usar localStorage (404 no backend)
                console.log('üì¶ Carregando outros dados do localStorage...');
                const localStorageKeys = {
                    followUps: 'enedes_followups', 
                    tasks: 'enedes_tasks',
                    cronograma: 'enedes_cronograma',
                    inventario: 'enedes_inventario'
                };

                Object.entries(localStorageKeys).forEach(([key, storageKey]) => {
                    try {
                        const data = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        dataResults[key] = { data };
                        console.log(`‚úÖ ${key} carregado do localStorage:`, data.length, 'itens');
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Erro ao carregar ${key}:`, error.message);
                        dataResults[key] = { data: [] };
                    }
                });

                // Aguardar carregamento das metas e a√ß√µes
                await Promise.all(promises);

                // Atualizar arrays globais
                metas = convertBackendToInterface(dataResults.metas?.data || []);
                actions = convertBackendToInterface(dataResults.actions?.data || []);
                followUps = convertBackendToInterface(dataResults.followUps?.data || []);
                tasks = convertBackendToInterface(dataResults.tasks?.data || []);
                cronograma = convertBackendToInterface(dataResults.cronograma?.data || []);
                inventario = convertBackendToInterface(dataResults.inventario?.data || []);

                // Status final
                const totalItems = metas.length + actions.length + followUps.length + tasks.length + cronograma.length + inventario.length;
                const hasBackendMetas = !OFFLINE_MODE && metas.length > 0;
                const hasBackendActions = !OFFLINE_MODE && actions.length > 0;
                
                console.log('üìä Resumo dos dados carregados:');
                console.log(`   - Metas: ${metas.length} ${hasBackendMetas ? '(BACKEND)' : '(LOCAL)'}`);
                console.log(`   - A√ß√µes: ${actions.length} ${hasBackendActions ? '(BACKEND)' : '(LOCAL)'}`);
                console.log(`   - Follow-ups: ${followUps.length} (LOCAL)`);
                console.log(`   - Tarefas: ${tasks.length} (LOCAL)`);
                console.log(`   - Cronograma: ${cronograma.length} (LOCAL)`);
                console.log(`   - Invent√°rio: ${inventario.length} (LOCAL)`);
                console.log(`   - Total: ${totalItems} itens`);

                let successMessage;
                if (OFFLINE_MODE) {
                    successMessage = `Sistema offline carregado com ${totalItems} itens`;
                } else if (hasBackendMetas && hasBackendActions) {
                    successMessage = `Sistema h√≠brido otimizado: Backend + Local (${totalItems} itens)`;
                } else if (hasBackendMetas) {
                    successMessage = `Sistema h√≠brido: Metas no backend (${totalItems} itens)`;
                } else {
                    successMessage = `Sistema local carregado (${totalItems} itens)`;
                }
                    
                NotificationManager.notify(successMessage, "SUCCESS");
                
            } catch (error) {
                console.error('‚ùå Erro geral no carregamento:', error);
                
                // Em caso de erro, inicializar arrays vazios
                metas = [];
                actions = [];
                followUps = [];
                tasks = [];
                cronograma = [];
                inventario = [];
                
                NotificationManager.notify("Erro no carregamento - sistema iniciado vazio", "HIGH");
            }
        }

        // ========================================
        // LOG DE ATIVIDADES
        // ========================================
        async function logActivity(message, type = "info", icon = "info") {
            try {
                const activityData = {
                    message,
                    type,
                    icon,
                    user: currentUser?.name || "Sistema",
                    timestamp: new Date().toISOString()
                };
                
                await APIService.logActivity(activityData);
            } catch (error) {
                console.error('Erro ao registrar atividade:', error);
            }
        }

        // ========================================
        // FUN√á√ïES DE METAS - ‚úÖ MELHORADAS COM VALIDA√á√ÉO
        // ========================================
        async function showMetaForm(metaId = null) {
            const meta = metaId ? metas.find(m => m.id == metaId) : null;
            const title = meta ? "Editar Meta" : "Cadastrar Nova Meta";
            
            const content = `
                <form id="metaForm" class="space-y-4">
                    <input type="hidden" id="metaId" value="${meta?.id || ""}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da Meta *</label>
                        <input type="text" id="metaTitulo" class="w-full p-2 border border-gray-300 rounded-lg" value="${meta?.titulo || meta?.title || ""}" required>
                        <div class="text-xs text-gray-500 mt-1">M√≠nimo 3 caracteres, m√°ximo 100</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Objetivo Social *</label>
                        <textarea id="metaObjetivo" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" required>${meta?.objetivo || ""}</textarea>
                        <div class="text-xs text-gray-500 mt-1">M√≠nimo 10 caracteres</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Programa Respons√°vel *</label>
                        <select id="metaPrograma" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Selecione um programa...</option>
                            ${programs.map(p => `<option value="${p.name}" ${(meta?.programa || meta?.program) === p.name ? "selected" : ""}>${p.name}</option>`).join("")}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Indicadores (at√© 5)</label>
                        <div id="indicadoresContainer" class="space-y-2">
                            ${(meta?.indicadores || [""]).slice(0, 5).map((indicador, index) => `
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="indicador${index}" class="flex-1 p-2 border border-gray-300 rounded-lg" 
                                           placeholder="Indicador ${index + 1}" value="${indicador}">
                                    ${index > 0 ? `<button type="button" onclick="removeIndicador(${index})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>` : ''}
                                </div>
                            `).join("")}
                        </div>
                        <button type="button" onclick="addIndicador()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                            Adicionar Indicador
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">* Campos obrigat√≥rios</div>
                </form>
            `;

            const footer = `
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button onclick="saveMeta()" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                    <span class="loading hidden"></span>
                    Salvar Meta
                </button>
            `;

            createModal(title, content, footer);
        }

        async function saveMeta() {
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<span class="loading"></span> Salvando...';
            saveButton.disabled = true;

            try {
                const id = document.getElementById("metaId").value;
                const titulo = document.getElementById("metaTitulo").value;
                const objetivo = document.getElementById("metaObjetivo").value;
                const programa = document.getElementById("metaPrograma").value;
                
                // Coleta indicadores
                const indicadores = [];
                for (let i = 0; i < 5; i++) {
                    const indicadorElement = document.getElementById(`indicador${i}`);
                    if (indicadorElement && indicadorElement.value.trim()) {
                        indicadores.push(indicadorElement.value.trim());
                    }
                }

                // NOVA: Valida√ß√£o robusta antes de salvar
                const metaData = {
                    title: titulo,
                    objetivo: objetivo,
                    program: programa,
                    indicadores: indicadores
                };

                const validationErrors = DataValidator.validate(metaData, 'meta');
                if (validationErrors.length > 0) {
                    NotificationManager.showValidationErrors(validationErrors);
                    return;
                }

                // ‚úÖ PAYLOAD EXATO ESPERADO PELO BACKEND (conforme documenta√ß√£o)
                const metaDataBackend = {
                    title: titulo,          // ‚úÖ Campo em ingl√™s 
                    objetivo: objetivo,     // ‚úÖ Campo mantido em portugu√™s
                    program: programa,      // ‚úÖ Campo em ingl√™s
                    indicadores: indicadores, // ‚úÖ Array de strings
                    status: "ativo"         <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ENEDES - Gest√£o Completa com Follow-up</title>
    <!-- CDNs com fallbacks m√∫ltiplos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tentativa 1: Lucide via unpkg -->
    <script>
        (function() {
            const script1 = document.createElement('script');
            script1.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';
            script1.onload = () => console.log('‚úÖ Lucide carregado (unpkg)');
            script1.onerror = () => {
                console.log('‚ö†Ô∏è Tentativa 1 Lucide falhou, tentando CDN alternativo...');
                // Tentativa 2: jsdelivr
                const script2 = document.createElement('script');
                script2.src = 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js';
                script2.onload = () => console.log('‚úÖ Lucide carregado (jsdelivr)');
                script2.onerror = () => {
                    console.log('‚ö†Ô∏è Todas as tentativas de Lucide falharam - usando emojis');
                    window.lucideLoadFailed = true;
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        })();
        
        (function() {
            const script1 = document.createElement('script');
            script1.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
            script1.onload = () => console.log('‚úÖ Chart.js carregado (jsdelivr)');
            script1.onerror = () => {
                console.log('‚ö†Ô∏è Tentativa 1 Chart.js falhou, tentando CDN alternativo...');
                // Tentativa 2: cdnjs
                const script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js';
                script2.onload = () => console.log('‚úÖ Chart.js carregado (cdnjs)');
                script2.onerror = () => {
                    console.log('‚ö†Ô∏è Todas as tentativas de Chart.js falharam - usando gr√°ficos HTML');
                    window.chartLoadFailed = true;
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        })();
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .followup-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #3b82f6;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-green { background-color: #10b981; }
        .status-blue { background-color: #3b82f6; }
        .status-gray { background-color: #6b7280; }
        .status-red { background-color: #ef4444; }
        .status-yellow { background-color: #f59e0b; }
        
        .farol-verde { background-color: #10b981; }
        .farol-amarelo { background-color: #f59e0b; }
        .farol-vermelho { background-color: #ef4444; }
        .farol-gray { background-color: #6b7280; }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold gradient-bg bg-clip-text text-transparent">ENEDES</h1>
                <p class="text-gray-600 mt-2">Gest√£o Completa de Projetos</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                    <select id="userSelect" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">Escolha um usu√°rio...</option>
                        <option value="coord_geral">Coordena√ß√£o Geral</option>
                        <option value="coord_projeto_area1">Coordenador de Projeto - √Årea 1</option>
                        <option value="coord_projeto_area2">Coordenador de Projeto - √Årea 2</option>
                        <option value="ifb_mais_empreendedor">IFB Mais Empreendedor</option>
                        <option value="rota_empreendedora">Rota Empreendedora</option>
                        <option value="lab_varejo">Lab Varejo</option>
                        <option value="lab_consumer">Lab Consumer</option>
                        <option value="estudio">Est√∫dio</option>
                        <option value="ifb_digital">IFB Digital</option>
                        <option value="sala_interativa">Sala Interativa</option>
                        <option value="agencia_marketing">Ag√™ncia de Marketing</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                    <input type="password" id="passwordInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Digite: 123456">
                </div>
                <button onclick="login()" class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                    ENTRAR
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-teal-600">ENEDES</h1>
                        <span class="text-gray-500">Gest√£o Completa de Projetos</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showTechnicalStatus()" class="relative p-2 text-gray-600 hover:text-gray-900" title="Status do sistema e conectividade">
                            <span data-lucide="bell">üîî</span>
                            <span class="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">‚óè</span>
                        </button>
                        <div class="flex items-center space-x-2">
                            <div class="text-right">
                                <div id="userName" class="text-sm font-medium text-gray-900"></div>
                                <div id="userRole" class="text-xs text-gray-500"></div>
                            </div>
                            <button onclick="logout()" class="p-2 text-gray-600 hover:text-gray-900">
                                <span data-lucide="log-out">üö™</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('dashboard')" class="py-4 px-1 border-b-2 border-teal-500 text-teal-600 font-medium text-sm" id="tab-dashboard">
                        <span data-lucide="home">üè†</span> Dashboard
                    </button>
                    <button onclick="showTab('metas')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-metas">
                        <span data-lucide="target">üéØ</span> Metas
                        <span class="ml-1 bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full" id="metas-count">0</span>
                    </button>
                    <button onclick="showTab('programas')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-programas">
                        <span data-lucide="layers">üìö</span> Programas
                        <span class="ml-1 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">8</span>
                    </button>
                    <div id="meuProgramaTab" class="hidden">
                        <button onclick="showTab('meu-programa')" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm" id="tab-meu-programa">
                            <span data-lucide="briefcase">üíº</span> <span id="meuProgramaTabTitle">Meu Programa</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content">
                <!-- Quick Actions -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Vis√£o Geral</h2>
                        <div class="flex space-x-2">
                            <button onclick="showMetaForm()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <span data-lucide="target">üéØ</span> Nova Meta
                            </button>
                            <button onclick="showActionForm()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <span data-lucide="plus">+</span> Nova A√ß√£o
                            </button>
                            <button onclick="showFollowUpForm()" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                <span data-lucide="send">üì§</span> Follow-up
                            </button>
                            <button onclick="exportData()" class="text-orange-600 hover:text-orange-800 text-sm font-medium">
                                <span data-lucide="download">‚¨áÔ∏è</span> Exportar
                            </button>
                            <button onclick="showAdvancedSystemStatus()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                <span data-lucide="activity">üìä</span> Status
                            </button>
                            <button onclick="showBackupManager()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <span data-lucide="shield">üíæ</span> Backups
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total de Programas</p>
                                    <p id="totalProgramas" class="text-2xl font-bold text-gray-900">8</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-lg">
                                    <span data-lucide="layers" style="font-size: 24px;">üìö</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">A√ß√µes Ativas</p>
                                    <p id="acoesAtivas" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-lg">
                                    <span data-lucide="activity" style="font-size: 24px;">üìä</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Follow-ups Ativos</p>
                                    <p id="followupsAtivos" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <span data-lucide="send" style="font-size: 24px;">üì§</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Tarefas Pendentes</p>
                                    <p id="tarefasPendentes" class="text-2xl font-bold text-gray-900">
                                        <span class="loading"></span>
                                    </p>
                                </div>
                                <div class="bg-orange-100 p-3 rounded-lg">
                                    <span data-lucide="clock" style="font-size: 24px;">‚è∞</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Status das A√ß√µes por Programa</h3>
                            <div class="chart-container">
                                <canvas id="acoesPorProgramaChart"></canvas>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Follow-ups por Status</h3>
                            <div class="chart-container">
                                <canvas id="followupStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Farol de Acompanhamento -->
                    <div class="dashboard-card mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Farol de Acompanhamento por Programa</h3>
                        <div id="farolAcompanhamento" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Far√≥is ser√£o inseridos aqui dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Cards -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">A√ß√µes R√°pidas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                        <button onclick="showMetaForm()" class="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 transition-colors text-left">
                            <div data-lucide="target" style="font-size: 24px; margin-bottom: 8px;">üéØ</div>
                            <h4 class="font-medium text-purple-900">Nova Meta</h4>
                            <p class="text-sm text-purple-700">Cadastrar nova meta estrat√©gica</p>
                        </button>

                        <button onclick="showActionForm()" class="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-left">
                            <div data-lucide="plus" style="font-size: 24px; margin-bottom: 8px;">+</div>
                            <h4 class="font-medium text-blue-900">Nova A√ß√£o</h4>
                            <p class="text-sm text-blue-700">Adicionar nova a√ß√£o ao projeto</p>
                        </button>

                        <button onclick="showFollowUpForm()" class="p-4 bg-green-50 border-2 border-green-200 rounded-lg hover:bg-green-100 transition-colors text-left">
                            <div data-lucide="send" style="font-size: 24px; margin-bottom: 8px;">üì§</div>
                            <h4 class="font-medium text-green-900">Follow-up</h4>
                            <p class="text-sm text-green-700">Enviar follow-up para colaboradores</p>
                        </button>

                        <button onclick="exportData()" class="p-4 bg-orange-50 border-2 border-orange-200 rounded-lg hover:bg-orange-100 transition-colors text-left">
                            <div data-lucide="download" style="font-size: 24px; margin-bottom: 8px;">‚¨áÔ∏è</div>
                            <h4 class="font-medium text-orange-900">Exportar</h4>
                            <p class="text-sm text-orange-700">Exportar dados com analytics</p>
                        </button>

                        <button onclick="showAdvancedSystemStatus()" class="p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors text-left">
                            <div data-lucide="activity" style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                            <h4 class="font-medium text-indigo-900">Status Avan√ßado</h4>
                            <p class="text-sm text-indigo-700">M√©tricas e conectividade</p>
                        </button>
                        
                        <button onclick="showBackupManager()" class="p-4 bg-purple-50 border-2 border-purple-200 rounded-lg hover:bg-purple-100 transition-colors text-left">
                            <div data-lucide="shield" style="font-size: 24px; margin-bottom: 8px;">üíæ</div>
                            <h4 class="font-medium text-purple-900">Backups</h4>
                            <p class="text-sm text-purple-700">Gerenciar backups e logs</p>
                        </button>
                    </div>
                </div>

                <!-- Dashboard de Follow-ups -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Dashboard de Follow-ups</h3>
                        <div class="flex space-x-2">
                            <button onclick="filterFollowUps('all')" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white" id="filter-all">
                                Todos
                                <span class="ml-1 bg-blue-600 text-white text-xs px-2 py-1 rounded-full" id="count-all">0</span>
                            </button>
                            <button onclick="filterFollowUps('pending')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-pending">
                                Pendentes
                                <span class="ml-1 bg-yellow-200 text-yellow-700 text-xs px-2 py-1 rounded-full" id="count-pending">0</span>
                            </button>
                            <button onclick="filterFollowUps('in_progress')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-in_progress">
                                Em Andamento
                                <span class="ml-1 bg-blue-200 text-blue-700 text-xs px-2 py-1 rounded-full" id="count-in_progress">0</span>
                            </button>
                            <button onclick="filterFollowUps('completed')" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-800 hover:bg-gray-200" id="filter-completed">
                                Conclu√≠dos
                                <span class="ml-1 bg-green-200 text-green-700 text-xs px-2 py-1 rounded-full" id="count-completed">0</span>
                            </button>
                        </div>
                    </div>
                    <div id="followUpsList" class="space-y-4">
                        <div class="flex items-center justify-center py-12 text-gray-500">
                            <div class="text-center">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì§</div>
                                <p>Carregando follow-ups...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metas Tab -->
            <div id="metas-content" class="tab-content hidden">
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="flex border-b">
                        <button onclick="showMetasSubTab('estrategicas')" class="px-4 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600" id="metas-tab-estrategicas">
                            <i data-lucide="target" class="w-4 h-4 inline mr-2"></i>
                            Metas Estrat√©gicas
                        </button>
                        <button onclick="showMetasSubTab('cronograma')" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900" id="metas-tab-cronograma">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>
                            Cronograma
                        </button>
                    </div>
                    
                    <!-- Metas Estrat√©gicas -->
                    <div id="metas-estrategicas-content" class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Metas Estrat√©gicas</h4>
                            <button onclick="showMetaForm()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Cadastrar Nova Meta
                            </button>
                        </div>
                        <div id="metasList" class="space-y-3">
                            <div class="text-center py-8">
                                <span class="loading mx-auto mb-4"></span>
                                <p class="text-gray-500 text-sm">Carregando metas...</p>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h5 class="font-medium text-gray-900 mb-4">Follow-ups de Metas</h5>
                            <div id="metasFollowUps" class="space-y-3">
                                <div class="text-center py-8">
                                    <span class="loading mx-auto mb-4"></span>
                                    <p class="text-gray-500 text-sm">Carregando follow-ups...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cronograma -->
                    <div id="metas-cronograma-content" class="p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-900">Cronograma de Execu√ß√£o</h4>
                            <button onclick="showCronogramaForm()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Nova Etapa
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa/Programa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">In√≠cio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prazo Final</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rubrica (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Executado (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saldo (R$)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status (%)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="cronogramaTable" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                            <span class="loading mx-auto mb-4"></span>
                                            <p>Carregando cronograma...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Programas Tab -->
            <div id="programas-content" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">Programas do Projeto</h2>
                    <p class="text-gray-600">Gerencie todos os programas e suas a√ß√µes, follow-ups e invent√°rios</p>
                </div>
                <div id="programsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Programs will be loaded here -->
                </div>
            </div>

            <!-- Meu Programa Tab -->
            <div id="meu-programa-content" class="tab-content hidden">
                <div class="mb-6">
                    <h2 id="meuProgramaTitle" class="text-xl font-semibold text-gray-900 mb-2">Meu Programa</h2>
                    <p class="text-gray-600">Gerencie as a√ß√µes, follow-ups e invent√°rio do seu programa</p>
                </div>
                <div id="meuProgramaContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast bg-white border border-gray-200 rounded-lg shadow-lg p-4 flex items-center space-x-3">
        <div id="toastIcon"></div>
        <span id="toastMessage" class="text-gray-900"></span>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
            <span data-lucide="x">‚úñÔ∏è</span>
        </button>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        // ========================================
        // CONFIGURA√á√ÉO DO BACKEND
        // ========================================
        
        // üîß CONFIGURA√á√ÉO: Altere para usar seu backend ou deixe vazio para modo offline
        // Exemplos:
        // - Backend ativo: 'https://sistem-lk86.onrender.com'
        // - Modo offline: '' (string vazia)
        const API_BASE_URL = 'https://sistem-lk86.onrender.com'; // ‚úÖ CORRIGIDO: URL do backend configurada
        
        // Sistema h√≠brido: Backend + LocalStorage fallback
        let OFFLINE_MODE = !API_BASE_URL; // true = offline, false = backend
        
        // ========================================
        // SISTEMA DE CACHE INTELIGENTE
        // ========================================
        class CacheManager {
            static cache = new Map();
            static TTL = 300000; // 5 minutos
            
            static get(key) {
                const item = this.cache.get(key);
                if (item && Date.now() - item.timestamp < this.TTL) {
                    return item.data;
                }
                this.cache.delete(key);
                return null;
            }
            
            static set(key, data) {
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            static clear() {
                this.cache.clear();
                console.log('üóëÔ∏è Cache limpo');
            }
            
            static getStats() {
                return {
                    entries: this.cache.size,
                    memory: JSON.stringify([...this.cache.entries()]).length
                };
            }
        }

        // ========================================
        // SISTEMA DE VALIDA√á√ÉO ROBUSTA
        // ========================================
        class DataValidator {
            static schemas = {
                meta: {
                    title: { required: true, minLength: 3, maxLength: 100 },
                    objetivo: { required: true, minLength: 10 },
                    program: { required: true, enum: programs.map(p => p.name) },
                    indicadores: { type: 'array', maxItems: 5 }
                },
                action: {
                    titulo: { required: true, minLength: 3, maxLength: 100 },
                    programa: { required: true, enum: programs.map(p => p.name) },
                    responsavel: { required: true, minLength: 2 },
                    status: { required: true, enum: ['pending', 'in_progress', 'completed'] }
                },
                followup: {
                    mensagem: { required: true, minLength: 10 },
                    prioridade: { required: true, enum: ['baixa', 'media', 'alta', 'urgente'] }
                },
                task: {
                    titulo: { required: true, minLength: 3, maxLength: 100 },
                    responsavel: { required: true, minLength: 2 }
                }
            };
            
            static validate(data, schema) {
                const errors = [];
                const rules = this.schemas[schema];
                
                if (!rules) {
                    return [`Schema '${schema}' n√£o encontrado`];
                }
                
                for (const [field, rule] of Object.entries(rules)) {
                    const value = data[field];
                    
                    if (rule.required && (!value || value.toString().trim() === '')) {
                        errors.push(`${field} √© obrigat√≥rio`);
                        continue;
                    }
                    
                    if (value && rule.minLength && value.length < rule.minLength) {
                        errors.push(`${field} deve ter pelo menos ${rule.minLength} caracteres`);
                    }
                    
                    if (value && rule.maxLength && value.length > rule.maxLength) {
                        errors.push(`${field} deve ter no m√°ximo ${rule.maxLength} caracteres`);
                    }
                    
                    if (value && rule.enum && !rule.enum.includes(value)) {
                        errors.push(`${field} deve ser um dos valores: ${rule.enum.join(', ')}`);
                    }
                    
                    if (value && rule.type === 'array' && rule.maxItems && value.length > rule.maxItems) {
                        errors.push(`${field} deve ter no m√°ximo ${rule.maxItems} itens`);
                    }
                }
                
                return errors;
            }
        }

        // ========================================
        // SISTEMA DE NOTIFICA√á√ïES AVAN√áADAS
        // ========================================
        class NotificationManager {
            static priorities = {
                URGENT: { color: 'red', timeout: 10000, icon: 'üö®' },
                HIGH: { color: 'orange', timeout: 7000, icon: '‚ö†Ô∏è' },
                NORMAL: { color: 'blue', timeout: 5000, icon: '‚ÑπÔ∏è' },
                SUCCESS: { color: 'green', timeout: 4000, icon: '‚úÖ' }
            };
            
            static notify(message, priority = 'NORMAL', actions = null) {
                const config = this.priorities[priority];
                
                if (actions && actions.length > 0) {
                    this.createActionableNotification(message, config, actions);
                } else {
                    this.createSimpleNotification(message, config);
                }
            }
            
            static createSimpleNotification(message, config) {
                showToast(`${config.icon} ${message}`, config.color);
            }
            
            static createActionableNotification(message, config, actions) {
                const toast = document.getElementById("toast");
                
                toast.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-${config.color}-600" style="font-size: 20px;">${config.icon}</div>
                        <div class="flex-1">
                            <span class="text-gray-900">${message}</span>
                        </div>
                        <div class="flex space-x-2">
                            ${actions.map(action => 
                                `<button onclick="${action.callback}" class="text-${config.color}-600 hover:text-${config.color}-800 text-sm font-medium px-2 py-1 rounded bg-${config.color}-50">
                                    ${action.label}
                                </button>`
                            ).join('')}
                            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">‚úñÔ∏è</button>
                        </div>
                    </div>
                `;
                
                toast.classList.add("show");
                setTimeout(() => hideToast(), config.timeout);
            }
            
            static showValidationErrors(errors) {
                const errorList = errors.map(error => `‚Ä¢ ${error}`).join('<br>');
                this.notify(`Erro de valida√ß√£o:<br>${errorList}`, 'HIGH');
            }
        }

        // ========================================
        // SISTEMA DE AUDITORIA E LOGS
        // ========================================
        class AuditManager {
            static async logOperation(operation, entityType, entityId, changes, userId) {
                const auditLog = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    operation, // CREATE, UPDATE, DELETE
                    entityType, // meta, action, followup, etc.
                    entityId,
                    changes: typeof changes === 'object' ? JSON.stringify(changes) : changes,
                    userId,
                    userAgent: navigator.userAgent.substring(0, 100),
                    url: window.location.href
                };
                
                try {
                    await APIService.request('audit-log', {
                        method: 'POST',
                        body: JSON.stringify(auditLog)
                    });
                } catch (error) {
                    // Fallback para localStorage se backend n√£o dispon√≠vel
                    const logs = JSON.parse(localStorage.getItem('enedes_audit_logs') || '[]');
                    logs.push(auditLog);
                    
                    // Manter apenas os √∫ltimos 1000 logs
                    if (logs.length > 1000) {
                        logs.splice(0, logs.length - 1000);
                    }
                    
                    localStorage.setItem('enedes_audit_logs', JSON.stringify(logs));
                }
            }
            
            static getAuditLogs(limit = 50) {
                return JSON.parse(localStorage.getItem('enedes_audit_logs') || '[]')
                    .slice(-limit)
                    .reverse();
            }
        }

        // ========================================
        // SISTEMA DE BACKUP AUTOM√ÅTICO
        // ========================================
        class BackupManager {
            static async createBackup() {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: "2.2-Enhanced",
                    user: currentUser?.name || 'Sistema',
                    data: {
                        metas,
                        actions,
                        followUps,
                        tasks,
                        cronograma,
                        inventario
                    },
                    systemInfo: {
                        endpoints_status: lastEndpointTest?.summary,
                        cache_stats: CacheManager.getStats(),
                        audit_logs_count: AuditManager.getAuditLogs().length
                    }
                };
                
                const backupKey = 'enedes_backup_' + Date.now();
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Manter apenas os 10 backups mais recentes
                const allBackups = Object.keys(localStorage)
                    .filter(key => key.startsWith('enedes_backup_'))
                    .sort();
                    
                if (allBackups.length > 10) {
                    allBackups.slice(0, -10).forEach(key => localStorage.removeItem(key));
                }
                
                console.log('‚úÖ Backup autom√°tico criado:', backupKey);
                return backupKey;
            }
            
            static getBackups() {
                return Object.keys(localStorage)
                    .filter(key => key.startsWith('enedes_backup_'))
                    .map(key => {
                        try {
                            const backup = JSON.parse(localStorage.getItem(key));
                            return {
                                key,
                                timestamp: backup.timestamp,
                                user: backup.user,
                                size: localStorage.getItem(key).length
                            };
                        } catch {
                            return null;
                        }
                    })
                    .filter(Boolean)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            
            static async restoreBackup(backupKey) {
                try {
                    const backupData = JSON.parse(localStorage.getItem(backupKey));
                    
                    if (!backupData || !backupData.data) {
                        throw new Error('Backup inv√°lido');
                    }
                    
                    // Restaurar dados
                    metas = backupData.data.metas || [];
                    actions = backupData.data.actions || [];
                    followUps = backupData.data.followUps || [];
                    tasks = backupData.data.tasks || [];
                    cronograma = backupData.data.cronograma || [];
                    inventario = backupData.data.inventario || [];
                    
                    updateAllData();
                    
                    NotificationManager.notify(
                        `Backup restaurado com sucesso! Data: ${new Date(backupData.timestamp).toLocaleString()}`,
                        'SUCCESS'
                    );
                    
                    await AuditManager.logOperation(
                        'RESTORE',
                        'backup',
                        backupKey,
                        `Backup de ${backupData.user}`,
                        currentUser?.name || 'Sistema'
                    );
                    
                } catch (error) {
                    NotificationManager.notify(`Erro ao restaurar backup: ${error.message}`, 'URGENT');
                }
            }
        }

        // ========================================
        // SISTEMA DE M√âTRICAS AVAN√áADAS
        // ========================================
        class MetricsManager {
            static calculateAdvancedMetrics() {
                const now = new Date();
                const today = now.toDateString();
                const thisWeek = this.getWeekRange(now);
                const thisMonth = this.getMonthRange(now);
                
                return {
                    productivity: {
                        tasksCompletedToday: tasks.filter(t => 
                            t.status === 'completed' && 
                            t.updated_at && new Date(t.updated_at).toDateString() === today
                        ).length,
                        
                        actionsCompletedThisWeek: actions.filter(a =>
                            a.status === 'completed' &&
                            a.updated_at && this.isInRange(new Date(a.updated_at), thisWeek)
                        ).length,
                        
                        overdueTasks: tasks.filter(t => 
                            t.prazo && new Date(t.prazo) < now && t.status !== 'completed'
                        ).length,
                        
                        overdueActions: actions.filter(a =>
                            a.prazo && new Date(a.prazo) < now && a.status !== 'completed'
                        ).length,
                        
                        avgCompletionTime: this.calculateAvgCompletionTime()
                    },
                    
                    programs: programs.map(program => {
                        const programActions = actions.filter(a => a.programa === program.name);
                        const programTasks = tasks.filter(t => {
                            const followUp = followUps.find(f => f.id == t.followup_id);
                            const targetItem = followUp ? 
                                (followUp.type === "action" ? 
                                    actions.find(a => a.id == followUp.target_id) : 
                                    metas.find(m => m.id == followUp.target_id)) : null;
                            return targetItem && targetItem.programa === program.name;
                        });
                        
                        return {
                            name: program.name,
                            totalActions: programActions.length,
                            completedActions: programActions.filter(a => a.status === 'completed').length,
                            totalTasks: programTasks.length,
                            completedTasks: programTasks.filter(t => t.status === 'completed').length,
                            completionRate: programActions.length > 0 ? 
                                Math.round((programActions.filter(a => a.status === 'completed').length / programActions.length) * 100) : 0
                        };
                    }),
                    
                    trends: {
                        weeklyProgress: this.getWeeklyProgressTrend(),
                        monthlyCompletion: this.getMonthlyCompletionRate(),
                        bottlenecks: this.identifyBottlenecks()
                    }
                };
            }
            
            static getWeekRange(date) {
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                return { start: startOfWeek, end: endOfWeek };
            }
            
            static getMonthRange(date) {
                const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                return { start: startOfMonth, end: endOfMonth };
            }
            
            static isInRange(date, range) {
                return date >= range.start && date <= range.end;
            }
            
            static calculateAvgCompletionTime() {
                const completedTasks = tasks.filter(t => t.status === 'completed' && t.created_at && t.updated_at);
                
                if (completedTasks.length === 0) return 0;
                
                const totalTime = completedTasks.reduce((sum, task) => {
                    const created = new Date(task.created_at);
                    const completed = new Date(task.updated_at);
                    return sum + (completed - created);
                }, 0);
                
                return Math.round(totalTime / completedTasks.length / (1000 * 60 * 60 * 24)); // dias
            }
            
            static getWeeklyProgressTrend() {
                const weeks = [];
                const now = new Date();
                
                for (let i = 3; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (now.getDay() + (i * 7)));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    const weekActions = actions.filter(a => 
                        a.updated_at && this.isInRange(new Date(a.updated_at), {start: weekStart, end: weekEnd})
                    );
                    
                    weeks.push({
                        week: `Sem ${4-i}`,
                        completed: weekActions.filter(a => a.status === 'completed').length,
                        total: weekActions.length
                    });
                }
                
                return weeks;
            }
            
            static getMonthlyCompletionRate() {
                const thisMonth = this.getMonthRange(new Date());
                const monthlyActions = actions.filter(a => 
                    a.created_at && this.isInRange(new Date(a.created_at), thisMonth)
                );
                
                return monthlyActions.length > 0 ? 
                    Math.round((monthlyActions.filter(a => a.status === 'completed').length / monthlyActions.length) * 100) : 0;
            }
            
            static identifyBottlenecks() {
                const bottlenecks = [];
                
                // A√ß√µes pendentes h√° mais de 7 dias
                const staleActions = actions.filter(a => {
                    const daysSinceCreated = (Date.now() - new Date(a.created_at || Date.now())) / (1000 * 60 * 60 * 24);
                    return a.status === 'pending' && daysSinceCreated > 7;
                });
                
                if (staleActions.length > 0) {
                    bottlenecks.push({
                        type: 'stale_actions',
                        count: staleActions.length,
                        description: `${staleActions.length} a√ß√µes pendentes h√° mais de 7 dias`
                    });
                }
                
                // Follow-ups sem resposta
                const unresponsiveFollowUps = followUps.filter(f => {
                    const daysSinceCreated = (Date.now() - new Date(f.created_at || Date.now())) / (1000 * 60 * 60 * 24);
                    return f.status === 'pending' && daysSinceCreated > 3;
                });
                
                if (unresponsiveFollowUps.length > 0) {
                    bottlenecks.push({
                        type: 'unresponsive_followups',
                        count: unresponsiveFollowUps.length,
                        description: `${unresponsiveFollowUps.length} follow-ups sem resposta h√° mais de 3 dias`
                    });
                }
                
                return bottlenecks;
            }
        }

        // ========================================
        // CLASSE DE INTEGRA√á√ÉO H√çBRIDA (BACKEND + OFFLINE)
        // ========================================
        class APIService {
            // Testar se backend est√° dispon√≠vel
            static async testBackendConnection() {
                if (!API_BASE_URL) return false;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api.php?endpoint=test`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    return response.ok;
                } catch (error) {
                    console.warn('Backend n√£o dispon√≠vel, usando modo offline');
                    return false;
                }
            }

            // Lista de endpoints dispon√≠veis no backend (conforme DevTools)
            static getAvailableEndpoints() {
                return ['test', 'goals', 'actions']; // ‚úÖ Endpoints que retornam 200 OK
            }

            // Verificar se endpoint est√° dispon√≠vel
            static isEndpointAvailable(endpoint) {
                return this.getAvailableEndpoints().includes(endpoint);
            }

            // Requisi√ß√£o principal (tenta backend, fallback para localStorage)
            static async request(endpoint, options = {}) {
                // Modo offline ou backend indispon√≠vel
                if (OFFLINE_MODE || !API_BASE_URL) {
                    return this.handleOfflineRequest(endpoint, options);
                }

                // Verificar se endpoint est√° dispon√≠vel no backend
                if (!this.isEndpointAvailable(endpoint)) {
                    console.log(`Endpoint '${endpoint}' n√£o dispon√≠vel no backend, usando localStorage`);
                    return this.handleOfflineRequest(endpoint, options);
                }

                // Tentar usar backend
                try {
                    showLoadingState(true);
                    const url = `${API_BASE_URL}/api.php?endpoint=${endpoint}`;
                    
                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    };

                    const config = { ...defaultOptions, ...options };
                    const response = await fetch(url, config);
                    
                    showLoadingState(false);
                    
                    if (!response.ok) {
                        console.warn(`Backend error ${response.status} for ${endpoint}, usando fallback offline`);
                        return this.handleOfflineRequest(endpoint, options);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        console.warn(`Backend retornou erro para ${endpoint}:`, data.message);
                        return this.handleOfflineRequest(endpoint, options);
                    }
                    
                    return data;
                } catch (error) {
                    showLoadingState(false);
                    console.warn(`Erro no backend para ${endpoint}, usando modo offline:`, error.message);
                    return this.handleOfflineRequest(endpoint, options);
                }
            }

            // Gerenciar requisi√ß√µes offline (localStorage)
            static handleOfflineRequest(endpoint, options = {}) {
                const method = options.method || 'GET';
                const body = options.body ? JSON.parse(options.body) : null;
                
                // Mapear endpoints para localStorage keys
                const storageKeys = {
                    'goals': 'enedes_metas',
                    'actions': 'enedes_actions', 
                    'followups': 'enedes_followups',
                    'tasks': 'enedes_tasks',
                    'schedule': 'enedes_cronograma',
                    'inventory': 'enedes_inventario',
                    'activity-log': 'enedes_activity_log'
                };

                const storageKey = storageKeys[endpoint];
                if (!storageKey) {
                    throw new Error(`Endpoint ${endpoint} n√£o suportado em modo offline`);
                }

                let data = JSON.parse(localStorage.getItem(storageKey) || '[]');

                switch (method) {
                    case 'GET':
                        return Promise.resolve({ success: true, data: data });
                    
                    case 'POST':
                        const newItem = { 
                            id: Date.now(), 
                            ...body,
                            created_at: new Date().toISOString()
                        };
                        data.push(newItem);
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        return Promise.resolve({ success: true, id: newItem.id, data: newItem });
                    
                    case 'PUT':
                        const updateIndex = data.findIndex(item => item.id == body.id);
                        if (updateIndex > -1) {
                            data[updateIndex] = { 
                                ...data[updateIndex], 
                                ...body, 
                                updated_at: new Date().toISOString() 
                            };
                            localStorage.setItem(storageKey, JSON.stringify(data));
                            return Promise.resolve({ success: true, data: data[updateIndex] });
                        }
                        throw new Error('Item n√£o encontrado');
                    
                    case 'DELETE':
                        const deleteIndex = data.findIndex(item => item.id == body.id);
                        if (deleteIndex > -1) {
                            const deletedItem = data.splice(deleteIndex, 1)[0];
                            localStorage.setItem(storageKey, JSON.stringify(data));
                            return Promise.resolve({ success: true, data: deletedItem });
                        }
                        throw new Error('Item n√£o encontrado');
                    
                    default:
                        throw new Error(`M√©todo ${method} n√£o suportado`);
                }
            }

            // METAS
            static async getMetas() {
                return await this.request('goals');
            }

            static async createMeta(metaData) {
                return await this.request('goals', {
                    method: 'POST',
                    body: JSON.stringify(metaData)
                });
            }

            static async updateMeta(id, metaData) {
                return await this.request('goals', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...metaData })
                });
            }

            static async deleteMeta(id) {
                return await this.request('goals', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // A√á√ïES
            static async getActions() {
                return await this.request('actions');
            }

            static async createAction(actionData) {
                return await this.request('actions', {
                    method: 'POST',
                    body: JSON.stringify(actionData)
                });
            }

            static async updateAction(id, actionData) {
                return await this.request('actions', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...actionData })
                });
            }

            static async deleteAction(id) {
                return await this.request('actions', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // FOLLOW-UPS
            static async getFollowUps() {
                return await this.request('followups');
            }

            static async createFollowUp(followUpData) {
                return await this.request('followups', {
                    method: 'POST',
                    body: JSON.stringify(followUpData)
                });
            }

            static async updateFollowUp(id, followUpData) {
                return await this.request('followups', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...followUpData })
                });
            }

            static async deleteFollowUp(id) {
                return await this.request('followups', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // TAREFAS
            static async getTasks() {
                return await this.request('tasks');
            }

            static async createTask(taskData) {
                return await this.request('tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
            }

            static async updateTask(id, taskData) {
                return await this.request('tasks', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...taskData })
                });
            }

            static async deleteTask(id) {
                return await this.request('tasks', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // CRONOGRAMA
            static async getCronograma() {
                return await this.request('schedule');
            }

            static async createCronogramaItem(cronogramaData) {
                return await this.request('schedule', {
                    method: 'POST',
                    body: JSON.stringify(cronogramaData)
                });
            }

            static async updateCronogramaItem(id, cronogramaData) {
                return await this.request('schedule', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...cronogramaData })
                });
            }

            static async deleteCronogramaItem(id) {
                return await this.request('schedule', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // INVENT√ÅRIO
            static async getInventario() {
                return await this.request('inventory');
            }

            static async createInventarioItem(inventarioData) {
                return await this.request('inventory', {
                    method: 'POST',
                    body: JSON.stringify(inventarioData)
                });
            }

            static async updateInventarioItem(id, inventarioData) {
                return await this.request('inventory', {
                    method: 'PUT',
                    body: JSON.stringify({ id, ...inventarioData })
                });
            }

            static async deleteInventarioItem(id) {
                return await this.request('inventory', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
            }

            // LOG DE ATIVIDADES
            static async logActivity(activityData) {
                return await this.request('activity-log', {
                    method: 'POST',
                    body: JSON.stringify(activityData)
                });
            }

            static async getActivityLog() {
                return await this.request('activity-log');
            }
        }

        // ========================================
        // VARI√ÅVEIS GLOBAIS
        // ========================================
        let currentUser = null;
        let currentTab = 'dashboard';
        let currentFilter = 'all';
        let isLoading = false;
        
        // Charts
        let acoesPorProgramaChart = null;
        let followupStatusChart = null;

        // Data Arrays (agora carregados do backend)
        let actions = [];
        let followUps = [];
        let tasks = [];
        let metas = [];
        let cronograma = [];
        let inventario = [];
        let activityLog = [];

        // User definitions
        const users = {
            coord_geral: { name: "Coordena√ß√£o Geral", type: "coord_geral", program: null },
            coord_projeto_area1: { name: "Coordenador de Projeto - √Årea 1", type: "coord_projeto", program: null },
            coord_projeto_area2: { name: "Coordenador de Projeto - √Årea 2", type: "coord_projeto", program: null },
            ifb_mais_empreendedor: { name: "IFB Mais Empreendedor", type: "coord_programa", program: "ifb_mais_empreendedor
